<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Klik Game</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #0a0a0a;
  color: #ffffff;
  font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  font-weight: 300;
}

/* ===== TYPOGRAPHY ===== */
h1, h2, h3, h4 {
  font-weight: 400;
  letter-spacing: 0.5px;
}

/* ===== APP LAYOUT ===== */
#app {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 25px;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
  position: relative;
  padding: 20px;
}

#count {
  font-size: 42px;
  font-weight: 300;
  letter-spacing: 2px;
  color: #ffffff;
  text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
  position: relative;
}

#count::after {
  content: 'KLIK';
  position: absolute;
  bottom: -15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  letter-spacing: 3px;
  opacity: 0.7;
}

/* ===== CIRCLE CLICK AREA ===== */
.circle-container {
  position: relative;
  width: min(280px, 70vw);
  height: min(280px, 70vw);
  display: flex;
  align-items: center;
  justify-content: center;
}

#photo {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid #333;
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  z-index: 2;
}

#photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: grayscale(20%) contrast(110%);
  transition: filter 0.3s;
}

#photo:hover img {
  filter: grayscale(0%) contrast(120%);
}

#photo:active {
  transform: scale(0.97);
  border-color: #666;
}

/* PULSE EFFECT */
.pulse-effect {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: rgba(100, 149, 237, 0.4);
  opacity: 0;
  pointer-events: none;
  z-index: 1;
}

.pulse-effect.active {
  animation: pulseClick 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes pulseClick {
  0% {
    transform: scale(0.8);
    opacity: 0.8;
  }
  50% {
    opacity: 0.4;
  }
  100% {
    transform: scale(1.5);
    opacity: 0;
  }
}

/* RING EFFECT */
.ring-container {
  position: absolute;
  width: calc(min(280px, 70vw) + 40px);
  height: calc(min(280px, 70vw) + 40px);
  pointer-events: none;
}

.ring {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 1px solid rgba(255, 255, 255, 0.1);
  animation: rotate 20s linear infinite;
}

.ring:nth-child(2) {
  width: 90%;
  height: 90%;
  top: 5%;
  left: 5%;
  animation-duration: 25s;
  animation-direction: reverse;
}

.ring:nth-child(3) {
  width: 80%;
  height: 80%;
  top: 10%;
  left: 10%;
  animation-duration: 30s;
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* ===== CONTROL BUTTONS ===== */
.control-buttons {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 100;
}

.control-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(30, 30, 30, 0.9);
  border: 1px solid #333;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
  backdrop-filter: blur(10px);
}

.control-btn:hover {
  background: rgba(40, 40, 40, 0.95);
  border-color: #555;
  transform: translateY(-2px);
}

.control-btn:active {
  transform: translateY(0);
}

.control-btn.active {
  background: rgba(255, 255, 255, 0.1);
  border-color: #fff;
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  min-width: 18px;
  height: 18px;
  background: #ffffff;
  color: #000;
  border-radius: 9px;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
  font-weight: 600;
  border: 1px solid #000;
}

/* ===== SIDEBAR PANEL ===== */
#panel {
  position: fixed;
  top: 0;
  right: 0;
  width: 100%;
  max-width: 400px;
  height: 100%;
  background: rgba(20, 20, 20, 0.98);
  transform: translateX(100%);
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  padding: 0;
  overflow-y: auto;
  z-index: 99;
  border-left: 1px solid #333;
  backdrop-filter: blur(20px);
}

#panel.show {
  transform: translateX(0);
}

.panel-header {
  padding: 25px 20px 15px;
  border-bottom: 1px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(15, 15, 15, 0.9);
}

.panel-header h2 {
  font-size: 20px;
  font-weight: 300;
}

.close-panel {
  background: none;
  border: none;
  color: #aaa;
  font-size: 20px;
  cursor: pointer;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.close-panel:hover {
  background: rgba(255, 255, 255, 0.05);
  color: #fff;
}

.panel-content {
  padding: 20px;
}

/* ===== LEADERBOARD IMPROVED ===== */
.leaderboard-section {
  margin-top: 20px;
}

.leaderboard-section h3 {
  font-size: 16px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 15px;
  opacity: 0.8;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Desktop Leaderboard */
.leaderboard-desktop {
  display: none;
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 15px;
}

.leaderboard-desktop thead {
  background: rgba(255, 255, 255, 0.03);
}

.leaderboard-desktop th {
  padding: 15px 10px;
  text-align: left;
  font-weight: 400;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 1px;
  opacity: 0.7;
  border-bottom: 1px solid #333;
}

.leaderboard-desktop tbody tr {
  background: rgba(255, 255, 255, 0.02);
  transition: all 0.2s;
  position: relative;
}

.leaderboard-desktop tbody tr:nth-child(even) {
  background: rgba(255, 255, 255, 0.01);
}

.leaderboard-desktop tbody tr:hover {
  background: rgba(255, 255, 255, 0.05);
}

.leaderboard-desktop td {
  padding: 18px 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  font-size: 14px;
  position: relative;
}

.leaderboard-desktop .rank-cell {
  width: 60px;
  text-align: center;
  font-weight: 300;
  font-size: 16px;
  opacity: 0.8;
  position: relative;
}

.leaderboard-desktop .rank-medal {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 20px;
}

.leaderboard-desktop .rank-1 .rank-medal { color: #FFD700; }
.leaderboard-desktop .rank-2 .rank-medal { color: #C0C0C0; }
.leaderboard-desktop .rank-3 .rank-medal { color: #CD7F32; }

.leaderboard-desktop .user-cell {
  cursor: pointer;
  position: relative;
  padding-left: 60px !important;
  padding-right: 40px !important;
}

.leaderboard-desktop .user-avatar {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  overflow: hidden;
  border: 1px solid #333;
  cursor: pointer;
}

.leaderboard-desktop .user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.leaderboard-desktop .username {
  font-weight: 400;
  letter-spacing: 0.5px;
  margin-bottom: 3px;
}

.leaderboard-desktop .user-status {
  font-size: 11px;
  opacity: 0.6;
  display: flex;
  align-items: center;
  gap: 4px;
}

.leaderboard-desktop .status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #333;
}

.leaderboard-desktop .status-dot.online {
  background: #4CAF50;
}

.leaderboard-desktop .click-cell {
  text-align: right;
  font-weight: 300;
  font-size: 16px;
  letter-spacing: 1px;
  width: 100px;
}

.leaderboard-desktop .action-cell {
  width: 80px;
  text-align: center;
}

.leaderboard-desktop .highlight-row {
  background: rgba(255, 255, 255, 0.07) !important;
  border-left: 3px solid #fff;
}

.leaderboard-desktop .chat-indicator {
  position: absolute;
  top: 50%;
  right: 15px;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  background: #fff;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

/* Mobile Leaderboard */
.leaderboard-mobile {
  display: none;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}

.leaderboard-card {
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid #333;
  border-radius: 8px;
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.2s;
  position: relative;
}

.leaderboard-card:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: #555;
}

.leaderboard-card.highlight {
  background: rgba(255, 255, 255, 0.07);
  border-left: 3px solid #fff;
}

.rank-badge {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 300;
  opacity: 0.8;
  flex-shrink: 0;
}

.rank-badge.rank-1 { color: #FFD700; }
.rank-badge.rank-2 { color: #C0C0C0; }
.rank-badge.rank-3 { color: #CD7F32; }

.user-avatar-mobile {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 1px solid #333;
  cursor: pointer;
}

.user-avatar-mobile img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.user-info-mobile {
  flex: 1;
  min-width: 0;
}

.username-mobile {
  font-weight: 400;
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-stats-mobile {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  opacity: 0.7;
}

.click-count-mobile {
  font-weight: 300;
  font-size: 14px;
}

.status-mobile {
  display: flex;
  align-items: center;
  gap: 4px;
}

.status-dot-mobile {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #333;
}

.status-dot-mobile.online {
  background: #4CAF50;
}

.chat-indicator-mobile {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 8px;
  height: 8px;
  background: #fff;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.3; }
  100% { opacity: 1; }
}

/* Responsive Leaderboard */
@media (min-width: 768px) {
  .leaderboard-desktop {
    display: table;
  }
  .leaderboard-mobile {
    display: none;
  }
}

@media (max-width: 767px) {
  .leaderboard-desktop {
    display: none;
  }
  .leaderboard-mobile {
    display: flex;
  }
  #panel {
    width: 100%;
    max-width: 100%;
  }
}

/* ===== FORM ELEMENTS ===== */
.form-section {
  margin-bottom: 25px;
  padding-bottom: 25px;
  border-bottom: 1px solid #333;
}

.form-section h3 {
  font-size: 16px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 15px;
  opacity: 0.8;
}

.input-group {
  margin-bottom: 12px;
}

.input-group label {
  display: block;
  font-size: 13px;
  margin-bottom: 5px;
  opacity: 0.7;
  letter-spacing: 0.5px;
}

.input-group input, .input-group textarea, .input-group select {
  width: 100%;
  padding: 12px 15px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  font-size: 15px;
  transition: all 0.2s;
  font-family: inherit;
}

.input-group input:focus, .input-group textarea:focus, .input-group select:focus {
  outline: none;
  border-color: #555;
  background: rgba(255, 255, 255, 0.08);
}

.input-group textarea {
  min-height: 100px;
  resize: vertical;
}

.btn {
  width: 100%;
  padding: 12px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 400;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: #555;
}

.btn-primary {
  background: #fff;
  color: #000;
  border: 1px solid #fff;
}

.btn-primary:hover {
  background: rgba(255, 255, 255, 0.9);
}

.btn-danger {
  background: rgba(255, 255, 255, 0.05);
  border-color: #444;
}

.btn-danger:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: #555;
}

.btn-sm {
  padding: 8px 12px;
  font-size: 13px;
}

/* ===== PROFILE EDITOR ===== */
.profile-editor {
  position: relative;
}

.profile-avatar-edit {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto 20px;
  cursor: pointer;
  border-radius: 50%;
  overflow: hidden;
  border: 2px solid #333;
}

.profile-avatar-edit img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-avatar-edit .edit-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s;
  color: white;
  font-size: 24px;
}

.profile-avatar-edit:hover .edit-overlay {
  opacity: 1;
}

.profile-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin: 15px 0;
}

.profile-stat {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 12px;
  text-align: center;
}

.profile-stat .value {
  font-size: 18px;
  font-weight: 300;
  margin-bottom: 3px;
}

.profile-stat .label {
  font-size: 11px;
  opacity: 0.7;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ===== VERIFICATION CODE ===== */
.verification-box {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 15px;
  margin: 15px 0;
  text-align: center;
}

.verification-code {
  font-family: 'Courier New', monospace;
  font-size: 24px;
  letter-spacing: 4px;
  padding: 12px;
  margin: 10px 0;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  user-select: all;
}

.verification-code:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: #555;
}

.copy-hint {
  font-size: 12px;
  opacity: 0.6;
  margin-top: 8px;
}

/* ===== USER INFO ===== */
.user-info-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid #333;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  text-align: center;
}

.user-info-card h3 {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 15px;
  opacity: 0.7;
}

.user-info-card .username {
  font-size: 22px;
  font-weight: 300;
  margin: 10px 0;
  letter-spacing: 1px;
}

.user-info-card .click-count {
  font-size: 28px;
  font-weight: 200;
  opacity: 0.9;
}

/* ===== MODAL STYLES ===== */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.modal.show {
  display: flex;
}

.modal-content {
  background: rgba(20, 20, 20, 0.95);
  width: 95%;
  max-width: 500px;
  max-height: 85vh;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  border: 1px solid #333;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(15, 15, 15, 0.9);
}

.modal-header h3 {
  font-weight: 300;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  background: none;
  border: none;
  color: #aaa;
  font-size: 20px;
  cursor: pointer;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.05);
  color: #fff;
}

.modal-body {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
}

.modal-footer {
  padding: 20px;
  border-top: 1px solid #333;
  background: rgba(15, 15, 15, 0.9);
}

/* ===== INCOMING CALL NOTIFICATION ===== */
.incoming-call-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(20, 20, 20, 0.95);
  border: 1px solid #333;
  border-radius: 12px;
  padding: 20px;
  width: 320px;
  z-index: 10000;
  backdrop-filter: blur(20px);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform-origin: top right;
}

@keyframes slideIn {
  from {
    transform: translateX(100%) scale(0.9);
    opacity: 0;
  }
  to {
    transform: translateX(0) scale(1);
    opacity: 1;
  }
}

.incoming-call-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.incoming-call-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 2px solid #333;
}

.incoming-call-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.incoming-call-info h4 {
  font-weight: 400;
  margin-bottom: 5px;
}

.incoming-call-info p {
  font-size: 13px;
  opacity: 0.7;
}

.incoming-call-controls {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.incoming-call-btn {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #333;
  background: rgba(255, 255, 255, 0.05);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
  font-size: 14px;
}

.incoming-call-btn.accept {
  background: rgba(76, 175, 80, 0.2);
  border-color: rgba(76, 175, 80, 0.4);
}

.incoming-call-btn.accept:hover {
  background: rgba(76, 175, 80, 0.3);
}

.incoming-call-btn.reject {
  background: rgba(244, 67, 54, 0.2);
  border-color: rgba(244, 67, 54, 0.4);
}

.incoming-call-btn.reject:hover {
  background: rgba(244, 67, 54, 0.3);
}

/* ===== CHAT STYLES ===== */
.chat-container {
  display: flex;
  flex-direction: column;
  height: 60vh;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  background: rgba(255, 255, 255, 0.01);
  border-radius: 6px;
  margin-bottom: 15px;
}

.message {
  margin-bottom: 15px;
  padding: 12px 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.05);
  max-width: 85%;
  word-wrap: break-word;
  position: relative;
}

.message.sent {
  margin-left: auto;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.message-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 12px;
}

.sender-name {
  font-weight: 500;
  opacity: 0.9;
}

.message-time {
  opacity: 0.5;
  font-size: 11px;
}

.message-content {
  font-size: 14px;
  line-height: 1.5;
}

.message-content img {
  max-width: 100%;
  border-radius: 4px;
  margin-top: 8px;
}

.chat-input-area {
  display: flex;
  gap: 10px;
}

.chat-input-area input {
  flex: 1;
  padding: 12px 15px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  font-size: 15px;
}

.chat-input-area input:focus {
  outline: none;
  border-color: #555;
}

.chat-actions {
  display: flex;
  gap: 8px;
}

.chat-action-btn {
  width: 44px;
  height: 44px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.chat-action-btn:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: #555;
}

.call-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  justify-content: center;
}

.call-btn {
  flex: 1;
  padding: 12px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.call-btn:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: #555;
}

.call-btn.video {
  background: rgba(76, 175, 80, 0.1);
  border-color: rgba(76, 175, 80, 0.3);
}

.call-btn.audio {
  background: rgba(33, 150, 243, 0.1);
  border-color: rgba(33, 150, 243, 0.3);
}

/* ===== CALL MODAL ===== */
.call-modal .modal-content {
  max-width: 400px;
}

.call-info {
  text-align: center;
  padding: 30px 20px;
}

.call-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  margin: 0 auto 20px;
  overflow: hidden;
  border: 2px solid #333;
}

.call-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.call-status {
  font-size: 14px;
  opacity: 0.7;
  margin: 10px 0;
}

.call-timer {
  font-size: 32px;
  font-weight: 300;
  letter-spacing: 2px;
  margin: 20px 0;
}

.call-controls {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
}

.call-control-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s;
}

.call-control-btn:hover {
  background: rgba(255, 255, 255, 0.08);
}

.call-control-btn.end-call {
  background: rgba(244, 67, 54, 0.2);
  border-color: rgba(244, 67, 54, 0.4);
}

.call-control-btn.end-call:hover {
  background: rgba(244, 67, 54, 0.3);
}

.call-control-btn.active {
  background: rgba(255, 255, 255, 0.12);
  border-color: #fff;
}

#video-container {
  width: 100%;
  height: 300px;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  margin: 15px 0;
  position: relative;
}

#local-video, #remote-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#remote-video {
  background: #111;
}

.video-controls {
  position: absolute;
  bottom: 10px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
  z-index: 10;
}

.video-control-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid #333;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.video-control-btn:hover {
  background: rgba(0, 0, 0, 0.9);
}

.video-control-btn.active {
  background: rgba(255, 255, 255, 0.2);
}

/* ===== AUDIO CONTROLS ===== */
.audio-controls {
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 100;
}

.audio-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(30, 30, 30, 0.9);
  border: 1px solid #333;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
  backdrop-filter: blur(10px);
}

.audio-btn:hover {
  background: rgba(40, 40, 40, 0.95);
  border-color: #555;
  transform: translateY(-2px);
}

.audio-btn.playing {
  background: rgba(255, 255, 255, 0.1);
  border-color: #fff;
}

/* ===== LOADING & ERROR STATES ===== */
.loading {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255, 255, 255, 0.5);
  font-size: 14px;
}

.loading::after {
  content: '';
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-left: 10px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-message {
  background: rgba(244, 67, 54, 0.1);
  border: 1px solid rgba(244, 67, 54, 0.3);
  border-radius: 6px;
  padding: 15px;
  margin: 10px 0;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.9);
}

.success-message {
  background: rgba(76, 175, 80, 0.1);
  border: 1px solid rgba(76, 175, 80, 0.3);
  border-radius: 6px;
  padding: 15px;
  margin: 10px 0;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.9);
}

/* ===== GROUP STYLES ===== */
.group-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 300px;
  overflow-y: auto;
}

.group-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid #333;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.group-item:hover {
  background: rgba(255, 255, 255, 0.05);
}

.group-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
}

.group-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.group-info {
  flex: 1;
}

.group-name {
  font-weight: 400;
  margin-bottom: 3px;
}

.group-desc {
  font-size: 11px;
  opacity: 0.6;
}

.group-members {
  font-size: 11px;
  opacity: 0.5;
}

/* ===== NOTIFICATION STYLES ===== */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(20, 20, 20, 0.95);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 15px 20px;
  color: #fff;
  font-size: 14px;
  z-index: 10000;
  transform: translateX(150%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
  min-width: 300px;
  max-width: 400px;
}

.notification.show {
  transform: translateX(0);
}

.notification-content {
  display: flex;
  align-items: center;
  gap: 12px;
}

.notification i {
  font-size: 18px;
}

.notification.success i {
  color: #4CAF50;
}

.notification.error i {
  color: #f44336;
}

.notification.info i {
  color: #2196F3;
}

/* ===== CALL HISTORY STYLES ===== */
.call-history-section {
  margin-top: 20px;
}

.call-history-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 10px;
}

.call-history-table th {
  padding: 12px 10px;
  text-align: left;
  font-weight: 400;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
  opacity: 0.7;
  border-bottom: 1px solid #333;
  background: rgba(255, 255, 255, 0.03);
}

.call-history-table td {
  padding: 15px 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  font-size: 13px;
}

.call-history-table tr:hover {
  background: rgba(255, 255, 255, 0.02);
}

.call-type {
  display: flex;
  align-items: center;
  gap: 8px;
}

.call-type.video {
  color: #4CAF50;
}

.call-type.audio {
  color: #2196F3;
}

.call-status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
}

.call-status-badge.connected {
  background: rgba(76, 175, 80, 0.2);
  color: #4CAF50;
}

.call-status-badge.missed {
  background: rgba(244, 67, 54, 0.2);
  color: #f44336;
}

.call-status-badge.ended {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.call-duration {
  text-align: right;
  font-family: 'Courier New', monospace;
  font-size: 13px;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.02);
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* ===== MEDIA QUERIES ===== */
@media (max-width: 768px) {
  .circle-container {
    width: 240px;
    height: 240px;
  }
  
  .ring-container {
    width: 280px;
    height: 280px;
  }
  
  #count {
    font-size: 36px;
  }
  
  .control-buttons {
    top: 15px;
    right: 15px;
  }
  
  .control-btn {
    width: 44px;
    height: 44px;
    font-size: 16px;
  }
  
  .call-controls {
    gap: 15px;
  }
  
  .call-control-btn {
    width: 50px;
    height: 50px;
  }
  
  #video-container {
    height: 250px;
  }
  
  .incoming-call-notification {
    width: calc(100% - 40px);
    left: 20px;
    right: 20px;
    top: 20px;
  }
}

@media (orientation: portrait) and (max-width: 767px) {
  .leaderboard-card {
    padding: 12px;
  }
  
  .rank-badge {
    width: 36px;
    height: 36px;
    font-size: 14px;
  }
  
  .user-avatar-mobile {
    width: 36px;
    height: 36px;
  }
  
  .user-stats-mobile {
    font-size: 11px;
  }
  
  .click-count-mobile {
    font-size: 13px;
  }
}

@media (orientation: landscape) and (max-height: 600px) {
  #app {
    padding: 10px;
  }
  
  .circle-container {
    width: 180px;
    height: 180px;
  }
  
  .ring-container {
    width: 220px;
    height: 220px;
  }
  
  #count {
    font-size: 30px;
  }
}
</style>
</head>

<body>

<!-- Audio Background -->
<audio id="bg-music" loop>
  <source src="lagu.mp3" type="audio/mpeg">
</audio>

<!-- Control Buttons -->
<div class="control-buttons">
  <button class="control-btn" id="panel-toggle" onclick="togglePanel()">
    <i class="fas fa-bars"></i>
  </button>
  <button class="control-btn" id="global-chat-toggle" onclick="openGlobalChat()">
    <i class="fas fa-globe"></i>
    <div class="notification-badge" id="global-notification" style="display:none"></div>
  </button>
  <button class="control-btn" id="group-chat-toggle" onclick="openGroupChat()">
    <i class="fas fa-users"></i>
  </button>
</div>

<!-- Audio Controls -->
<div class="audio-controls">
  <button class="audio-btn" id="music-toggle" onclick="toggleMusic()">
    <i class="fas fa-music"></i>
  </button>
</div>

<!-- Main App -->
<div id="app">
  <div class="ring-container">
    <div class="ring"></div>
    <div class="ring"></div>
    <div class="ring"></div>
  </div>
  
  <div class="circle-container">
    <div id="photo">
      <img src="foto.webp" alt="Klik saya!" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"240\" height=\"240\"><rect width=\"100%\" height=\"100%\" fill=\"%23111\"/><text x=\"50%\" y=\"50%\" font-family=\"Arial\" font-size=\"24\" fill=\"white\" text-anchor=\"middle\" dy=\".3em\">KLIK</text></svg>'">
    </div>
    <div class="pulse-effect" id="pulse-effect"></div>
  </div>
  
  <div id="count">0</div>
</div>

<!-- Side Panel -->
<div id="panel">
  <div class="panel-header">
    <h2>GAME PANEL</h2>
    <button class="close-panel" onclick="closePanel()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="panel-content" id="panel-content">
    <!-- Content akan diisi oleh JavaScript -->
  </div>
</div>

<!-- Edit Profile Modal -->
<div id="profile-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-user-edit"></i> Edit Profil</h3>
      <button class="modal-close" onclick="closeProfileEditor()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="profile-editor">
        <div class="profile-avatar-edit" onclick="document.getElementById('profile-photo-input').click()">
          <img id="profile-avatar-preview" src="foto.webp" alt="Profil">
          <div class="edit-overlay">
            <i class="fas fa-camera"></i>
          </div>
        </div>
        <input type="file" id="profile-photo-input" accept="image/*" style="display:none" onchange="previewProfilePhoto(event)">
        
        <div class="input-group">
          <label>Username</label>
          <input type="text" id="profile-username" value="" readonly>
          <small style="opacity:0.6; font-size:12px; margin-top:5px;">Username tidak dapat diubah</small>
        </div>
        
        <div class="input-group">
          <label>Bio/Status</label>
          <textarea id="profile-bio" placeholder="Tulis bio atau status Anda..." maxlength="200"></textarea>
          <div style="text-align:right; font-size:12px; opacity:0.6; margin-top:5px;">
            <span id="bio-counter">0</span>/200
          </div>
        </div>
        
        <div class="profile-stats">
          <div class="profile-stat">
            <div class="value" id="profile-total-clicks">0</div>
            <div class="label">Total Klik</div>
          </div>
          <div class="profile-stat">
            <div class="value" id="profile-rank">#0</div>
            <div class="label">Peringkat</div>
          </div>
        </div>
        
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #333;">
          <div class="input-group">
            <label>Ubah Password (Opsional)</label>
            <input type="password" id="profile-new-password" placeholder="Password baru">
          </div>
          <div class="input-group">
            <label>Konfirmasi Password</label>
            <input type="password" id="profile-confirm-password" placeholder="Ulangi password baru">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="saveProfile()">
        <i class="fas fa-save"></i> Simpan Perubahan
      </button>
    </div>
  </div>
</div>

<!-- Chat Modal -->
<div id="chat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-comment"></i> <span id="chat-title">Chat</span></h3>
      <button class="modal-close" onclick="closeChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="call-buttons">
          <button class="call-btn audio" onclick="startAudioCall()">
            <i class="fas fa-phone"></i> Audio Call
          </button>
          <button class="call-btn video" onclick="startVideoCall()">
            <i class="fas fa-video"></i> Video Call
          </button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Ketik pesan..." onkeypress="handleChatKeyPress(event)">
        <div class="chat-actions">
          <button class="chat-action-btn" onclick="attachFile('chat')">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="chat-action-btn" onclick="sendChatMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Call Modal -->
<div id="call-modal" class="modal call-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-phone"></i> Panggilan</h3>
      <button class="modal-close" onclick="endCall()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="video-container" style="display:none;">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted style="position:absolute; top:10px; right:10px; width:120px; height:160px; border-radius:8px; border:1px solid #333;"></video>
        <div class="video-controls">
          <button class="video-control-btn" onclick="toggleVideo()" id="toggle-video-btn">
            <i class="fas fa-video"></i>
          </button>
          <button class="video-control-btn" onclick="toggleAudio()" id="toggle-audio-btn">
            <i class="fas fa-microphone"></i>
          </button>
          <button class="video-control-btn end-call" onclick="endCall()">
            <i class="fas fa-phone-slash"></i>
          </button>
        </div>
      </div>
      <div class="call-info" id="call-info">
        <div class="call-avatar" id="call-avatar"></div>
        <h3 id="call-name">...</h3>
        <div class="call-status" id="call-status">Menghubungkan...</div>
        <div class="call-timer" id="call-timer">00:00</div>
        <div class="call-controls">
          <button class="call-control-btn" onclick="toggleMute()" id="mute-btn">
            <i class="fas fa-microphone"></i>
          </button>
          <button class="call-control-btn" onclick="toggleSpeaker()" id="speaker-btn">
            <i class="fas fa-volume-up"></i>
          </button>
          <button class="call-control-btn end-call" onclick="endCall()">
            <i class="fas fa-phone-slash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Incoming Call Notification -->
<div id="incoming-call-notification" style="display:none;"></div>

<!-- Group Chat Modal -->
<div id="group-chat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-users"></i> Grup Chat</h3>
      <button class="modal-close" onclick="closeGroupChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="group-list" id="group-list">
        <!-- Group list akan diisi oleh JavaScript -->
      </div>
      <button class="btn" onclick="showCreateGroupModal()" style="margin-top: 15px;">
        <i class="fas fa-plus"></i> Buat Grup Baru
      </button>
    </div>
  </div>
</div>

<!-- Create Group Modal -->
<div id="create-group-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-plus-circle"></i> Buat Grup Baru</h3>
      <button class="modal-close" onclick="closeCreateGroupModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group">
        <label>Nama Grup</label>
        <input type="text" id="group-name" placeholder="Masukkan nama grup">
      </div>
      <div class="input-group">
        <label>Deskripsi Grup (Opsional)</label>
        <textarea id="group-desc" placeholder="Deskripsi grup" maxlength="200"></textarea>
      </div>
      <div class="input-group">
        <label>Foto Grup (Opsional)</label>
        <input type="file" id="group-photo-input" accept="image/*" onchange="previewGroupPhoto(event)">
        <div id="group-photo-preview" style="margin-top: 10px; display: none;">
          <img id="group-photo-img" src="" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover;">
        </div>
      </div>
      <div class="input-group">
        <label>Pilih Anggota (Minimal 1)</label>
        <select id="group-members" multiple style="height: 150px;">
          <!-- Options akan diisi oleh JavaScript -->
        </select>
        <small style="opacity:0.6; font-size:12px; margin-top:5px;">Tahan Ctrl/Cmd untuk memilih multiple</small>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="createGroup()">
        <i class="fas fa-check"></i> Buat Grup
      </button>
    </div>
  </div>
</div>

<!-- Group Chat Room Modal -->
<div id="group-room-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-users"></i> <span id="group-room-title">Grup</span></h3>
      <button class="modal-close" onclick="closeGroupRoom()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="chat-container">
        <div class="chat-messages" id="group-room-messages"></div>
      </div>
    </div>
    <div class="modal-footer">
      <div class="chat-input-area">
        <input type="text" id="group-room-input" placeholder="Ketik pesan grup..." onkeypress="handleGroupRoomKeyPress(event)">
        <div class="chat-actions">
          <button class="chat-action-btn" onclick="attachFile('group')">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="chat-action-btn" onclick="sendGroupRoomMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Global Chat Modal -->
<div id="global-chat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-globe"></i> Chat Global</h3>
      <button class="modal-close" onclick="closeGlobalChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="chat-messages" id="global-chat-messages"></div>
    </div>
    <div class="modal-footer">
      <div class="chat-input-area">
        <input type="text" id="global-chat-input" placeholder="Ketik pesan global..." onkeypress="handleGlobalChatKeyPress(event)">
        <div class="chat-actions">
          <button class="chat-action-btn" onclick="attachFile('global')">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="chat-action-btn" onclick="sendGlobalMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Call History Modal -->
<div id="call-history-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-history"></i> Riwayat Panggilan</h3>
      <button class="modal-close" onclick="closeCallHistory()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="call-history-content">
        <!-- Riwayat panggilan akan diisi oleh JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- File Input (hidden) -->
<input type="file" id="file-input" style="display:none;" accept="image/*" onchange="handleFileUpload(event)">

<script>
// ===== SUPABASE INITIALIZATION =====
const sb = supabase.createClient(
  'https://bxhrnnwfqlsoviysqcdw.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4aHJubndmcWxzb3ZpeXNxY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODkzNDIsImV4cCI6MjA4MTM2NTM0Mn0.O7fpv0TrDd-8ZE3Z9B5zWyAuWROPis5GRnKMxmqncX8'
);

// ===== TABLE NAMES =====
const TABLE_KLIKUSER = 'KLIKUSER';
const TABLE_KLIKCHAT = 'KLIKCHAT';
const TABLE_GLOBALCHAT = 'GLOBALCHAT';
const TABLE_CALLS = 'CALLS';
const TABLE_GROUPS = 'KLIKGROUP';
const TABLE_GROUP_MEMBERS = 'GROUPMEMBER';
const TABLE_GROUP_CHAT = 'GROUPCHAT';

// ===== GLOBAL VARIABLES =====
let currentUser = null;
let currentClick = 0;
let verificationCode = '';
let chatTarget = null;
let currentGroup = null;
let activeCall = null;
let callTimer = null;
let callStartTime = null;
let callType = null; // 'audio' or 'video'
let unreadChats = new Set();
let unreadGlobal = 0;
let unreadGroups = new Set();
let musicPlaying = false;
let userProfile = {};
let userRank = 0;
let globalChatSubscription = null;
let groupChatSubscription = null;
let callSubscription = null;

// WebRTC variables
let peerConnection = null;
let localStream = null;
let remoteStream = null;
let isMuted = false;
let isVideoOff = false;
let isSpeakerOn = true;
let answerInterval = null;

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  generateVerificationCode();
  loadPanelContent('auth');
  
  // Check saved user
  const savedUser = localStorage.getItem('klikUser');
  if(savedUser) {
    restoreSession(savedUser);
  }
  
  // Initialize audio
  initAudio();
  
  // Setup bio counter
  document.getElementById('profile-bio')?.addEventListener('input', function() {
    document.getElementById('bio-counter').textContent = this.value.length;
  });
  
  // Setup notification permission
  if('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
  
  // Setup group desc counter
  document.getElementById('group-desc')?.addEventListener('input', function() {
    const counter = this.nextElementSibling?.querySelector('.bio-counter');
    if(counter) {
      counter.textContent = this.value.length;
    }
  });
});

// ===== AUDIO FUNCTIONS =====
function initAudio() {
  const bgMusic = document.getElementById('bg-music');
  bgMusic.volume = 0.3;
  
  // Check music preference
  if(localStorage.getItem('musicEnabled') === 'true') {
    toggleMusic();
  }
}

function toggleMusic() {
  const bgMusic = document.getElementById('bg-music');
  const toggleBtn = document.getElementById('music-toggle');
  
  if(musicPlaying) {
    bgMusic.pause();
    toggleBtn.classList.remove('playing');
    toggleBtn.innerHTML = '<i class="fas fa-music"></i>';
    musicPlaying = false;
    localStorage.setItem('musicEnabled', 'false');
  } else {
    bgMusic.play().catch(e => console.log('Auto-play prevented:', e));
    toggleBtn.classList.add('playing');
    toggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
    musicPlaying = true;
    localStorage.setItem('musicEnabled', 'true');
  }
}

// ===== CLICK EFFECT =====
function createClickEffect() {
  const pulse = document.getElementById('pulse-effect');
  pulse.classList.remove('active');
  void pulse.offsetWidth; // Trigger reflow
  pulse.classList.add('active');
}

// Update photo click event
document.getElementById('photo').onclick = async function() {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }

  // Create visual effect
  createClickEffect();
  
  // Play click sound
  try {
    const audio = new Audio('suara.mp3');
    audio.playbackRate = 2.0;
    audio.volume = 0.3;
    audio.play();
  } catch(e) {}

  // Update count
  currentClick++;
  document.getElementById('count').textContent = currentClick;

  // Update database
  try {
    await sb.from(TABLE_KLIKUSER)
      .update({ jumlah_klik: currentClick })
      .eq('username', currentUser);
    
    // Update user profile
    userProfile.jumlah_klik = currentClick;
    
  } catch (error) {
    console.error('Error updating click count:', error);
  }
};

// ===== PANEL MANAGEMENT =====
function togglePanel() {
  const panel = document.getElementById('panel');
  panel.classList.toggle('show');
  
  if(panel.classList.contains('show')) {
    generateVerificationCode();
    loadBoard();
    updatePanelContent();
  }
}

function closePanel() {
  document.getElementById('panel').classList.remove('show');
}

function updatePanelContent() {
  if(currentUser) {
    loadPanelContent('loggedIn');
  } else {
    loadPanelContent('auth');
  }
}

function loadPanelContent(section) {
  const panelContent = document.getElementById('panel-content');
  
  switch(section) {
    case 'auth':
      panelContent.innerHTML = `
        <div class="form-section">
          <h3>Daftar Akun Baru</h3>
          <div class="input-group">
            <label>Username</label>
            <input type="text" id="reg_user" placeholder="Minimal 3 karakter">
          </div>
          <div class="input-group">
            <label>Password</label>
            <input type="password" id="reg_pass" placeholder="Minimal 6 karakter">
          </div>
          <div class="verification-box">
            <div class="verification-code" id="verif-code">${verificationCode}</div>
            <div class="copy-hint">Klik untuk menyalin kode</div>
          </div>
          <div class="input-group">
            <label>Kode Verifikasi</label>
            <input type="text" id="reg_verif" placeholder="Tempel kode di sini">
          </div>
          <button class="btn btn-primary" onclick="register()">
            <i class="fas fa-user-plus"></i> Daftar
          </button>
        </div>

        <div class="form-section">
          <h3>Login</h3>
          <div class="input-group">
            <label>Username</label>
            <input type="text" id="log_user" placeholder="Masukkan username">
          </div>
          <div class="input-group">
            <label>Password</label>
            <input type="password" id="log_pass" placeholder="Masukkan password">
          </div>
          <button class="btn" onclick="login()">
            <i class="fas fa-sign-in-alt"></i> Login
          </button>
        </div>

        <div class="leaderboard-section">
          <h3><i class="fas fa-trophy"></i> Leaderboard</h3>
          <button class="btn" onclick="loadBoard()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <div id="board-container"></div>
        </div>
      `;
      
      // Add copy functionality
      document.getElementById('verif-code').onclick = function() {
        navigator.clipboard.writeText(verificationCode).then(() => {
          const hint = this.nextElementSibling;
          hint.textContent = 'âœ“ Kode disalin!';
          setTimeout(() => {
            hint.textContent = 'Klik untuk menyalin kode';
          }, 2000);
        });
      };
      break;
      
    case 'loggedIn':
      panelContent.innerHTML = `
        <div class="user-info-card">
          <div class="profile-avatar-edit" onclick="openProfileEditor()" style="width:80px;height:80px;margin:0 auto 15px;">
            <img src="${userProfile.profile_image || 'foto.webp'}" alt="${currentUser}" onerror="this.src='foto.webp'">
            <div class="edit-overlay">
              <i class="fas fa-edit"></i>
            </div>
          </div>
          <h3>Logged in as</h3>
          <div class="username">${currentUser}</div>
          ${userProfile.bio ? `<p style="opacity:0.7;font-size:13px;margin:10px 0;">${userProfile.bio}</p>` : ''}
          <div class="click-count">${currentClick} Klik</div>
          <div style="margin-top:15px;">
            <button class="btn btn-sm" onclick="openProfileEditor()">
              <i class="fas fa-edit"></i> Edit Profil
            </button>
            <button class="btn btn-sm" onclick="openCallHistory()">
              <i class="fas fa-history"></i> Riwayat Panggilan
            </button>
          </div>
        </div>

        <div class="form-section">
          <button class="btn" onclick="openGlobalChat()">
            <i class="fas fa-globe"></i> Chat Global
          </button>
          <button class="btn" onclick="openGroupChat()">
            <i class="fas fa-users"></i> Grup Chat
          </button>
          <button class="btn btn-danger" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>

        <div class="leaderboard-section">
          <h3><i class="fas fa-trophy"></i> Leaderboard</h3>
          <button class="btn" onclick="loadBoard()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <div id="board-container"></div>
        </div>
      `;
      break;
  }
}

// ===== AUTHENTICATION =====
function generateVerificationCode() {
  verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
}

async function register() {
  const username = document.getElementById('reg_user').value.trim();
  const password = document.getElementById('reg_pass').value.trim();
  const verifCode = document.getElementById('reg_verif').value.trim();
  
  // Validation
  if(!username || !password || !verifCode) {
    showNotification('Harap isi semua kolom', 'error');
    return;
  }
  
  if(verifCode !== verificationCode) {
    showNotification('Kode verifikasi salah', 'error');
    generateVerificationCode();
    document.getElementById('verif-code').textContent = verificationCode;
    return;
  }
  
  if(username.length < 3) {
    showNotification('Username minimal 3 karakter', 'error');
    return;
  }
  
  if(password.length < 6) {
    showNotification('Password minimal 6 karakter', 'error');
    return;
  }

  try {
    // Check if username exists
    const {data: existing} = await sb.from(TABLE_KLIKUSER)
      .select('username')
      .eq('username', username)
      .single();
    
    if(existing) {
      showNotification('Username sudah digunakan', 'error');
      return;
    }
    
    // Create user
    const {error} = await sb.from(TABLE_KLIKUSER)
      .insert({
        username: username,
        password: password,
        jumlah_klik: 0,
        background_data: null,
        profile_image: null,
        bio: '',
        last_seen: new Date().toISOString()
      });

    if(error) throw error;

    showNotification('Akun berhasil dibuat', 'success');
    currentUser = username;
    currentClick = 0;
    await loadUserProfile();
    afterLogin();
  } catch (error) {
    console.error('Registration error:', error);
    showNotification('Error: ' + error.message, 'error');
  }
}

async function login() {
  const username = document.getElementById('log_user').value.trim();
  const password = document.getElementById('log_pass').value.trim();

  try {
    const {data, error} = await sb.from(TABLE_KLIKUSER)
      .select('*')
      .eq('username', username)
      .eq('password', password)
      .single();

    if(error || !data) {
      showNotification('Login gagal. Cek username/password', 'error');
      return;
    }

    currentUser = username;
    currentClick = data.jumlah_klik || 0;
    userProfile = data;
    afterLogin();
  } catch (error) {
    console.error('Login error:', error);
    showNotification('Error saat login', 'error');
  }
}

async function restoreSession(username) {
  try {
    const {data} = await sb.from(TABLE_KLIKUSER)
      .select('*')
      .eq('username', username)
      .single();
    
    if(data) {
      currentUser = username;
      currentClick = data.jumlah_klik || 0;
      userProfile = data;
      afterLogin();
    }
  } catch (error) {
    localStorage.removeItem('klikUser');
  }
}

async function loadUserProfile() {
  if(!currentUser) return;
  
  try {
    const {data} = await sb.from(TABLE_KLIKUSER)
      .select('*')
      .eq('username', currentUser)
      .single();
    
    if(data) {
      userProfile = data;
    }
  } catch (error) {
    console.error('Error loading profile:', error);
  }
}

function afterLogin() {
  document.getElementById('count').textContent = currentClick;
  loadPanelContent('loggedIn');
  loadBoard();
  startRealtime();
  updateOnlineStatus();
  
  // Save to localStorage
  localStorage.setItem('klikUser', currentUser);
  
  showNotification(`Selamat datang, ${currentUser}!`, 'success');
}

function logout() {
  currentUser = null;
  currentClick = 0;
  userProfile = {};
  document.getElementById('count').textContent = 0;
  localStorage.removeItem('klikUser');
  loadPanelContent('auth');
  
  // Stop realtime subscriptions
  if(globalChatSubscription) {
    sb.removeChannel(globalChatSubscription);
  }
  if(groupChatSubscription) {
    sb.removeChannel(groupChatSubscription);
  }
  if(callSubscription) {
    sb.removeChannel(callSubscription);
  }
  
  showNotification('Anda telah logout', 'info');
}

// ===== PROFILE EDITOR =====
function openProfileEditor() {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }
  
  const modal = document.getElementById('profile-modal');
  const preview = document.getElementById('profile-avatar-preview');
  const username = document.getElementById('profile-username');
  const bio = document.getElementById('profile-bio');
  const totalClicks = document.getElementById('profile-total-clicks');
  const rank = document.getElementById('profile-rank');
  
  // Load current profile data
  preview.src = userProfile.profile_image || 'foto.webp';
  username.value = currentUser;
  bio.value = userProfile.bio || '';
  document.getElementById('bio-counter').textContent = bio.value.length;
  totalClicks.textContent = userProfile.jumlah_klik || 0;
  rank.textContent = userRank ? `#${userRank}` : '#-';
  
  modal.classList.add('show');
}

function closeProfileEditor() {
  document.getElementById('profile-modal').classList.remove('show');
  document.getElementById('profile-new-password').value = '';
  document.getElementById('profile-confirm-password').value = '';
}

function previewProfilePhoto(event) {
  const file = event.target.files[0];
  if(!file) return;
  
  if(!file.type.startsWith('image/')) {
    showNotification('Hanya file gambar yang diizinkan', 'error');
    return;
  }
  
  if(file.size > 5 * 1024 * 1024) {
    showNotification('Ukuran file maksimal 5MB', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('profile-avatar-preview').src = e.target.result;
  };
  reader.readAsDataURL(file);
}

async function saveProfile() {
  if(!currentUser) return;
  
  const bio = document.getElementById('profile-bio').value.trim();
  const newPassword = document.getElementById('profile-new-password').value;
  const confirmPassword = document.getElementById('profile-confirm-password').value;
  const photoFile = document.getElementById('profile-photo-input').files[0];
  
  // Password validation
  if(newPassword && newPassword !== confirmPassword) {
    showNotification('Password tidak cocok', 'error');
    return;
  }
  
  if(newPassword && newPassword.length < 6) {
    showNotification('Password minimal 6 karakter', 'error');
    return;
  }
  
  try {
    let profileImageUrl = userProfile.profile_image;
    
    // Upload new profile photo if exists
    if(photoFile) {
      const fileName = `profile_${currentUser}_${Date.now()}.${photoFile.name.split('.').pop()}`;
      
      const {data, error: uploadError} = await sb.storage
        .from('profile-photos')
        .upload(fileName, photoFile, {
          cacheControl: '3600',
          upsert: true
        });
      
      if(!uploadError) {
        const {data: urlData} = sb.storage
          .from('profile-photos')
          .getPublicUrl(fileName);
        profileImageUrl = urlData.publicUrl;
      } else {
        console.error('Upload error:', uploadError);
        // Fallback to data URL if upload fails
        const reader = new FileReader();
        reader.onload = function(e) {
          profileImageUrl = e.target.result;
        };
        reader.readAsDataURL(photoFile);
      }
    }
    
    // Update profile data
    const updateData = {
      bio: bio,
      profile_image: profileImageUrl,
      last_seen: new Date().toISOString()
    };
    
    // Add password if changed
    if(newPassword) {
      updateData.password = newPassword;
    }
    
    const {error} = await sb.from(TABLE_KLIKUSER)
      .update(updateData)
      .eq('username', currentUser);
    
    if(error) throw error;
    
    // Update local profile
    userProfile.bio = bio;
    userProfile.profile_image = profileImageUrl;
    
    showNotification('Profil berhasil diperbarui', 'success');
    closeProfileEditor();
    loadPanelContent('loggedIn');
    loadBoard();
    
  } catch (error) {
    console.error('Error saving profile:', error);
    showNotification('Gagal menyimpan profil: ' + error.message, 'error');
  }
}

// ===== IMPROVED LEADERBOARD =====
async function loadBoard() {
  const container = document.getElementById('board-container');
  if (!container) return;
  
  container.innerHTML = '<div class="loading">Memuat leaderboard...</div>';
  
  try {
    const {data, error} = await sb.from(TABLE_KLIKUSER)
      .select('*')
      .order('jumlah_klik', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data || data.length === 0) {
      container.innerHTML = '<p style="text-align:center;padding:40px;opacity:0.5;">Belum ada data</p>';
      return;
    }
    
    // Find current user's rank
    userRank = data.findIndex(user => user.username === currentUser) + 1;
    if(userRank === 0) userRank = '-';
    
    // Desktop version
    let desktopHTML = `
      <table class="leaderboard-desktop">
        <thead>
          <tr>
            <th class="rank-cell">RANK</th>
            <th>USERNAME</th>
            <th class="click-cell">KLIK</th>
            <th class="action-cell">AKSI</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    // Mobile version
    let mobileHTML = '<div class="leaderboard-mobile">';
    
    data.forEach((user, index) => {
      const rank = index + 1;
      const isMe = user.username === currentUser;
      const hasUnread = unreadChats.has(user.username);
      const isOnline = user.last_seen && (Date.now() - new Date(user.last_seen).getTime()) < 30000;
      const profileImage = user.profile_image || 'foto.webp';
      const userBio = user.bio ? `<div style="font-size:11px;opacity:0.6;margin-top:2px;">${user.bio.substring(0, 30)}${user.bio.length > 30 ? '...' : ''}</div>` : '';
      
      // Desktop row
      desktopHTML += `
        <tr class="${isMe ? 'highlight-row' : ''} ${rank <= 3 ? `rank-${rank}` : ''}">
          <td class="rank-cell">
            <div class="rank-medal">${rank <= 3 ? 'ðŸ†' : rank}</div>
          </td>
          <td class="user-cell" onclick="${user.username !== currentUser ? `openChat('${user.username.replace(/'/g, "\\'")}')` : ''}">
            <div class="user-avatar" onclick="${!isMe ? `openUserProfile('${user.username.replace(/'/g, "\\'")}')` : 'openProfileEditor()'}">
              <img src="${profileImage}" alt="${user.username}" onerror="this.src='foto.webp'">
            </div>
            <div>
              <div class="username">${user.username} ${isMe ? '(Anda)' : ''}</div>
              ${userBio}
              <div class="user-status">
                <span class="status-dot ${isOnline ? 'online' : ''}"></span>
                <span>${isOnline ? 'Online' : 'Offline'}</span>
              </div>
            </div>
            ${hasUnread ? '<div class="chat-indicator"></div>' : ''}
          </td>
          <td class="click-cell">${user.jumlah_klik || 0}</td>
          <td class="action-cell">
            ${isMe ? `
              <button class="chat-action-btn" onclick="openProfileEditor()" style="border:none;background:transparent;color:#666;">
                <i class="fas fa-edit"></i>
              </button>
            ` : `
              <button class="chat-action-btn" onclick="openChat('${user.username.replace(/'/g, "\\'")}')" style="border:none;background:transparent;color:#666;">
                <i class="fas fa-comment"></i>
              </button>
            `}
          </td>
        </tr>
      `;
      
      // Mobile card
      mobileHTML += `
        <div class="leaderboard-card ${isMe ? 'highlight' : ''}" onclick="${user.username !== currentUser ? `openChat('${user.username.replace(/'/g, "\\'")}')` : 'openProfileEditor()'}">
          <div class="rank-badge ${rank <= 3 ? `rank-${rank}` : ''}">
            ${rank <= 3 ? 'ðŸ†' : rank}
          </div>
          <div class="user-avatar-mobile" onclick="${!isMe ? `openUserProfile('${user.username.replace(/'/g, "\\'")}')` : 'openProfileEditor()'}">
            <img src="${profileImage}" alt="${user.username}" onerror="this.src='foto.webp'">
          </div>
          <div class="user-info-mobile">
            <div class="username-mobile">${user.username} ${isMe ? '(Anda)' : ''}</div>
            ${userBio ? `<div style="font-size:11px;opacity:0.6;">${user.bio.substring(0, 25)}${user.bio.length > 25 ? '...' : ''}</div>` : ''}
            <div class="user-stats-mobile">
              <span class="click-count-mobile">${user.jumlah_klik || 0} klik</span>
              <span class="status-mobile">
                <span class="status-dot-mobile ${isOnline ? 'online' : ''}"></span>
                <span>${isOnline ? 'Online' : 'Offline'}</span>
              </span>
            </div>
          </div>
          ${hasUnread ? '<div class="chat-indicator-mobile"></div>' : ''}
        </div>
      `;
    });
    
    desktopHTML += '</tbody></table>';
    mobileHTML += '</div>';
    
    container.innerHTML = desktopHTML + mobileHTML;
    
  } catch (error) {
    console.error('Error loading leaderboard:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat leaderboard</div>';
  }
}

function openUserProfile(username) {
  // Show user profile modal (simplified version)
  showNotification(`Profil ${username}`, 'info');
}

// ===== CHAT FUNCTIONS =====
async function openChat(username) {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }
  
  if(username === currentUser) {
    openProfileEditor();
    return;
  }
  
  chatTarget = username;
  document.getElementById('chat-title').textContent = username;
  document.getElementById('chat-modal').classList.add('show');
  document.getElementById('chat-input').focus();
  
  // Remove unread notification
  unreadChats.delete(username);
  loadBoard();
  
  await loadChatMessages();
}

function closeChat() {
  document.getElementById('chat-modal').classList.remove('show');
  chatTarget = null;
  document.getElementById('chat-input').value = '';
}

async function loadChatMessages() {
  const container = document.getElementById('chat-messages');
  container.innerHTML = '<div class="loading">Memuat pesan...</div>';
  
  try {
    const {data, error} = await sb.from(TABLE_KLIKCHAT)
      .select('*')
      .or(`and(sender.eq.${currentUser},receiver.eq.${chatTarget}),and(sender.eq.${chatTarget},receiver.eq.${currentUser})`)
      .order('created_at', { ascending:true })
      .limit(50);

    if(error) throw error;

    container.innerHTML = '';
    
    if(data && data.length > 0) {
      data.forEach(msg => {
        const time = new Date(msg.created_at).toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const isSent = msg.sender === currentUser;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : ''}`;
        messageDiv.innerHTML = `
          <div class="message-header">
            <span class="sender-name">${msg.sender}</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-content">
            ${msg.message.startsWith('data:image') ? 
              `<img src="${msg.message}" alt="Gambar" style="max-width:200px;">` : 
              msg.message}
          </div>
        `;
        
        container.appendChild(messageDiv);
      });
      
      container.scrollTop = container.scrollHeight;
    } else {
      container.innerHTML = '<p style="text-align:center;opacity:0.5;padding:40px;">Belum ada pesan</p>';
    }
  } catch (error) {
    console.error('Error loading messages:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat pesan</div>';
  }
}

async function sendChatMessage() {
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  
  if(!message || !chatTarget || !currentUser) return;
  
  try {
    const {error} = await sb.from(TABLE_KLIKCHAT)
      .insert({
        sender: currentUser,
        receiver: chatTarget,
        message: message
      });

    if(error) throw error;

    input.value = '';
    await loadChatMessages();
  } catch (error) {
    console.error('Error sending message:', error);
    showNotification('Gagal mengirim pesan', 'error');
  }
}

function handleChatKeyPress(e) {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChatMessage();
  }
}

// ===== IMPROVED CALL SYSTEM =====
async function startAudioCall() {
  if(!chatTarget || !currentUser) {
    showNotification('Pilih kontak terlebih dahulu', 'error');
    return;
  }
  
  callType = 'audio';
  await initiateCall('audio');
}

async function startVideoCall() {
  if(!chatTarget || !currentUser) {
    showNotification('Pilih kontak terlebih dahulu', 'error');
    return;
  }
  
  callType = 'video';
  await initiateCall('video');
}

async function initiateCall(type) {
  try {
    // Request media permissions first
    try {
      const constraints = {
        audio: true,
        video: type === 'video'
      };
      
      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      
      if(type === 'video') {
        const localVideo = document.getElementById('local-video');
        localVideo.srcObject = localStream;
      }
    } catch (mediaError) {
      console.error('Media error:', mediaError);
      showNotification('Akses kamera/mikrofon ditolak', 'error');
      return;
    }
    
    // Create call record
    const callData = {
      caller: currentUser,
      receiver: chatTarget,
      type: type,
      status: 'calling',
      started_at: new Date().toISOString()
    };
    
    // Save to database
    const {data: savedCall, error} = await sb.from(TABLE_CALLS)
      .insert(callData)
      .select()
      .single();

    if(error) throw error;

    activeCall = savedCall;
    showCallModal('outgoing');
    
    // Setup WebRTC
    await setupPeerConnection();
    
    // Start call timer
    callStartTime = Date.now();
    updateCallTimer();
    callTimer = setInterval(updateCallTimer, 1000);
    
    // Create and send offer
    const offer = await peerConnection.createOffer({
      offerToReceiveAudio: true,
      offerToReceiveVideo: type === 'video'
    });
    
    await peerConnection.setLocalDescription(offer);
    
    // Save offer to database for signaling
    await sb.from(TABLE_CALLS)
      .update({ 
        offer: JSON.stringify(peerConnection.localDescription),
        status: 'waiting'
      })
      .eq('id', activeCall.id);
    
    // Listen for answer
    listenForAnswer();
    
  } catch (error) {
    console.error('Error starting call:', error);
    showNotification('Gagal memulai panggilan: ' + error.message, 'error');
    endCall();
  }
}

async function setupPeerConnection() {
  try {
    const configuration = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' }
      ]
    };
    
    peerConnection = new RTCPeerConnection(configuration);
    
    // Add local stream tracks
    if(localStream) {
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });
    }
    
    // Handle remote stream
    peerConnection.ontrack = (event) => {
      remoteStream = event.streams[0];
      const remoteVideo = document.getElementById('remote-video');
      remoteVideo.srcObject = remoteStream;
      document.getElementById('call-status').textContent = 'Terhubung';
    };
    
    // ICE candidate handling
    peerConnection.onicecandidate = (event) => {
      if(event.candidate) {
        console.log('New ICE candidate:', event.candidate);
      }
    };
    
    // Connection state changes
    peerConnection.onconnectionstatechange = () => {
      console.log('Connection state:', peerConnection.connectionState);
      if(peerConnection.connectionState === 'connected') {
        document.getElementById('call-status').textContent = 'Terhubung';
        if(callType === 'video') {
          document.getElementById('video-container').style.display = 'block';
          document.getElementById('call-info').style.display = 'none';
        }
      }
    };
    
  } catch (error) {
    console.error('Error setting up peer connection:', error);
    throw error;
  }
}

async function listenForAnswer() {
  if(!activeCall) return;
  
  answerInterval = setInterval(async () => {
    try {
      const {data: callData} = await sb.from(TABLE_CALLS)
        .select('*')
        .eq('id', activeCall.id)
        .single();
      
      if(callData && callData.answer) {
        clearInterval(answerInterval);
        
        // Set remote description from answer
        const answer = JSON.parse(callData.answer);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        
        // Update call status
        await sb.from(TABLE_CALLS)
          .update({ status: 'connected' })
          .eq('id', activeCall.id);
          
      } else if(callData && (callData.status === 'ended' || callData.status === 'rejected')) {
        clearInterval(answerInterval);
        showNotification('Panggilan ditolak', 'info');
        endCall();
      }
    } catch (error) {
      console.error('Error checking answer:', error);
    }
  }, 2000);
  
  // Timeout after 60 seconds
  setTimeout(() => {
    if(answerInterval) {
      clearInterval(answerInterval);
      if(document.getElementById('call-modal').classList.contains('show')) {
        showNotification('Panggilan tidak dijawab', 'info');
        endCall();
      }
    }
  }, 60000);
}

function showCallModal(type) {
  const modal = document.getElementById('call-modal');
  const name = document.getElementById('call-name');
  const status = document.getElementById('call-status');
  const avatar = document.getElementById('call-avatar');
  
  if(type === 'outgoing') {
    name.textContent = chatTarget;
    status.textContent = 'Menghubungkan...';
  } else {
    name.textContent = activeCall.caller;
    status.textContent = 'Panggilan masuk...';
  }
  
  // Set avatar
  const contactName = type === 'outgoing' ? chatTarget : activeCall.caller;
  avatar.innerHTML = `<img src="foto.webp" alt="${contactName}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"><rect width=\"100%\" height=\"100%\" fill=\"%23111\"/><text x=\"50%\" y=\"50%\" font-family=\"Arial\" font-size=\"20\" fill=\"white\" text-anchor=\"middle\" dy=\".3em\">${contactName.charAt(0)}</text></svg>'">`;
  
  modal.classList.add('show');
}

function updateCallTimer() {
  if(!callStartTime) return;
  
  const elapsed = Date.now() - callStartTime;
  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);
  
  document.getElementById('call-timer').textContent = 
    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function toggleMute() {
  if(!localStream) return;
  
  const audioTracks = localStream.getAudioTracks();
  if(audioTracks.length > 0) {
    isMuted = !isMuted;
    audioTracks[0].enabled = !isMuted;
    
    const muteBtn = document.getElementById('mute-btn');
    muteBtn.classList.toggle('active', isMuted);
    muteBtn.innerHTML = isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
  }
}

function toggleVideo() {
  if(!localStream || callType !== 'video') return;
  
  const videoTracks = localStream.getVideoTracks();
  if(videoTracks.length > 0) {
    isVideoOff = !isVideoOff;
    videoTracks[0].enabled = !isVideoOff;
    
    const videoBtn = document.getElementById('toggle-video-btn');
    videoBtn.classList.toggle('active', isVideoOff);
    videoBtn.innerHTML = isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
  }
}

function toggleSpeaker() {
  if(!remoteStream) return;
  
  const audioElements = document.getElementsByTagName('audio');
  for(let audio of audioElements) {
    audio.muted = !audio.muted;
  }
  
  const remoteVideo = document.getElementById('remote-video');
  remoteVideo.muted = !remoteVideo.muted;
  
  isSpeakerOn = !isSpeakerOn;
  const speakerBtn = document.getElementById('speaker-btn');
  speakerBtn.classList.toggle('active', !isSpeakerOn);
  speakerBtn.innerHTML = isSpeakerOn ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
}

function toggleAudio() {
  toggleMute();
}

async function endCall() {
  clearInterval(callTimer);
  if(answerInterval) {
    clearInterval(answerInterval);
  }
  
  if(activeCall) {
    try {
      const endedAt = new Date().toISOString();
      const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
      
      await sb.from(TABLE_CALLS)
        .update({ 
          status: 'ended', 
          ended_at: endedAt,
          duration: duration
        })
        .eq('id', activeCall.id);
      
      if(duration > 0) {
        showNotification(`Panggilan berakhir (${Math.floor(duration/60)}:${(duration%60).toString().padStart(2, '0')})`, 'info');
      }
      
    } catch (error) {
      console.error('Error updating call status:', error);
    }
  }
  
  // Close peer connection
  if(peerConnection) {
    peerConnection.close();
    peerConnection = null;
  }
  
  // Stop media streams
  if(localStream) {
    localStream.getTracks().forEach(track => track.stop());
    localStream = null;
  }
  
  if(remoteStream) {
    remoteStream.getTracks().forEach(track => track.stop());
    remoteStream = null;
  }
  
  // Hide modal
  document.getElementById('call-modal').classList.remove('show');
  document.getElementById('video-container').style.display = 'none';
  document.getElementById('call-info').style.display = 'block';
  
  // Reset variables
  activeCall = null;
  callStartTime = null;
  callType = null;
  isMuted = false;
  isVideoOff = false;
  isSpeakerOn = true;
  answerInterval = null;
}

// ===== INCOMING CALL HANDLING =====
function startRealtime() {
  if(!currentUser) return;
  
  // Update online status every 30 seconds
  setInterval(updateOnlineStatus, 30000);
  
  // Subscribe to incoming calls
  callSubscription = sb.channel('calls-realtime')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: TABLE_CALLS,
      filter: `receiver=eq.${currentUser}`
    }, async (payload) => {
      if(payload.new.status === 'calling') {
        showIncomingCallNotification(payload.new);
      }
    })
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: TABLE_CALLS,
      filter: `id=eq.${activeCall?.id}`
    }, async (payload) => {
      if(payload.new.answer && peerConnection && !peerConnection.remoteDescription) {
        try {
          // Handle incoming answer
          const answer = JSON.parse(payload.new.answer);
          await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
          document.getElementById('call-status').textContent = 'Terhubung';
        } catch (error) {
          console.error('Error processing answer:', error);
        }
      }
    })
    .subscribe();
  
  // Subscribe to private chats
  sb.channel('private-chat')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: TABLE_KLIKCHAT,
      filter: `receiver=eq.${currentUser}`
    }, (payload) => {
      const sender = payload.new.sender;
      if(chatTarget !== sender) {
        unreadChats.add(sender);
        loadBoard();
        
        // Show notification
        if(Notification.permission === 'granted') {
          new Notification(`Pesan baru dari ${sender}`, {
            body: payload.new.message.length > 100 ? 
              payload.new.message.substring(0, 100) + '...' : 
              payload.new.message,
            icon: 'foto.webp'
          });
        }
      }
    })
    .subscribe();
}

function showIncomingCallNotification(callData) {
  const notification = document.getElementById('incoming-call-notification');
  
  notification.innerHTML = `
    <div class="incoming-call-notification">
      <div class="incoming-call-header">
        <div class="incoming-call-avatar">
          <img src="foto.webp" alt="${callData.caller}" onerror="this.src='foto.webp'">
        </div>
        <div class="incoming-call-info">
          <h4>${callData.caller}</h4>
          <p>${callData.type === 'video' ? 'Video Call' : 'Audio Call'}</p>
        </div>
      </div>
      <div class="incoming-call-controls">
        <button class="incoming-call-btn accept" onclick="acceptIncomingCall('${callData.id}')">
          <i class="fas fa-phone"></i> Terima
        </button>
        <button class="incoming-call-btn reject" onclick="rejectIncomingCall('${callData.id}')">
          <i class="fas fa-phone-slash"></i> Tolak
        </button>
      </div>
    </div>
  `;
  
  notification.style.display = 'block';
  
  // Auto hide after 60 seconds
  setTimeout(() => {
    if(notification.style.display !== 'none') {
      notification.style.display = 'none';
      // Auto reject if not answered
      rejectIncomingCall(callData.id);
    }
  }, 60000);
}

async function acceptIncomingCall(callId) {
  try {
    // Hide notification
    document.getElementById('incoming-call-notification').style.display = 'none';
    
    // Get call data
    const {data: callData} = await sb.from(TABLE_CALLS)
      .select('*')
      .eq('id', callId)
      .single();
    
    if(!callData) return;
    
    activeCall = callData;
    chatTarget = callData.caller;
    callType = callData.type;
    
    // Show call modal
    showCallModal('incoming');
    
    // Request media permissions
    const constraints = {
      audio: true,
      video: callType === 'video'
    };
    
    try {
      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      
      // Setup WebRTC
      await setupPeerConnection();
      
      // Set remote description from offer
      if(callData.offer) {
        const offer = JSON.parse(callData.offer);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
      }
      
      // Create and send answer
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      
      // Save answer to database
      await sb.from(TABLE_CALLS)
        .update({ 
          answer: JSON.stringify(peerConnection.localDescription),
          status: 'connected'
        })
        .eq('id', callId);
      
      // Start call timer
      callStartTime = Date.now();
      updateCallTimer();
      callTimer = setInterval(updateCallTimer, 1000);
      
    } catch (mediaError) {
      console.error('Media error:', mediaError);
      showNotification('Akses kamera/mikrofon ditolak', 'error');
      endCall();
    }
    
  } catch (error) {
    console.error('Error accepting call:', error);
    showNotification('Gagal menerima panggilan: ' + error.message, 'error');
    endCall();
  }
}

async function rejectIncomingCall(callId) {
  try {
    // Hide notification
    document.getElementById('incoming-call-notification').style.display = 'none';
    
    // Update call status to rejected
    await sb.from(TABLE_CALLS)
      .update({ 
        status: 'rejected',
        ended_at: new Date().toISOString(),
        duration: 0
      })
      .eq('id', callId);
    
  } catch (error) {
    console.error('Error rejecting call:', error);
  }
}

async function updateOnlineStatus() {
  if(!currentUser) return;
  
  try {
    await sb.from(TABLE_KLIKUSER)
      .update({ last_seen: new Date().toISOString() })
      .eq('username', currentUser);
  } catch (error) {
    console.error('Error updating online status:', error);
  }
}

// ===== GROUP CHAT FUNCTIONS =====
function openGroupChat() {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }
  
  document.getElementById('group-chat-modal').classList.add('show');
  loadGroupList();
}

function closeGroupChat() {
  document.getElementById('group-chat-modal').classList.remove('show');
}

async function loadGroupList() {
  const container = document.getElementById('group-list');
  container.innerHTML = '<div class="loading">Memuat daftar grup...</div>';
  
  try {
    // Get groups where user is a member
    const {data: memberships, error: membersError} = await sb.from(TABLE_GROUP_MEMBERS)
      .select('group_id')
      .eq('username', currentUser);
    
    if(membersError) throw membersError;
    
    if(!memberships || memberships.length === 0) {
      container.innerHTML = '<p style="text-align:center;opacity:0.5;padding:40px;">Belum ada grup. Buat grup baru!</p>';
      return;
    }
    
    const groupIds = memberships.map(m => m.group_id);
    
    // Get group details
    const {data: groups, error: groupsError} = await sb.from(TABLE_GROUPS)
      .select('*')
      .in('id', groupIds)
      .order('created_at', { ascending: false });
    
    if(groupsError) throw groupsError;
    
    container.innerHTML = '';
    
    if(groups && groups.length > 0) {
      // Get member counts for each group
      for(let group of groups) {
        const {data: memberCount} = await sb.from(TABLE_GROUP_MEMBERS)
          .select('username', { count: 'exact' })
          .eq('group_id', group.id);
        
        group.memberCount = memberCount ? memberCount.length : 0;
        
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group-item';
        groupDiv.onclick = () => openGroupRoom(group.id);
        
        groupDiv.innerHTML = `
          <div class="group-avatar">
            <img src="${group.group_image || 'foto.webp'}" alt="${group.name}" onerror="this.src='foto.webp'">
          </div>
          <div class="group-info">
            <div class="group-name">${group.name}</div>
            ${group.description ? `<div class="group-desc">${group.description}</div>` : ''}
            <div class="group-members">${group.memberCount} anggota</div>
          </div>
        `;
        
        container.appendChild(groupDiv);
      }
    } else {
      container.innerHTML = '<p style="text-align:center;opacity:0.5;padding:40px;">Belum ada grup. Buat grup baru!</p>';
    }
  } catch (error) {
    console.error('Error loading group list:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat daftar grup</div>';
  }
}

function showCreateGroupModal() {
  closeGroupChat();
  document.getElementById('create-group-modal').classList.add('show');
  loadUsersForGroup();
}

function closeCreateGroupModal() {
  document.getElementById('create-group-modal').classList.remove('show');
  document.getElementById('group-name').value = '';
  document.getElementById('group-desc').value = '';
  document.getElementById('group-photo-input').value = '';
  document.getElementById('group-photo-preview').style.display = 'none';
}

async function loadUsersForGroup() {
  const select = document.getElementById('group-members');
  select.innerHTML = '<option value="" disabled>Memuat pengguna...</option>';
  
  try {
    const {data, error} = await sb.from(TABLE_KLIKUSER)
      .select('username')
      .neq('username', currentUser)
      .order('username', { ascending: true });

    if(error) throw error;

    select.innerHTML = '';
    
    if(data && data.length > 0) {
      data.forEach(user => {
        const option = document.createElement('option');
        option.value = user.username;
        option.textContent = user.username;
        select.appendChild(option);
      });
    } else {
      select.innerHTML = '<option value="" disabled>Tidak ada pengguna lain</option>';
    }
  } catch (error) {
    console.error('Error loading users:', error);
    select.innerHTML = '<option value="" disabled>Gagal memuat pengguna</option>';
  }
}

function previewGroupPhoto(event) {
  const file = event.target.files[0];
  if(!file) return;
  
  if(!file.type.startsWith('image/')) {
    showNotification('Hanya file gambar yang diizinkan', 'error');
    return;
  }
  
  if(file.size > 5 * 1024 * 1024) {
    showNotification('Ukuran file maksimal 5MB', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('group-photo-img').src = e.target.result;
    document.getElementById('group-photo-preview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

async function createGroup() {
  const name = document.getElementById('group-name').value.trim();
  const description = document.getElementById('group-desc').value.trim();
  const membersSelect = document.getElementById('group-members');
  const photoFile = document.getElementById('group-photo-input').files[0];
  
  // Validation
  if(!name) {
    showNotification('Nama grup harus diisi', 'error');
    return;
  }
  
  const selectedMembers = Array.from(membersSelect.selectedOptions).map(option => option.value);
  if(selectedMembers.length === 0) {
    showNotification('Pilih minimal 1 anggota', 'error');
    return;
  }
  
  try {
    let groupImageUrl = null;
    
    // Upload group photo if exists
    if(photoFile) {
      const fileName = `group_${Date.now()}_${photoFile.name}`;
      
      const {data, error: uploadError} = await sb.storage
        .from('group-photos')
        .upload(fileName, photoFile, {
          cacheControl: '3600',
          upsert: true
        });
      
      if(!uploadError) {
        const {data: urlData} = sb.storage
          .from('group-photos')
          .getPublicUrl(fileName);
        groupImageUrl = urlData.publicUrl;
      } else {
        // Fallback to data URL
        const reader = new FileReader();
        reader.onload = function(e) {
          groupImageUrl = e.target.result;
        };
        reader.readAsDataURL(photoFile);
      }
    }
    
    // Create group
    const {data: group, error: groupError} = await sb.from(TABLE_GROUPS)
      .insert({
        name: name,
        description: description,
        group_image: groupImageUrl,
        created_by: currentUser,
        created_at: new Date().toISOString()
      })
      .select()
      .single();
    
    if(groupError) throw groupError;
    
    // Add creator as member
    const membersToAdd = [
      { group_id: group.id, username: currentUser, joined_at: new Date().toISOString() }
    ];
    
    // Add selected members
    selectedMembers.forEach(member => {
      membersToAdd.push({
        group_id: group.id,
        username: member,
        joined_at: new Date().toISOString()
      });
    });
    
    const {error: membersError} = await sb.from(TABLE_GROUP_MEMBERS)
      .insert(membersToAdd);
    
    if(membersError) throw membersError;
    
    showNotification(`Grup "${name}" berhasil dibuat`, 'success');
    closeCreateGroupModal();
    openGroupChat(); // Refresh group list
    
  } catch (error) {
    console.error('Error creating group:', error);
    showNotification('Gagal membuat grup: ' + error.message, 'error');
  }
}

function openGroupRoom(groupId) {
  currentGroup = groupId;
  loadGroupRoom();
}

async function loadGroupRoom() {
  if(!currentGroup) return;
  
  try {
    // Get group info
    const {data: group, error: groupError} = await sb.from(TABLE_GROUPS)
      .select('*')
      .eq('id', currentGroup)
      .single();
    
    if(groupError) throw groupError;
    
    document.getElementById('group-room-title').textContent = group.name;
    document.getElementById('group-room-modal').classList.add('show');
    document.getElementById('group-room-input').focus();
    
    // Load group messages
    await loadGroupMessages();
    
    // Start group chat subscription
    startGroupChatSubscription();
    
  } catch (error) {
    console.error('Error loading group room:', error);
    showNotification('Gagal membuka grup', 'error');
  }
}

async function loadGroupMessages() {
  const container = document.getElementById('group-room-messages');
  container.innerHTML = '<div class="loading">Memuat pesan grup...</div>';
  
  try {
    const {data, error} = await sb.from(TABLE_GROUP_CHAT)
      .select('*')
      .eq('group_id', currentGroup)
      .order('created_at', { ascending: true })
      .limit(100);

    if(error) throw error;

    container.innerHTML = '';
    
    if(data && data.length > 0) {
      data.forEach(msg => {
        const time = new Date(msg.created_at).toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const isSent = msg.sender === currentUser;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : ''}`;
        messageDiv.innerHTML = `
          <div class="message-header">
            <span class="sender-name">${msg.sender}</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-content">
            ${msg.message.startsWith('data:image') ? 
              `<img src="${msg.message}" alt="Gambar" style="max-width:200px;">` : 
              msg.message}
          </div>
        `;
        
        container.appendChild(messageDiv);
      });
      
      container.scrollTop = container.scrollHeight;
    } else {
      container.innerHTML = '<p style="text-align:center;opacity:0.5;padding:40px;">Belum ada pesan di grup ini</p>';
    }
  } catch (error) {
    console.error('Error loading group messages:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat pesan grup</div>';
  }
}

function startGroupChatSubscription() {
  if(groupChatSubscription) {
    sb.removeChannel(groupChatSubscription);
  }
  
  groupChatSubscription = sb.channel('group-chat-realtime')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: TABLE_GROUP_CHAT,
      filter: `group_id=eq.${currentGroup}`
    }, (payload) => {
      addGroupMessageToDOM(payload.new);
    })
    .subscribe();
}

function addGroupMessageToDOM(msg) {
  const container = document.getElementById('group-room-messages');
  
  const time = new Date(msg.created_at).toLocaleTimeString('id-ID', {
    hour: '2-digit',
    minute: '2-digit'
  });
  
  const isSent = msg.sender === currentUser;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isSent ? 'sent' : ''}`;
  messageDiv.innerHTML = `
    <div class="message-header">
      <span class="sender-name">${msg.sender}</span>
      <span class="message-time">${time}</span>
    </div>
    <div class="message-content">
      ${msg.message.startsWith('data:image') ? 
        `<img src="${msg.message}" alt="Gambar" style="max-width:200px;">` : 
        msg.message}
    </div>
  `;
  
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;
}

async function sendGroupRoomMessage() {
  const input = document.getElementById('group-room-input');
  const message = input.value.trim();
  
  if(!message || !currentGroup || !currentUser) return;
  
  try {
    const {error} = await sb.from(TABLE_GROUP_CHAT)
      .insert({
        group_id: currentGroup,
        sender: currentUser,
        message: message
      });

    if(error) throw error;

    input.value = '';
  } catch (error) {
    console.error('Error sending group message:', error);
    showNotification('Gagal mengirim pesan grup', 'error');
  }
}

function handleGroupRoomKeyPress(e) {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendGroupRoomMessage();
  }
}

function closeGroupRoom() {
  document.getElementById('group-room-modal').classList.remove('show');
  document.getElementById('group-room-input').value = '';
  currentGroup = null;
  
  if(groupChatSubscription) {
    sb.removeChannel(groupChatSubscription);
    groupChatSubscription = null;
  }
}

// ===== GLOBAL CHAT =====
function openGlobalChat() {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }
  
  document.getElementById('global-chat-modal').classList.add('show');
  document.getElementById('global-chat-input').focus();
  
  loadGlobalChat();
  startGlobalChatSubscription();
}

function closeGlobalChat() {
  document.getElementById('global-chat-modal').classList.remove('show');
  document.getElementById('global-chat-input').value = '';
  
  // Stop subscription
  if(globalChatSubscription) {
    sb.removeChannel(globalChatSubscription);
    globalChatSubscription = null;
  }
}

async function loadGlobalChat() {
  const container = document.getElementById('global-chat-messages');
  container.innerHTML = '<div class="loading">Memuat chat global...</div>';
  
  try {
    const {data, error} = await sb.from(TABLE_GLOBALCHAT)
      .select('*')
      .order('created_at', { ascending: false })
      .limit(50);

    if(error) throw error;

    container.innerHTML = '';
    
    if(data && data.length > 0) {
      // Reverse to show oldest first
      data.reverse().forEach(msg => {
        addGlobalMessageToDOM(msg);
      });
      
      container.scrollTop = container.scrollHeight;
    } else {
      container.innerHTML = '<p style="text-align:center;opacity:0.5;padding:40px;">Belum ada pesan global</p>';
    }
  } catch (error) {
    console.error('Error loading global chat:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat chat global</div>';
  }
}

function startGlobalChatSubscription() {
  if(globalChatSubscription) {
    sb.removeChannel(globalChatSubscription);
  }
  
  globalChatSubscription = sb.channel('global-chat-realtime')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: TABLE_GLOBALCHAT
    }, (payload) => {
      addGlobalMessageToDOM(payload.new);
    })
    .subscribe();
}

function addGlobalMessageToDOM(msg) {
  const container = document.getElementById('global-chat-messages');
  
  const time = new Date(msg.created_at).toLocaleTimeString('id-ID', {
    hour: '2-digit',
    minute: '2-digit'
  });
  
  const isMe = msg.sender === currentUser;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isMe ? 'sent' : ''}`;
  messageDiv.innerHTML = `
    <div class="message-header">
      <span class="sender-name">${msg.sender}</span>
      <span class="message-time">${time}</span>
    </div>
    <div class="message-content">
      ${msg.message.startsWith('data:image') ? 
        `<img src="${msg.message}" alt="Gambar" style="max-width:200px;">` : 
        msg.message}
    </div>
  `;
  
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;
}

async function sendGlobalMessage() {
  const input = document.getElementById('global-chat-input');
  const message = input.value.trim();
  
  if(!message || !currentUser) return;
  
  try {
    const {error} = await sb.from(TABLE_GLOBALCHAT)
      .insert({
        sender: currentUser,
        message: message
      });

    if(error) throw error;

    input.value = '';
  } catch (error) {
    console.error('Error sending global message:', error);
    showNotification('Gagal mengirim pesan global', 'error');
  }
}

function handleGlobalChatKeyPress(e) {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendGlobalMessage();
  }
}

// ===== CALL HISTORY =====
function openCallHistory() {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }
  
  document.getElementById('call-history-modal').classList.add('show');
  loadCallHistory();
}

function closeCallHistory() {
  document.getElementById('call-history-modal').classList.remove('show');
}

async function loadCallHistory() {
  const container = document.getElementById('call-history-content');
  container.innerHTML = '<div class="loading">Memuat riwayat panggilan...</div>';
  
  try {
    const {data, error} = await sb.from(TABLE_CALLS)
      .select('*')
      .or(`caller.eq.${currentUser},receiver.eq.${currentUser}`)
      .order('started_at', { ascending: false })
      .limit(50);

    if(error) throw error;

    container.innerHTML = '';
    
    if(data && data.length > 0) {
      let html = `
        <table class="call-history-table">
          <thead>
            <tr>
              <th>Tipe</th>
              <th>Kontak</th>
              <th>Status</th>
              <th>Waktu</th>
              <th>Durasi</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(call => {
        const isOutgoing = call.caller === currentUser;
        const contact = isOutgoing ? call.receiver : call.caller;
        const direction = isOutgoing ? 'Keluar' : 'Masuk';
        
        let statusClass = 'ended';
        let statusText = 'Berakhir';
        
        if(call.status === 'connected') {
          statusClass = 'connected';
          statusText = 'Terhubung';
        } else if(call.status === 'calling' || call.status === 'waiting') {
          statusClass = 'missed';
          statusText = 'Tidak terjawab';
        } else if(call.status === 'rejected') {
          statusClass = 'missed';
          statusText = 'Ditolak';
        }
        
        const startTime = new Date(call.started_at).toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const duration = call.duration ? 
          `${Math.floor(call.duration/60)}:${(call.duration%60).toString().padStart(2, '0')}` : 
          '--:--';
        
        html += `
          <tr>
            <td>
              <div class="call-type ${call.type}">
                <i class="fas fa-${call.type === 'video' ? 'video' : 'phone'}"></i>
                <span>${direction}</span>
              </div>
            </td>
            <td>${contact}</td>
            <td><span class="call-status-badge ${statusClass}">${statusText}</span></td>
            <td>${startTime}</td>
            <td class="call-duration">${duration}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    } else {
      container.innerHTML = '<p style="text-align:center;opacity:0.5;padding:40px;">Belum ada riwayat panggilan</p>';
    }
  } catch (error) {
    console.error('Error loading call history:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat riwayat panggilan</div>';
  }
}

// ===== NOTIFICATION SYSTEM =====
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div class="notification-content">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      <span>${message}</span>
    </div>
  `;
  
  // Add to body
  document.body.appendChild(notification);
  
  // Show with animation
  setTimeout(() => {
    notification.classList.add('show');
  }, 10);
  
  // Remove after delay
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if(notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// ===== UTILITY FUNCTIONS =====
function attachFile(type) {
  document.getElementById('file-input').click();
}

function handleFileUpload(event) {
  const file = event.target.files[0];
  if(!file) return;
  
  if(!file.type.startsWith('image/')) {
    showNotification('Hanya file gambar yang diizinkan', 'error');
    return;
  }
  
  if(file.size > 5 * 1024 * 1024) {
    showNotification('Ukuran file maksimal 5MB', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    const imageData = e.target.result;
    
    try {
      if(chatTarget) {
        // Send to private chat
        await sb.from(TABLE_KLIKCHAT)
          .insert({
            sender: currentUser,
            receiver: chatTarget,
            message: imageData
          });
      } else if(currentGroup) {
        // Send to group chat
        await sb.from(TABLE_GROUP_CHAT)
          .insert({
            group_id: currentGroup,
            sender: currentUser,
            message: imageData
          });
      } else {
        // Send to global chat
        await sb.from(TABLE_GLOBALCHAT)
          .insert({
            sender: currentUser,
            message: imageData
          });
      }
      
      showNotification('Gambar berhasil dikirim', 'success');
    } catch (error) {
      console.error('Error sending image:', error);
      showNotification('Gagal mengirim gambar', 'error');
    }
  };
  
  reader.readAsDataURL(file);
  event.target.value = ''; // Reset input
}

// Initialize online status on page visibility change
document.addEventListener('visibilitychange', function() {
  if(!document.hidden && currentUser) {
    updateOnlineStatus();
  }
});
</script>

</body>
</html>
