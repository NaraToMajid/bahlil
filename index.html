<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Klik Game</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#bfbfbf;height:100vh;display:flex;align-items:center;justify-content:center;font-family:Arial}
#count{font-size:32px;margin-bottom:12px;transition:.15s}
.bump{transform:scale(1.2)}
#photo{width:220px;height:220px;border-radius:50%;border:8px solid #eee;overflow:hidden;cursor:pointer}
#photo img{width:100%;height:100%;object-fit:cover}
#btn{position:fixed;top:16px;right:16px;width:44px;height:44px;border-radius:50%;background:#333;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
#panel{position:fixed;right:0;top:0;width:340px;height:100%;background:#e5e5e5;transform:translateX(100%);transition:.3s;padding:16px;overflow:auto}
#panel.show{transform:translateX(0)}
input,button{width:100%;padding:8px;margin-top:8px}
hr{margin:16px 0}
table{width:100%;margin-top:12px;border-collapse:collapse}
td{border-bottom:1px solid #aaa;padding:6px}
</style>
</head>

<body>

<div id="btn">â˜…</div>

<div style="text-align:center">
  <div id="count">0</div>
  <div id="photo"><img src="foto.webp"></div>
</div>

<div id="panel">
  <button onclick="panel.classList.remove('show')">Tutup</button>

  <h3>DAFTAR</h3>
  <input id="reg_user" placeholder="Username">
  <input id="reg_pass" type="password" placeholder="Password">
  <button onclick="register()">Daftar</button>

  <hr>

  <h3>LOGIN</h3>
  <input id="log_user" placeholder="Username">
  <input id="log_pass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>

  <table id="board"></table>
</div>

<audio id="sound" src="suara.mp3"></audio>

<script>
const sb = supabase.createClient(
  'https://bxhrnnwfqlsoviysqcdw.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4aHJubndmcWxzb3ZpeXNxY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODkzNDIsImV4cCI6MjA4MTM2NTM0Mn0.O7fpv0TrDd-8ZE3Z9B5zWyAuWROPis5GRnKMxmqncX8'
);

btn.onclick = () => panel.classList.add('show');

photo.onclick = async () => {
  sound.currentTime = 0; sound.play();
  sound.currentTime = 0; sound.play();

  count.textContent++;
  count.classList.add('bump');
  setTimeout(()=>count.classList.remove('bump'),150);

  const {data:{user}} = await sb.auth.getUser();
  if(user) await sb.rpc('inc_click');
};

function makeEmail(username){
  return username + '@example.com';
}

async function register(){
  const email = makeEmail(reg_user.value);
  const pass = reg_pass.value;

  const { error } = await sb.auth.signUp({
    email,
    password: pass,
    options:{
      data:{ username: reg_user.value }
    }
  });

  if(error) return alert(error.message);
  loadMe(); loadBoard();
}

async function login(){
  const email = makeEmail(log_user.value);
  const pass = log_pass.value;

  const { error } = await sb.auth.signInWithPassword({
    email,
    password: pass
  });

  if(error) return alert(error.message);
  loadMe(); loadBoard();
}

async function loadMe(){
  const {data:{user}} = await sb.auth.getUser();
  if(!user) return;

  const {data} = await sb
    .from('KLIKUSER')
    .select('jumlah_klik')
    .eq('user_id', user.id)
    .single();

  if(data) count.textContent = data.jumlah_klik;
}

async function loadBoard(){
  const {data} = await sb
    .from('KLIKUSER')
    .select('*')
    .order('jumlah_klik', {ascending:false});

  board.innerHTML = '';
  data.forEach((r,i)=>{
    board.innerHTML += `<tr>
      <td>${i+1}</td>
      <td>${r.username}</td>
      <td>${r.jumlah_klik}</td>
    </tr>`;
  });
}

sb.channel('rt')
.on('postgres_changes',{event:'*',schema:'public',table:'KLIKUSER'},()=>{loadBoard();loadMe();})
.subscribe();

loadBoard(); loadMe();
</script>
</body>
</html>
