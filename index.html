<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Klik Game</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{
  width:100%;height:100%;
  background:#bdbdbd;
  font-family:Arial;
  overflow:hidden;
}
#app{
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:10px;
}
#count{font-size:40px;font-weight:bold}
#photo{
  width:240px;height:240px;
  border-radius:50%;
  border:8px solid #eee;
  overflow:hidden;
  cursor:pointer;
}
#photo img{width:100%;height:100%;object-fit:cover}

#btn{
  position:fixed;
  top:14px;right:14px;
  width:46px;height:46px;
  border-radius:50%;
  background:#222;color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:10;
}

#panel{
  position:fixed;
  top:0;right:0;
  width:85%;max-width:360px;
  height:100%;
  background:#eaeaea;
  transform:translateX(100%);
  transition:.3s;
  padding:15px;
  overflow:auto;
}
#panel.show{transform:translateX(0)}

input,button{
  width:100%;
  padding:10px;
  margin-top:8px;
}

table{
  width:100%;
  margin-top:10px;
  border-collapse:collapse;
}
td{
  padding:6px;
  border-bottom:1px solid #aaa;
  font-size:14px;
}
.gold{background:#ffd700}
.silver{background:#c0c0c0}
.bronze{background:#cd7f32}
.me{outline:2px solid #000}

/* CHAT */
#chatBox{
  position:fixed;
  bottom:0;right:0;
  width:100%;
  max-width:360px;
  height:55%;
  background:#222;
  color:#fff;
  display:none;
  flex-direction:column;
  z-index:20;
}
#chatHeader{
  background:#111;
  padding:10px;
  font-weight:bold;
}
#chatMessages{
  flex:1;
  padding:10px;
  overflow-y:auto;
}
.chat-me{text-align:right;color:#4caf50}
.chat-you{text-align:left}
#chatInput{display:flex}
#chatInput input{flex:1;border:none}
#chatInput button{
  width:70px;
  background:#4caf50;
  border:none;
}
</style>
</head>

<body>

<div id="btn">â˜…</div>

<div id="app">
  <div id="count">0</div>
  <div id="photo"><img src="foto.webp"></div>
</div>

<div id="panel"></div>

<div id="chatBox">
  <div id="chatHeader"></div>
  <div id="chatMessages"></div>
  <div id="chatInput">
    <input id="chatText" placeholder="Ketik pesan...">
    <button onclick="sendChat()">Kirim</button>
  </div>
</div>

<script>
// ===== ANTI INSPECT BASIC =====
document.addEventListener('contextmenu',e=>e.preventDefault());
document.addEventListener('keydown',e=>{
 if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='J'))||(e.ctrlKey&&e.key==='u')){
  e.preventDefault();return false;
 }
});

// ===== SUPABASE =====
const sb = supabase.createClient(
  'https://bxhrnnwfqlsoviysqcdw.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4aHJubndmcWxzb3ZpeXNxY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODkzNDIsImV4cCI6MjA4MTM2NTM0Mn0.O7fpv0TrDd-8ZE3Z9B5zWyAuWROPis5GRnKMxmqncX8'
);

let currentUser=null;
let currentClick=0;
let chatTarget=null;

// ===== PANEL =====
btn.onclick=()=>panel.classList.add('show');

function renderAuth(){
panel.innerHTML=`
<h3>DAFTAR</h3>
<input id="ru" placeholder="Username">
<input id="rp" type="password" placeholder="Password">
<button onclick="register()">Daftar</button>
<hr>
<h3>LOGIN</h3>
<input id="lu" placeholder="Username">
<input id="lp" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<hr>
<button onclick="loadBoard()">Refresh Leaderboard</button>
<table id="board"></table>
`;
loadBoard();
}
renderAuth();

// ===== CLICK =====
photo.onclick=async()=>{
 if(!currentUser)return alert('Login dulu');
 currentClick++;
 count.textContent=currentClick;
 await sb.from('KLIKUSER')
 .update({jumlah_klik:currentClick})
 .eq('username',currentUser);
};

// ===== AUTH =====
async function register(){
 await sb.from('KLIKUSER')
 .insert({username:ru.value,password:rp.value});
 currentUser=ru.value;
 currentClick=0;
 afterLogin();
}
async function login(){
 const {data}=await sb.from('KLIKUSER')
 .select('*')
 .eq('username',lu.value)
 .eq('password',lp.value)
 .single();
 if(!data)return alert('Login gagal');
 currentUser=data.username;
 currentClick=data.jumlah_klik;
 afterLogin();
}
function afterLogin(){
 count.textContent=currentClick;
 panel.innerHTML=`
<button onclick="panel.classList.remove('show')">Tutup</button>
<button onclick="logout()">Logout</button>
<input type="color" onchange="saveColor(this.value)">
<button onclick="loadBoard()">Leaderboard</button>
<table id="board"></table>
`;
 loadBoard();
}
function logout(){
 currentUser=null;
 currentClick=0;
 count.textContent=0;
 renderAuth();
}

// ===== COLOR =====
async function saveColor(c){
 await sb.from('KLIKUSER')
 .update({name_color:c})
 .eq('username',currentUser);
 loadBoard();
}

// ===== LEADERBOARD =====
async function loadBoard(){
 const {data}=await sb.from('KLIKUSER')
 .select('*')
 .order('jumlah_klik',{ascending:false});
 if(!board)return;
 board.innerHTML='';
 data.forEach((r,i)=>{
  let cls=i==0?'gold':i==1?'silver':i==2?'bronze':'';
  if(r.username==currentUser)cls+=' me';
  board.innerHTML+=`
  <tr class="${cls}">
   <td>${i+1}</td>
   <td style="background:${r.name_color};cursor:pointer"
    onclick="openChat('${r.username}')">${r.username}</td>
   <td>${r.jumlah_klik}</td>
  </tr>`;
 });
}

// ===== CHAT =====
function openChat(u){
 if(u===currentUser)return;
 chatTarget=u;
 chatBox.style.display='flex';
 chatHeader.innerText='Chat dengan '+u;
 loadChat();
}
async function loadChat(){
 const {data}=await sb.from('KLIK_CHAT')
 .select('*')
 .or(`and(from_user.eq.${currentUser},to_user.eq.${chatTarget}),
      and(from_user.eq.${chatTarget},to_user.eq.${currentUser})`)
 .order('created_at');
 chatMessages.innerHTML='';
 data.forEach(m=>{
  chatMessages.innerHTML+=`
  <div class="${m.from_user===currentUser?'chat-me':'chat-you'}">
   ${m.message}
  </div>`;
 });
 chatMessages.scrollTop=999999;
}
async function sendChat(){
 if(!chatText.value)return;
 await sb.from('KLIK_CHAT')
 .insert({
  from_user:currentUser,
  to_user:chatTarget,
  message:chatText.value
 });
 chatText.value='';
 loadChat();
}
</script>

</body>
</html>
