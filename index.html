<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Klik Counter</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #000; height: 100vh; font-family: Arial, sans-serif; }
.counter { 
    position: absolute; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -250%); 
    font-size: 5rem; 
    color: #fff; 
    font-family: 'Arial Black', sans-serif; 
    z-index: 2; 
    text-shadow: 0 0 15px #fff;
    font-weight: 900;
}
.circle { 
    position: absolute; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    width: 200px; 
    height: 200px; 
    border-radius: 50%; 
    cursor: pointer; 
    border: 3px solid #fff; 
    overflow: hidden; 
    z-index: 1;
    transition: transform 0.05s;
}
.circle:active { transform: translate(-50%, -50%) scale(0.95); }
.btn { 
    position: fixed; 
    top: 20px; 
    right: 20px; 
    width: 50px; 
    height: 50px; 
    background: #000; 
    color: #fff; 
    border: 2px solid #fff; 
    border-radius: 50%; 
    cursor: pointer; 
    z-index: 100; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 1.2rem;
}
.panel { 
    position: fixed; 
    top: 0; 
    right: -400px; 
    width: 380px; 
    height: 100vh; 
    background: #000; 
    border-left: 2px solid #444; 
    transition: 0.3s; 
    z-index: 99; 
    display: flex; 
    flex-direction: column;
}
.panel.open { right: 0; }
.header { 
    padding: 20px; 
    border-bottom: 2px solid #444; 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
}
.header h2 { color: #fff; font-size: 1.4rem; }
.close { background: none; border: none; color: #fff; cursor: pointer; font-size: 1.5rem; }
.auth { padding: 20px; border-bottom: 2px solid #444; }
.form { display: none; flex-direction: column; gap: 15px; }
.form.active { display: flex; }
.btns { display: flex; gap: 10px; }
.auth-btn { 
    flex: 1; 
    padding: 10px; 
    background: #333; 
    color: #fff; 
    border: 1px solid #666; 
    cursor: pointer; 
    border-radius: 4px;
}
.input { display: flex; flex-direction: column; gap: 8px; }
.input label { color: #ccc; font-size: 0.9rem; }
.input input { 
    padding: 10px; 
    background: #111; 
    border: 1px solid #444; 
    color: #fff; 
    border-radius: 4px;
}
.submit { 
    padding: 10px; 
    background: #444; 
    color: #fff; 
    border: none; 
    cursor: pointer; 
    border-radius: 4px;
}
.content { 
    flex: 1; 
    overflow-y: auto; 
    padding: 15px;
}
.item { 
    display: flex; 
    align-items: center; 
    padding: 12px; 
    background: #111; 
    border: 1px solid #333; 
    margin-bottom: 8px; 
    border-radius: 6px;
}
.item.current { border-color: #fff; background: #222; }
.rank { width: 40px; color: #fff; font-weight: bold; font-size: 1.2rem; }
.info { flex: 1; margin-left: 15px; }
.name { color: #fff; font-size: 1rem; }
.score { color: #fff; font-weight: bold; font-size: 1.1rem; }
.error { color: #ff4444; font-size: 0.8rem; display: none; }
.error.show { display: block; }
</style>
</head>
<body>
<div class="counter" id="counter">0</div>
<div class="circle" id="circle">
    <!-- Foto akan dimuat dari file foto.webp -->
</div>
<button class="btn" id="toggle"><i class="fas fa-trophy"></i></button>
<div class="panel" id="panel">
<div class="header">
    <h2><i class="fas fa-crown"></i> LEADERBOARD</h2>
    <button class="close" id="close"><i class="fas fa-times"></i></button>
</div>
<div class="auth">
    <div class="btns">
        <button class="auth-btn" id="showLogin"><i class="fas fa-sign-in-alt"></i> Login</button>
        <button class="auth-btn" id="showRegister"><i class="fas fa-user-plus"></i> Register</button>
    </div>
    <div class="form" id="loginForm">
        <div class="input">
            <label><i class="fas fa-user"></i> Username</label>
            <input type="text" id="user">
        </div>
        <div class="input">
            <label><i class="fas fa-lock"></i> Password</label>
            <input type="password" id="pass">
        </div>
        <div class="error" id="loginErr"></div>
        <button class="submit" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login</button>
    </div>
    <div class="form" id="registerForm">
        <div class="input">
            <label><i class="fas fa-user"></i> Username</label>
            <input type="text" id="regUser">
        </div>
        <div class="input">
            <label><i class="fas fa-lock"></i> Password</label>
            <input type="password" id="regPass">
        </div>
        <div class="error" id="regErr"></div>
        <button class="submit" id="regBtn"><i class="fas fa-user-plus"></i> Register</button>
    </div>
</div>
<div class="content" id="content">
    <div class="item">
        <div class="rank">1</div>
        <div class="info">
            <div class="name">Klik lingkaran untuk mulai</div>
        </div>
        <div class="score">0</div>
    </div>
</div>
</div>

<script>
// Inisialisasi variabel
let clicks = 0;
let currentUser = null;
let audio = null;

// Konfigurasi Supabase
const SUPABASE_URL = 'https://bxhrnnwfqlsoviysqcdw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4aHJubndmcWxzb3ZpeXNxY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODkzNDIsImV4cCI6MjA4MTM2NTM0Mn0.O7fpv0TrDd-8ZE3Z9B5zWyAuWROPis5GRnKMxmqncX8';

// DOM Elements
const counter = document.getElementById('counter');
const circle = document.getElementById('circle');
const toggle = document.getElementById('toggle');
const panel = document.getElementById('panel');
const closeBtn = document.getElementById('close');
const showLogin = document.getElementById('showLogin');
const showRegister = document.getElementById('showRegister');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const loginBtn = document.getElementById('loginBtn');
const regBtn = document.getElementById('regBtn');
const userInput = document.getElementById('user');
const passInput = document.getElementById('pass');
const regUserInput = document.getElementById('regUser');
const regPassInput = document.getElementById('regPass');
const content = document.getElementById('content');
const loginErr = document.getElementById('loginErr');
const regErr = document.getElementById('regErr');

// Load foto
const loadPhoto = () => {
    const img = new Image();
    img.src = 'foto.webp';
    img.onload = () => {
        circle.innerHTML = '';
        circle.appendChild(img);
    };
    img.onerror = () => {
        circle.innerHTML = '<div style="width:100%;height:100%;background:#333;display:flex;align-items:center;justify-content:center;color:#fff;font-size:3rem;"><i class="fas fa-mouse-pointer"></i></div>';
    };
    img.alt = 'Klik disini';
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
};

// Inisialisasi audio
const initAudio = () => {
    audio = new Audio('suara.mp3');
    audio.volume = 0.5;
    audio.preload = 'auto';
};

// Supabase client sederhana
const supabaseClient = {
    async query(table, method, data = null) {
        const url = `${SUPABASE_URL}/rest/v1/${table}`;
        const headers = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };
        
        try {
            let options = {
                method: method,
                headers: headers
            };
            
            if (data && (method === 'POST' || method === 'PATCH' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(url, options);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            if (method === 'DELETE' || response.status === 204) {
                return { data: null, error: null };
            }
            
            const result = await response.json();
            return { data: result, error: null };
        } catch (error) {
            return { data: null, error };
        }
    },
    
    from(table) {
        return {
            select: (columns = '*') => ({
                eq: (column, value) => ({
                    single: async () => {
                        const url = `${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${encodeURIComponent(value)}&select=${columns}`;
                        const headers = {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        };
                        
                        try {
                            const response = await fetch(url, { headers });
                            if (!response.ok) throw new Error('Not found');
                            const data = await response.json();
                            return { data: data[0], error: data[0] ? null : new Error('Not found') };
                        } catch (error) {
                            return { data: null, error };
                        }
                    }
                }),
                order: (column, { ascending = true } = {}) => ({
                    limit: async (limit) => {
                        const order = ascending ? 'asc' : 'desc';
                        const url = `${SUPABASE_URL}/rest/v1/${table}?select=${columns}&order=${column}.${order}&limit=${limit}`;
                        const headers = {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        };
                        
                        try {
                            const response = await fetch(url, { headers });
                            const data = await response.json();
                            return { data, error: null };
                        } catch (error) {
                            return { data: null, error };
                        }
                    }
                })
            }),
            
            insert: async (data) => {
                return await supabaseClient.query(table, 'POST', data);
            },
            
            update: async (data) => ({
                eq: async (column, value) => {
                    const url = `${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${encodeURIComponent(value)}`;
                    const headers = {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    };
                    
                    try {
                        const response = await fetch(url, {
                            method: 'PATCH',
                            headers: headers,
                            body: JSON.stringify(data)
                        });
                        
                        if (!response.ok) throw new Error('Update failed');
                        const result = await response.json();
                        return { data: result, error: null };
                    } catch (error) {
                        return { data: null, error };
                    }
                }
            }),
            
            delete: async () => ({
                eq: async (column, value) => {
                    return await supabaseClient.query(`${table}?${column}=eq.${encodeURIComponent(value)}`, 'DELETE');
                }
            })
        };
    }
};

// Setup event listeners
const setupEventListeners = () => {
    // Klik pada lingkaran
    circle.addEventListener('click', handleClick);
    
    // Tombol leaderboard
    toggle.addEventListener('click', () => {
        panel.classList.toggle('open');
        loadLeaderboard();
    });
    
    // Tombol close panel
    closeBtn.addEventListener('click', () => {
        panel.classList.remove('open');
    });
    
    // Form login/register
    showLogin.addEventListener('click', () => {
        loginForm.classList.add('active');
        registerForm.classList.remove('active');
        showLogin.style.display = 'none';
        showRegister.style.display = 'none';
        clearErrors();
    });
    
    showRegister.addEventListener('click', () => {
        registerForm.classList.add('active');
        loginForm.classList.remove('active');
        showLogin.style.display = 'none';
        showRegister.style.display = 'none';
        clearErrors();
    });
    
    // Tombol login
    loginBtn.addEventListener('click', handleLogin);
    
    // Tombol register
    regBtn.addEventListener('click', handleRegister);
};

// Handle klik pada lingkaran
const handleClick = () => {
    clicks++;
    counter.textContent = clicks;
    
    // Efek visual pada counter
    counter.style.textShadow = '0 0 25px #fff';
    setTimeout(() => {
        counter.style.textShadow = '0 0 15px #fff';
    }, 100);
    
    // Play suara dengan cepat
    playSound();
    
    // Update skor jika user login
    if (currentUser) {
        updateScore();
    }
};

// Play suara dengan cepat
const playSound = () => {
    if (!audio) {
        // Fallback sound jika audio tidak tersedia
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = 1000;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.1);
        } catch (e) {
            console.log("Fallback sound error");
        }
        return;
    }
    
    try {
        // Buat audio baru setiap kali untuk response cepat
        const audioClone = new Audio('suara.mp3');
        audioClone.volume = 0.5;
        audioClone.playbackRate = 2.0; // Percepat suara 2x
        audioClone.play().catch(e => console.log("Audio play error"));
    } catch (e) {
        console.log("Audio error:", e);
    }
};

// Handle login
const handleLogin = async () => {
    const username = userInput.value.trim();
    const password = passInput.value.trim();
    
    if (!username || !password) {
        showError(loginErr, "Username dan password harus diisi");
        return;
    }
    
    try {
        // Query ke tabel KLIKUSER
        const { data, error } = await supabaseClient.from('KLIKUSER').select().eq('username', username).eq('password', password).single();
        
        if (error || !data) {
            showError(loginErr, "Username atau password salah");
            return;
        }
        
        // Login berhasil
        currentUser = {
            id: data.id,
            username: data.username,
            click_count: data.click_count || 0
        };
        
        // Update counter dari database
        clicks = currentUser.click_count || 0;
        counter.textContent = clicks;
        
        // Tampilkan pesan sukses
        showAuthButtons();
        loadLeaderboard();
        
    } catch (error) {
        showError(loginErr, "Error: " + error.message);
    }
};

// Handle register
const handleRegister = async () => {
    const username = regUserInput.value.trim();
    const password = regPassInput.value.trim();
    
    if (!username || !password) {
        showError(regErr, "Username dan password harus diisi");
        return;
    }
    
    if (password.length < 4) {
        showError(regErr, "Password minimal 4 karakter");
        return;
    }
    
    try {
        // Cek apakah username sudah ada
        const { data: existing, error: checkError } = await supabaseClient.from('KLIKUSER').select('id').eq('username', username).single();
        
        if (existing && !checkError) {
            showError(regErr, "Username sudah digunakan");
            return;
        }
        
        // Buat user baru
        const { data: newUser, error } = await supabaseClient.from('KLIKUSER').insert([
            { 
                username: username, 
                password: password,
                click_count: 0
            }
        ]);
        
        if (error) {
            showError(regErr, "Gagal membuat akun");
            return;
        }
        
        currentUser = {
            id: newUser[0].id,
            username: newUser[0].username,
            click_count: 0
        };
        
        showAuthButtons();
        loadLeaderboard();
        
    } catch (error) {
        showError(regErr, "Error: " + error.message);
    }
};

// Update skor ke database
const updateScore = async () => {
    if (!currentUser) return;
    
    try {
        await supabaseClient.from('KLIKUSER').update({ 
            click_count: clicks
        }).eq('id', currentUser.id);
        
        loadLeaderboard();
    } catch (error) {
        console.error("Update score error:", error);
    }
};

// Load leaderboard dari tabel KLIKUSER
const loadLeaderboard = async () => {
    try {
        // Ambil semua user dari tabel KLIKUSER dengan fetch langsung
        const url = `${SUPABASE_URL}/rest/v1/KLIKUSER?select=username,click_count&order=click_count.desc`;
        const headers = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
        };
        
        const response = await fetch(url, { headers });
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();
        
        if (!data || data.length === 0) {
            content.innerHTML = '<div class="item"><div class="info"><div class="name">Belum ada data pengguna</div></div></div>';
            return;
        }
        
        let html = '';
        data.forEach((user, index) => {
            const isCurrent = currentUser && user.username === currentUser.username;
            html += `
                <div class="item ${isCurrent ? 'current' : ''}">
                    <div class="rank">${index + 1}</div>
                    <div class="info">
                        <div class="name">${user.username || 'Unknown'}</div>
                    </div>
                    <div class="score">${user.click_count || 0}</div>
                </div>
            `;
        });
        
        content.innerHTML = html;
        
    } catch (error) {
        content.innerHTML = '<div class="item"><div class="info"><div class="name">Loading data...</div></div></div>';
    }
};

// Tampilkan tombol auth
const showAuthButtons = () => {
    loginForm.classList.remove('active');
    registerForm.classList.remove('active');
    showLogin.style.display = 'block';
    showRegister.style.display = 'block';
    userInput.value = '';
    passInput.value = '';
    regUserInput.value = '';
    regPassInput.value = '';
    clearErrors();
};

// Tampilkan error
const showError = (element, message) => {
    element.textContent = message;
    element.classList.add('show');
    setTimeout(() => {
        element.classList.remove('show');
    }, 5000);
};

// Hapus semua error
const clearErrors = () => {
    loginErr.classList.remove('show');
    regErr.classList.remove('show');
};

// Inisialisasi aplikasi
document.addEventListener('DOMContentLoaded', () => {
    loadPhoto();
    initAudio();
    setupEventListeners();
    loadLeaderboard();
});
</script>
</body>
</html>
