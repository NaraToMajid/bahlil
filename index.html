<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KlikGame</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ===== VARIABLES & RESET ===== */
:root {
  --primary: #000000;
  --secondary: #ffffff;
  --accent: #4a00e0;
  --accent-light: #8e2de2;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-500: #6b7280;
  --gray-700: #374151;
  --gray-900: #111827;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --info: #3b82f6;
  --radius: 12px;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-700) 100%);
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  color: var(--secondary);
}

/* ===== MAIN APP LAYOUT ===== */
#app {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 24px;
  padding: 20px;
  position: relative;
}

/* ===== HEADER ===== */
.app-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 50;
}

.app-title {
  font-size: 1.5rem;
  font-weight: 700;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.control-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--primary);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  font-size: 18px;
}

.control-btn:hover {
  background: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

/* ===== MAIN CLICK AREA ===== */
.click-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  margin-top: 80px;
}

#count {
  font-size: 4rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 30px rgba(138, 43, 226, 0.3);
}

.click-label {
  font-size: 1rem;
  color: var(--gray-300);
  text-transform: uppercase;
  letter-spacing: 2px;
}

/* ===== CLICK CIRCLE WITH EFFECT ===== */
.click-circle {
  position: relative;
  width: 280px;
  height: 280px;
  cursor: pointer;
}

.click-circle-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: var(--primary);
  border: 3px solid rgba(255, 255, 255, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
  transition: var(--transition);
  box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
}

.click-circle-inner:hover {
  border-color: var(--accent);
  box-shadow: 0 0 60px rgba(138, 43, 226, 0.4);
}

#photo {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  transition: transform 0.2s;
}

.click-circle:active #photo {
  transform: scale(0.95);
}

/* CLICK EFFECT ANIMATION */
.click-effect {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  pointer-events: none;
  opacity: 0;
}

.click-effect.active {
  animation: ripple 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes ripple {
  0% {
    box-shadow: 0 0 0 0 rgba(138, 43, 226, 0.6);
    opacity: 1;
  }
  100% {
    box-shadow: 0 0 0 200px rgba(138, 43, 226, 0);
    opacity: 0;
  }
}

/* ===== MUSIC PLAYER ===== */
.music-player {
  position: absolute;
  bottom: 24px;
  right: 24px;
  z-index: 40;
}

.music-btn {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--primary);
  border: 2px solid var(--accent);
  color: var(--secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  font-size: 20px;
  box-shadow: var(--shadow);
}

.music-btn:hover {
  background: var(--accent);
  transform: scale(1.1);
}

.music-btn.playing {
  background: var(--accent);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(138, 43, 226, 0.7); }
  50% { box-shadow: 0 0 0 15px rgba(138, 43, 226, 0); }
}

/* ===== SIDEBAR PANEL ===== */
#panel {
  position: fixed;
  top: 0;
  right: 0;
  width: 380px;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(20px);
  transform: translateX(100%);
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  padding: 24px;
  overflow-y: auto;
  z-index: 100;
  border-left: 1px solid rgba(255, 255, 255, 0.1);
}

#panel.show {
  transform: translateX(0);
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.panel-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--secondary);
}

.close-panel {
  background: none;
  border: none;
  color: var(--gray-300);
  font-size: 24px;
  cursor: pointer;
  transition: var(--transition);
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
}

.close-panel:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--secondary);
}

/* ===== AUTH FORMS ===== */
.auth-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 24px;
}

.auth-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--secondary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-group {
  margin-bottom: 16px;
}

.form-input {
  width: 100%;
  padding: 14px 16px;
  background: rgba(255, 255, 255, 0.07);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: var(--secondary);
  font-size: 15px;
  transition: var(--transition);
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.1);
}

.form-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  color: var(--secondary);
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.form-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.form-btn.logout {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
}

.verif-code-container {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  padding: 16px;
  margin: 16px 0;
  text-align: center;
}

#verif-code {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: 4px;
  color: var(--info);
  padding: 12px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 6px;
  margin: 12px 0;
  cursor: pointer;
  transition: var(--transition);
  font-family: monospace;
}

#verif-code:hover {
  background: rgba(0, 0, 0, 0.5);
}

/* ===== USER INFO ===== */
.user-info-card {
  background: linear-gradient(135deg, rgba(74, 0, 224, 0.2), rgba(142, 45, 226, 0.1));
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 24px;
  border: 1px solid rgba(138, 43, 226, 0.3);
}

.user-info-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

.user-avatar {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  border: 3px solid var(--accent);
  object-fit: cover;
}

.user-details h3 {
  font-size: 1.3rem;
  font-weight: 600;
  margin-bottom: 4px;
}

.user-details p {
  color: var(--gray-300);
  font-size: 0.9rem;
}

.user-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.stat-item {
  text-align: center;
  padding: 12px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
}

.stat-label {
  font-size: 0.85rem;
  color: var(--gray-400);
  margin-top: 4px;
}

/* ===== LEADERBOARD ===== */
.leaderboard-section {
  margin-top: 24px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.section-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--secondary);
}

.refresh-btn {
  background: none;
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: var(--secondary);
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 6px;
}

.refresh-btn:hover {
  background: rgba(255, 255, 255, 0.1);
}

.leaderboard-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 8px;
}

.leaderboard-row {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.leaderboard-row:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-2px);
}

.leaderboard-row.gold {
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
}

.leaderboard-row.silver {
  background: linear-gradient(135deg, rgba(192, 192, 192, 0.15), rgba(192, 192, 192, 0.05));
}

.leaderboard-row.bronze {
  background: linear-gradient(135deg, rgba(205, 127, 50, 0.15), rgba(205, 127, 50, 0.05));
}

.leaderboard-row.me {
  border: 2px solid var(--accent);
}

.leaderboard-cell {
  padding: 16px;
  text-align: center;
}

.rank-cell {
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--accent);
}

.user-cell {
  text-align: left;
  cursor: pointer;
  position: relative;
}

.username-with-bg {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px;
  border-radius: 6px;
  background: rgba(0, 0, 0, 0.3);
}

.user-cell-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--accent);
}

.chat-notification {
  position: absolute;
  top: 50%;
  right: 10px;
  transform: translateY(-50%);
  width: 10px;
  height: 10px;
  background: var(--danger);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.actions-cell {
  text-align: right;
}

.action-btn {
  background: none;
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: var(--secondary);
  width: 36px;
  height: 36px;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.action-btn:hover {
  background: var(--accent);
  border-color: var(--accent);
}

/* ===== MODAL STYLES ===== */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal.show {
  display: flex;
}

.modal-content {
  background: rgba(0, 0, 0, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius);
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-lg);
}

.modal-header {
  padding: 24px;
  background: rgba(0, 0, 0, 0.6);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--secondary);
}

.modal-close {
  background: none;
  border: none;
  color: var(--gray-300);
  font-size: 24px;
  cursor: pointer;
  transition: var(--transition);
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--secondary);
}

.modal-body {
  padding: 24px;
  flex: 1;
  overflow-y: auto;
}

.modal-footer {
  padding: 20px 24px;
  background: rgba(0, 0, 0, 0.6);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* ===== CHAT MODAL ===== */
.chat-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
}

.chat-user-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 2px solid var(--accent);
  object-fit: cover;
}

.chat-user-info h4 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 4px;
}

.chat-user-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: var(--success);
}

.status-dot {
  width: 8px;
  height: 8px;
  background: var(--success);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.chat-controls {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}

.call-btn {
  flex: 1;
  padding: 12px;
  background: linear-gradient(135deg, var(--success), #059669);
  color: var(--secondary);
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.video-call-btn {
  flex: 1;
  padding: 12px;
  background: linear-gradient(135deg, var(--info), #2563eb);
  color: var(--secondary);
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.call-btn:hover, .video-call-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.chat-messages {
  height: 300px;
  overflow-y: auto;
  padding-right: 10px;
  margin-bottom: 20px;
}

.message {
  margin-bottom: 16px;
  display: flex;
  flex-direction: column;
  max-width: 80%;
}

.message.received {
  align-items: flex-start;
}

.message.sent {
  align-items: flex-end;
}

.message-bubble {
  padding: 12px 16px;
  border-radius: 18px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  word-wrap: break-word;
}

.message.received .message-bubble {
  background: rgba(255, 255, 255, 0.1);
  color: var(--secondary);
  border-top-left-radius: 4px;
}

.message.sent .message-bubble {
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  color: var(--secondary);
  border-top-right-radius: 4px;
}

.message-image {
  max-width: 200px;
  border-radius: 12px;
  margin-top: 8px;
}

.message-time {
  font-size: 11px;
  color: var(--gray-400);
  margin-top: 4px;
  text-align: right;
}

.chat-input-area {
  display: flex;
  gap: 12px;
  align-items: center;
}

.chat-input {
  flex: 1;
  padding: 14px 16px;
  background: rgba(255, 255, 255, 0.07);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 24px;
  color: var(--secondary);
  font-size: 15px;
  transition: var(--transition);
}

.chat-input:focus {
  outline: none;
  border-color: var(--accent);
}

.chat-action-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  color: var(--secondary);
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-action-btn:hover {
  background: var(--accent-light);
  transform: scale(1.1);
}

/* ===== GROUP CHAT MODAL ===== */
.group-management {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.group-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.group-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
}

.group-item:hover {
  background: rgba(255, 255, 255, 0.1);
}

.group-avatar {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  object-fit: cover;
  border: 2px solid var(--accent);
}

.group-info h5 {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 4px;
}

.group-info p {
  font-size: 0.9rem;
  color: var(--gray-400);
}

.create-group-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  color: var(--secondary);
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 16px;
}

.create-group-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

/* ===== CALL MODAL ===== */
.call-container {
  text-align: center;
  padding: 40px 20px;
}

.call-avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid var(--accent);
  object-fit: cover;
  margin: 0 auto 24px;
}

.call-status {
  font-size: 1.2rem;
  margin-bottom: 32px;
  color: var(--gray-300);
}

.call-timer {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 40px;
}

.call-controls {
  display: flex;
  justify-content: center;
  gap: 20px;
}

.call-control-btn {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  border: none;
  color: var(--secondary);
  font-size: 20px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
}

.call-control-btn.accept {
  background: linear-gradient(135deg, var(--success), #059669);
}

.call-control-btn.decline {
  background: linear-gradient(135deg, var(--danger), #dc2626);
}

.call-control-btn.end {
  background: linear-gradient(135deg, var(--danger), #dc2626);
}

.call-control-btn:hover {
  transform: scale(1.1);
  box-shadow: var(--shadow);
}

/* ===== LOADING & ERROR ===== */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--gray-300);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(255, 255, 255, 0.1);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-message {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #fca5a5;
  padding: 16px;
  border-radius: 8px;
  margin: 16px 0;
  font-size: 14px;
  text-align: center;
}

/* ===== GLOBAL CHAT BUTTON ===== */
#global-chat-btn {
  position: fixed;
  bottom: 100px;
  right: 24px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--info), #2563eb);
  color: var(--secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  cursor: pointer;
  z-index: 40;
  box-shadow: var(--shadow-lg);
  transition: var(--transition);
}

#global-chat-btn:hover {
  transform: scale(1.1);
}

.global-notification {
  position: absolute;
  top: -5px;
  right: -5px;
  width: 24px;
  height: 24px;
  background: var(--danger);
  border-radius: 50%;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--accent-light);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .click-circle {
    width: 240px;
    height: 240px;
  }
  
  #panel {
    width: 100%;
  }
  
  .modal-content {
    max-width: 100%;
    max-height: 100vh;
    border-radius: 0;
  }
  
  .call-controls {
    flex-direction: column;
    align-items: center;
  }
}
</style>
</head>

<body>
<!-- Main App -->
<div id="app">
  <!-- Header -->
  <div class="app-header">
    <div class="app-title">KlikGame</div>
    <div class="header-controls">
      <button class="control-btn" onclick="openPanel()">
        <i class="fas fa-chart-bar"></i>
      </button>
      <button class="control-btn" onclick="openGlobalChat()">
        <i class="fas fa-globe"></i>
      </button>
      <button class="control-btn" onclick="openGroups()">
        <i class="fas fa-users"></i>
      </button>
    </div>
  </div>

  <!-- Main Click Area -->
  <div class="click-container">
    <div class="click-label">Total Klik</div>
    <div id="count">0</div>
    
    <div class="click-circle" id="click-circle">
      <div class="click-circle-inner">
        <img id="photo" src="logo.jpg" alt="Klik disini" 
             onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"280\" height=\"280\"><rect width=\"100%\" height=\"100%\" fill=\"%234a00e0\"/><text x=\"50%\" y=\"50%\" font-family=\"Arial\" font-size=\"32\" fill=\"white\" text-anchor=\"middle\" dy=\".3em\">KLIK</text></svg>';">
      </div>
      <div class="click-effect" id="click-effect"></div>
    </div>
  </div>

  <!-- Music Player -->
  <div class="music-player">
    <button class="music-btn" id="music-btn" onclick="toggleMusic()">
      <i class="fas fa-music"></i>
    </button>
  </div>
</div>

<!-- Side Panel -->
<div id="panel">
  <div class="panel-header">
    <div class="panel-title">Dashboard</div>
    <button class="close-panel" onclick="closePanel()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div id="panel-content">
    <!-- Content akan diisi oleh JavaScript -->
  </div>
</div>

<!-- Private Chat Modal -->
<div id="chat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Chat Pribadi</div>
      <button class="modal-close" onclick="closeChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="chat-header">
        <img id="chat-user-avatar" class="chat-user-avatar" src="logo.jpg" alt="User Avatar">
        <div class="chat-user-info">
          <h4 id="chat-username">Username</h4>
          <div class="chat-user-status">
            <span class="status-dot"></span>
            <span id="chat-status">Online</span>
          </div>
        </div>
      </div>
      
      <div class="chat-controls">
        <button class="call-btn" onclick="startCall(false)">
          <i class="fas fa-phone"></i>
          <span>Telepon</span>
        </button>
        <button class="video-call-btn" onclick="startCall(true)">
          <i class="fas fa-video"></i>
          <span>Video Call</span>
        </button>
      </div>
      
      <div class="chat-messages" id="chat-messages"></div>
    </div>
    <div class="modal-footer">
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chat-input" placeholder="Ketik pesan...">
        <button class="chat-action-btn" onclick="sendChatMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Call/Video Call Modal -->
<div id="call-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="call-title">Telepon</div>
      <button class="modal-close" onclick="endCall()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="call-container">
        <img id="call-avatar" class="call-avatar" src="logo.jpg" alt="Call Avatar">
        <div class="call-status" id="call-status">Menghubungi...</div>
        <div class="call-timer" id="call-timer">00:00</div>
        <div class="call-controls">
          <button class="call-control-btn accept" id="accept-call" onclick="acceptCall()">
            <i class="fas fa-phone"></i>
          </button>
          <button class="call-control-btn decline" onclick="endCall()">
            <i class="fas fa-phone-slash"></i>
          </button>
          <button class="call-control-btn end" id="end-call" onclick="endCall()" style="display: none;">
            <i class="fas fa-phone-slash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Group Chat Modal -->
<div id="group-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Grup Chat</div>
      <button class="modal-close" onclick="closeGroups()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="group-management">
        <div class="group-list" id="group-list">
          <!-- Groups akan diisi oleh JavaScript -->
        </div>
        <button class="create-group-btn" onclick="createGroup()">
          <i class="fas fa-plus-circle"></i>
          <span>Buat Grup Baru</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Global Chat Button -->
<button id="global-chat-btn" onclick="openGlobalChatModal()">
  <i class="fas fa-comments"></i>
  <div id="global-notification" class="global-notification" style="display:none"></div>
</button>

<script>
// ==== SUPABASE CONFIGURATION ====
const SUPABASE_URL = 'https://bxhrnnwfqlsoviysqcdw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4aHJubndmcWxzb3ZpeXNxY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODkzNDIsImV4cCI6MjA4MTM2NTM0Mn0.O7fpv0TrDd-8ZE3Z9B5zWyAuWROPis5GRnKMxmqncX8';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Nama tabel dengan suffix -bahlil
const TABLE_USERS = 'KLIKUSER_bahlil';
const TABLE_CHATS = 'KLIKCHAT_bahlil';
const TABLE_GROUPS = 'KLIKGROUPS_bahlil';
const TABLE_GROUP_MEMBERS = 'KLIKGROUPMEMBERS_bahlil';
const TABLE_GROUP_MESSAGES = 'KLIKGROUPMESSAGES_bahlil';
const TABLE_CALLS = 'KLIKCALLS_bahlil';

// ==== GLOBAL VARIABLES ====
let currentUser = null;
let currentClick = 0;
let verificationCode = '';
let chatTarget = null;
let currentGroup = null;
let callInProgress = false;
let callType = 'audio'; // 'audio' or 'video'
let callTimer = null;
let callStartTime = null;
let musicPlaying = false;
let music = null;
let unreadChats = new Set();
let unreadGlobal = 0;
let peerConnection = null;
let localStream = null;
let remoteStream = null;

// ==== MUSIC SYSTEM ====
function initMusic() {
  try {
    music = new Audio('lagu.mp3');
    music.loop = true;
    music.volume = 0.3;
    
    // Cek status musik dari localStorage
    const savedMusicState = localStorage.getItem('klikMusicState');
    if (savedMusicState === 'playing') {
      toggleMusic();
    }
  } catch (e) {
    console.error('Error loading music:', e);
  }
}

function toggleMusic() {
  const musicBtn = document.getElementById('music-btn');
  
  if (!musicPlaying) {
    if (music) {
      music.play().then(() => {
        musicPlaying = true;
        musicBtn.classList.add('playing');
        musicBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
        localStorage.setItem('klikMusicState', 'playing');
      }).catch(e => {
        console.error('Error playing music:', e);
      });
    }
  } else {
    if (music) {
      music.pause();
      musicPlaying = false;
      musicBtn.classList.remove('playing');
      musicBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
      localStorage.setItem('klikMusicState', 'paused');
    }
  }
}

// ==== CLICK ANIMATION ====
function createClickEffect() {
  const effect = document.getElementById('click-effect');
  effect.classList.remove('active');
  void effect.offsetWidth; // Trigger reflow
  effect.classList.add('active');
}

// ==== PANEL SYSTEM ====
function openPanel() {
  document.getElementById('panel').classList.add('show');
  loadPanelContent();
  generateVerificationCode();
}

function closePanel() {
  document.getElementById('panel').classList.remove('show');
}

function loadPanelContent() {
  const panelContent = document.getElementById('panel-content');
  
  if (!currentUser) {
    // Show login/register form
    panelContent.innerHTML = `
      <div class="auth-section">
        <div class="auth-title">
          <i class="fas fa-user-plus"></i>
          <span>Daftar Akun Baru</span>
        </div>
        <div class="form-group">
          <input type="text" class="form-input" id="reg_user" placeholder="Username">
        </div>
        <div class="form-group">
          <input type="password" class="form-input" id="reg_pass" placeholder="Password">
        </div>
        <div class="verif-code-container">
          <small>Salin kode verifikasi berikut:</small>
          <div id="verif-code"></div>
          <small id="copy-hint">Klik untuk menyalin</small>
        </div>
        <div class="form-group">
          <input type="text" class="form-input" id="reg_verif" placeholder="Tempel kode verifikasi">
        </div>
        <button class="form-btn" onclick="register()">
          <i class="fas fa-user-plus"></i>
          <span>Daftar</span>
        </button>
      </div>
      
      <div class="auth-section">
        <div class="auth-title">
          <i class="fas fa-sign-in-alt"></i>
          <span>Login ke Akun</span>
        </div>
        <div class="form-group">
          <input type="text" class="form-input" id="log_user" placeholder="Username">
        </div>
        <div class="form-group">
          <input type="password" class="form-input" id="log_pass" placeholder="Password">
        </div>
        <button class="form-btn" onclick="login()">
          <i class="fas fa-sign-in-alt"></i>
          <span>Login</span>
        </button>
      </div>
      
      <div class="leaderboard-section">
        <div class="section-header">
          <div class="section-title">Leaderboard</div>
          <button class="refresh-btn" onclick="loadLeaderboard()">
            <i class="fas fa-redo"></i>
            <span>Refresh</span>
          </button>
        </div>
        <div id="leaderboard-container">
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Memuat leaderboard...</span>
          </div>
        </div>
      </div>
    `;
    generateVerificationCode();
  } else {
    // Show user dashboard
    panelContent.innerHTML = `
      <div class="user-info-card">
        <div class="user-info-header">
          <img class="user-avatar" id="user-avatar" src="logo.jpg" alt="User Avatar">
          <div class="user-details">
            <h3>${currentUser}</h3>
            <p>Player sejak ${new Date().toLocaleDateString('id-ID')}</p>
          </div>
        </div>
        <div class="user-stats">
          <div class="stat-item">
            <div class="stat-value">${currentClick}</div>
            <div class="stat-label">Total Klik</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="user-rank">-</div>
            <div class="stat-label">Peringkat</div>
          </div>
        </div>
      </div>
      
      <div class="auth-section">
        <button class="form-btn logout" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
      
      <div class="leaderboard-section">
        <div class="section-header">
          <div class="section-title">Leaderboard</div>
          <button class="refresh-btn" onclick="loadLeaderboard()">
            <i class="fas fa-redo"></i>
            <span>Refresh</span>
          </button>
        </div>
        <div id="leaderboard-container">
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Memuat leaderboard...</span>
          </div>
        </div>
      </div>
    `;
    loadLeaderboard();
    loadUserRank();
    loadUserAvatar();
  }
}

// ==== AUTHENTICATION SYSTEM ====
function generateVerificationCode() {
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  const verifElement = document.getElementById('verif-code');
  if (verifElement) {
    verifElement.textContent = code;
    verifElement.onclick = function() {
      navigator.clipboard.writeText(code).then(() => {
        document.getElementById('copy-hint').textContent = 'âœ“ Kode disalin!';
        setTimeout(() => {
          document.getElementById('copy-hint').textContent = 'Klik untuk menyalin';
        }, 2000);
      });
    };
  }
  verificationCode = code;
}

async function register() {
  const username = document.getElementById('reg_user').value.trim();
  const password = document.getElementById('reg_pass').value.trim();
  const verifCode = document.getElementById('reg_verif').value.trim();
  
  if (!username || !password || !verifCode) {
    alert('Harap isi semua kolom');
    return;
  }
  
  if (verifCode !== verificationCode) {
    alert('Kode verifikasi salah!');
    generateVerificationCode();
    return;
  }
  
  if (username.length < 3) {
    alert('Username minimal 3 karakter');
    return;
  }
  
  if (password.length < 6) {
    alert('Password minimal 6 karakter');
    return;
  }
  
  try {
    // Check if username exists
    const { data: existingUser } = await sb
      .from(TABLE_USERS)
      .select('username')
      .eq('username', username)
      .single();
    
    if (existingUser) {
      alert('Username sudah digunakan!');
      return;
    }
    
    // Create new user
    const { error } = await sb
      .from(TABLE_USERS)
      .insert({
        username: username,
        password: password, // In production, hash this password!
        jumlah_klik: 0,
        avatar_url: 'logo.jpg',
        created_at: new Date().toISOString()
      });
    
    if (error) throw error;
    
    alert('Akun berhasil dibuat!');
    currentUser = username;
    currentClick = 0;
    afterLogin();
  } catch (error) {
    console.error('Registration error:', error);
    alert('Error: ' + error.message);
  }
}

async function login() {
  const username = document.getElementById('log_user').value.trim();
  const password = document.getElementById('log_pass').value.trim();
  
  try {
    const { data, error } = await sb
      .from(TABLE_USERS)
      .select('*')
      .eq('username', username)
      .eq('password', password) // In production, compare hashed passwords!
      .single();
    
    if (error || !data) {
      alert('Username atau password salah!');
      return;
    }
    
    currentUser = username;
    currentClick = data.jumlah_klik || 0;
    afterLogin();
  } catch (error) {
    console.error('Login error:', error);
    alert('Error: ' + error.message);
  }
}

function afterLogin() {
  document.getElementById('count').textContent = currentClick;
  loadPanelContent();
  checkUnreadMessages();
  startRealtimeSubscriptions();
  localStorage.setItem('klikUser', currentUser);
}

function logout() {
  currentUser = null;
  currentClick = 0;
  document.getElementById('count').textContent = '0';
  localStorage.removeItem('klikUser');
  closePanel();
  setTimeout(() => {
    loadPanelContent();
  }, 100);
}

// ==== LEADERBOARD SYSTEM ====
async function loadLeaderboard() {
  const container = document.getElementById('leaderboard-container');
  if (!container) return;
  
  container.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      <span>Memuat leaderboard...</span>
    </div>
  `;
  
  try {
    const { data, error } = await sb
      .from(TABLE_USERS)
      .select('*')
      .order('jumlah_klik', { ascending: false })
      .limit(20);
    
    if (error) throw error;
    
    if (data && data.length > 0) {
      let html = `
        <table class="leaderboard-table">
          <tbody>
      `;
      
      data.forEach((user, index) => {
        const rank = index + 1;
        let rowClass = 'leaderboard-row';
        let rankText = rank;
        
        if (rank === 1) {
          rowClass += ' gold';
          rankText = 'ðŸ¥‡';
        } else if (rank === 2) {
          rowClass += ' silver';
          rankText = 'ðŸ¥ˆ';
        } else if (rank === 3) {
          rowClass += ' bronze';
          rankText = 'ðŸ¥‰';
        }
        
        if (user.username === currentUser) {
          rowClass += ' me';
        }
        
        const hasUnread = unreadChats.has(user.username);
        
        html += `
          <tr class="${rowClass}" onclick="openChat('${user.username.replace(/'/g, "\\'")}')">
            <td class="leaderboard-cell rank-cell">${rankText}</td>
            <td class="leaderboard-cell user-cell">
              <div class="username-with-bg">
                <img class="user-cell-avatar" src="${user.avatar_url || 'logo.jpg'}" alt="${user.username}">
                <span>${user.username}</span>
                ${hasUnread ? '<div class="chat-notification"></div>' : ''}
              </div>
            </td>
            <td class="leaderboard-cell">${user.jumlah_klik || 0}</td>
            <td class="leaderboard-cell actions-cell">
              ${user.username === currentUser ? `
                <button class="action-btn" onclick="event.stopPropagation(); openProfileEditor()">
                  <i class="fas fa-edit"></i>
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
    } else {
      container.innerHTML = `
        <div class="error-message">
          <i class="fas fa-exclamation-circle"></i>
          <p>Belum ada data leaderboard</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading leaderboard:', error);
    container.innerHTML = `
      <div class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        <p>Gagal memuat leaderboard</p>
      </div>
    `;
  }
}

async function loadUserRank() {
  if (!currentUser) return;
  
  try {
    const { data: allUsers } = await sb
      .from(TABLE_USERS)
      .select('username, jumlah_klik')
      .order('jumlah_klik', { ascending: false });
    
    if (allUsers) {
      const rank = allUsers.findIndex(user => user.username === currentUser) + 1;
      const rankElement = document.getElementById('user-rank');
      if (rankElement) {
        rankElement.textContent = `#${rank}`;
      }
    }
  } catch (error) {
    console.error('Error loading user rank:', error);
  }
}

async function loadUserAvatar() {
  if (!currentUser) return;
  
  try {
    const { data } = await sb
      .from(TABLE_USERS)
      .select('avatar_url')
      .eq('username', currentUser)
      .single();
    
    if (data && data.avatar_url) {
      const avatarElement = document.getElementById('user-avatar');
      if (avatarElement) {
        avatarElement.src = data.avatar_url;
      }
    }
  } catch (error) {
    console.error('Error loading user avatar:', error);
  }
}

// ==== CLICK HANDLER ====
document.getElementById('photo').onclick = async function() {
  if (!currentUser) {
    alert('Silakan login terlebih dahulu!');
    openPanel();
    return;
  }
  
  // Play click sound
  try {
    const clickSound = new Audio('suara.mp3');
    clickSound.playbackRate = 2.0;
    clickSound.volume = 0.3;
    clickSound.play();
  } catch (e) {}
  
  // Create visual effect
  createClickEffect();
  
  // Update count
  currentClick++;
  document.getElementById('count').textContent = currentClick;
  
  // Update in database
  try {
    await sb
      .from(TABLE_USERS)
      .update({ jumlah_klik: currentClick })
      .eq('username', currentUser);
    
    // Update leaderboard if panel is open
    if (document.getElementById('panel').classList.contains('show')) {
      loadLeaderboard();
      loadUserRank();
    }
  } catch (error) {
    console.error('Error updating click count:', error);
  }
};

// ==== CHAT SYSTEM ====
async function openChat(username) {
  if (!currentUser) {
    alert('Silakan login terlebih dahulu!');
    return;
  }
  
  if (username === currentUser) {
    alert('Tidak bisa mengirim chat ke diri sendiri');
    return;
  }
  
  chatTarget = username;
  
  // Update modal
  document.getElementById('chat-username').textContent = username;
  document.getElementById('chat-user-avatar').src = 'logo.jpg';
  document.getElementById('chat-modal').classList.add('show');
  document.getElementById('chat-input').focus();
  
  // Remove notification for this user
  unreadChats.delete(username);
  loadLeaderboard();
  
  // Load chat messages
  await loadChatMessages();
}

function closeChat() {
  document.getElementById('chat-modal').classList.remove('show');
  chatTarget = null;
  document.getElementById('chat-input').value = '';
}

async function loadChatMessages() {
  const messagesDiv = document.getElementById('chat-messages');
  messagesDiv.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      <span>Memuat pesan...</span>
    </div>
  `;
  
  try {
    const { data, error } = await sb
      .from(TABLE_CHATS)
      .select('*')
      .or(`and(sender.eq.${currentUser},receiver.eq.${chatTarget}),and(sender.eq.${chatTarget},receiver.eq.${currentUser})`)
      .order('created_at', { ascending: true })
      .limit(50);
    
    if (error) throw error;
    
    messagesDiv.innerHTML = '';
    
    if (data && data.length > 0) {
      data.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.sender === currentUser ? 'sent' : 'received'}`;
        
        const time = new Date(msg.created_at).toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        let content = '';
        if (msg.message.startsWith('data:image')) {
          content = `<img src="${msg.message}" alt="Gambar" class="message-image">`;
        } else {
          content = msg.message;
        }
        
        messageDiv.innerHTML = `
          <div class="message-bubble">${content}</div>
          <div class="message-time">${time}</div>
        `;
        
        messagesDiv.appendChild(messageDiv);
      });
      
      // Scroll to bottom
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } else {
      messagesDiv.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--gray-400);">
          <i class="fas fa-comment-slash" style="font-size: 2rem; margin-bottom: 16px;"></i>
          <p>Belum ada pesan. Mulai percakapan!</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading messages:', error);
    messagesDiv.innerHTML = `
      <div class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        <p>Gagal memuat pesan</p>
      </div>
    `;
  }
}

async function sendChatMessage() {
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  
  if (!message || !currentUser || !chatTarget) return;
  
  try {
    const { error } = await sb
      .from(TABLE_CHATS)
      .insert({
        sender: currentUser,
        receiver: chatTarget,
        message: message,
        created_at: new Date().toISOString()
      });
    
    if (error) throw error;
    
    input.value = '';
    await loadChatMessages();
  } catch (error) {
    console.error('Error sending message:', error);
    alert('Gagal mengirim pesan');
  }
}

// Enter key support for chat
document.getElementById('chat-input')?.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    sendChatMessage();
  }
});

// ==== CALL/VIDEO CALL SYSTEM ====
let currentCallId = null;
let callData = null;

async function startCall(isVideo) {
  if (!currentUser || !chatTarget) return;
  
  callType = isVideo ? 'video' : 'audio';
  
  try {
    // Create call record
    const { data, error } = await sb
      .from(TABLE_CALLS)
      .insert({
        caller: currentUser,
        receiver: chatTarget,
        call_type: callType,
        status: 'calling',
        created_at: new Date().toISOString()
      })
      .select()
      .single();
    
    if (error) throw error;
    
    currentCallId = data.id;
    callData = data;
    
    // Show call modal
    document.getElementById('call-title').textContent = isVideo ? 'Video Call' : 'Telepon';
    document.getElementById('call-avatar').src = 'logo.jpg';
    document.getElementById('call-status').textContent = `Menghubungi ${chatTarget}...`;
    document.getElementById('accept-call').style.display = 'none';
    document.getElementById('end-call').style.display = 'block';
    document.getElementById('call-modal').classList.add('show');
    
    // Start WebRTC (simplified for example)
    // In production, you'd need a signaling server and STUN/TURN servers
    
  } catch (error) {
    console.error('Error starting call:', error);
    alert('Gagal memulai panggilan');
  }
}

function acceptCall() {
  if (!currentCallId) return;
  
  document.getElementById('call-status').textContent = 'Sedang berlangsung...';
  document.getElementById('accept-call').style.display = 'none';
  document.getElementById('end-call').style.display = 'block';
  
  // Start timer
  callStartTime = new Date();
  callTimer = setInterval(updateCallTimer, 1000);
  
  // Update call status
  updateCallStatus('active');
  
  // In production: Accept WebRTC connection
}

function endCall() {
  if (callTimer) {
    clearInterval(callTimer);
    callTimer = null;
  }
  
  document.getElementById('call-modal').classList.remove('show');
  
  if (currentCallId) {
    updateCallStatus('ended');
    currentCallId = null;
  }
  
  // In production: Close WebRTC connection
}

function updateCallTimer() {
  if (!callStartTime) return;
  
  const now = new Date();
  const diff = Math.floor((now - callStartTime) / 1000);
  const minutes = Math.floor(diff / 60);
  const seconds = diff % 60;
  
  document.getElementById('call-timer').textContent = 
    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

async function updateCallStatus(status) {
  if (!currentCallId) return;
  
  try {
    await sb
      .from(TABLE_CALLS)
      .update({ status: status, ended_at: new Date().toISOString() })
      .eq('id', currentCallId);
  } catch (error) {
    console.error('Error updating call status:', error);
  }
}

// ==== GROUP SYSTEM ====
function openGroups() {
  if (!currentUser) {
    alert('Silakan login terlebih dahulu!');
    return;
  }
  
  document.getElementById('group-modal').classList.add('show');
  loadGroups();
}

function closeGroups() {
  document.getElementById('group-modal').classList.remove('show');
}

async function loadGroups() {
  const groupList = document.getElementById('group-list');
  groupList.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      <span>Memuat grup...</span>
    </div>
  `;
  
  try {
    // Get groups where user is a member
    const { data: memberships, error: membersError } = await sb
      .from(TABLE_GROUP_MEMBERS)
      .select('group_id')
      .eq('username', currentUser);
    
    if (membersError) throw membersError;
    
    if (memberships && memberships.length > 0) {
      const groupIds = memberships.map(m => m.group_id);
      
      const { data: groups, error: groupsError } = await sb
        .from(TABLE_GROUPS)
        .select('*')
        .in('id', groupIds);
      
      if (groupsError) throw groupsError;
      
      groupList.innerHTML = '';
      
      groups.forEach(group => {
        const groupItem = document.createElement('div');
        groupItem.className = 'group-item';
        groupItem.onclick = () => openGroupChat(group.id);
        
        groupItem.innerHTML = `
          <img class="group-avatar" src="${group.avatar_url || 'logo.jpg'}" alt="${group.name}">
          <div class="group-info">
            <h5>${group.name}</h5>
            <p>${group.member_count || 0} anggota â€¢ Dibuat oleh ${group.created_by}</p>
          </div>
        `;
        
        groupList.appendChild(groupItem);
      });
    } else {
      groupList.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--gray-400);">
          <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 16px;"></i>
          <p>Anda belum bergabung dengan grup</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading groups:', error);
    groupList.innerHTML = `
      <div class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        <p>Gagal memuat grup</p>
      </div>
    `;
  }
}

async function createGroup() {
  const groupName = prompt('Masukkan nama grup:');
  if (!groupName || !currentUser) return;
  
  try {
    // Create group
    const { data: group, error: groupError } = await sb
      .from(TABLE_GROUPS)
      .insert({
        name: groupName,
        created_by: currentUser,
        avatar_url: 'logo.jpg',
        created_at: new Date().toISOString()
      })
      .select()
      .single();
    
    if (groupError) throw groupError;
    
    // Add creator as member
    const { error: memberError } = await sb
      .from(TABLE_GROUP_MEMBERS)
      .insert({
        group_id: group.id,
        username: currentUser,
        role: 'admin',
        joined_at: new Date().toISOString()
      });
    
    if (memberError) throw memberError;
    
    alert(`Grup "${groupName}" berhasil dibuat!`);
    loadGroups();
  } catch (error) {
    console.error('Error creating group:', error);
    alert('Gagal membuat grup');
  }
}

function openGroupChat(groupId) {
  // Implement group chat functionality
  alert('Fitur group chat akan segera hadir!');
}

// ==== NOTIFICATION SYSTEM ====
async function checkUnreadMessages() {
  if (!currentUser) return;
  
  try {
    // Check unread private messages
    const { data: unread } = await sb
      .from(TABLE_CHATS)
      .select('sender')
      .eq('receiver', currentUser)
      .eq('is_read', false);
    
    if (unread) {
      unread.forEach(msg => {
        unreadChats.add(msg.sender);
      });
      updateChatNotifications();
    }
  } catch (error) {
    console.error('Error checking unread messages:', error);
  }
}

function updateChatNotifications() {
  // Update leaderboard to show notifications
  loadLeaderboard();
}

// ==== REALTIME SUBSCRIPTIONS ====
function startRealtimeSubscriptions() {
  if (!currentUser) return;
  
  // Subscribe to new private messages
  const chatChannel = sb.channel('private-chat')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: TABLE_CHATS,
      filter: `receiver=eq.${currentUser}`
    }, (payload) => {
      const sender = payload.new.sender;
      unreadChats.add(sender);
      updateChatNotifications();
      
      // Show desktop notification
      if (Notification.permission === 'granted' && 
          document.hidden &&
          (!chatTarget || chatTarget !== sender)) {
        new Notification(`Pesan baru dari ${sender}`, {
          body: payload.new.message.length > 50 
            ? payload.new.message.substring(0, 50) + '...' 
            : payload.new.message,
          icon: 'logo.jpg'
        });
      }
    })
    .subscribe();
  
  // Subscribe to call invitations
  const callChannel = sb.channel('call-invitations')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: TABLE_CALLS,
      filter: `receiver=eq.${currentUser}`
    }, (payload) => {
      if (payload.new.status === 'calling') {
        const confirmCall = confirm(`${payload.new.caller} mengundang Anda untuk ${payload.new.call_type === 'video' ? 'video call' : 'telepon'}. Terima?`);
        
        if (confirmCall) {
          currentCallId = payload.new.id;
          callData = payload.new;
          chatTarget = payload.new.caller;
          
          document.getElementById('call-title').textContent = 
            payload.new.call_type === 'video' ? 'Video Call' : 'Telepon';
          document.getElementById('call-avatar').src = 'logo.jpg';
          document.getElementById('call-status').textContent = `${payload.new.caller} menghubungi...`;
          document.getElementById('accept-call').style.display = 'block';
          document.getElementById('end-call').style.display = 'none';
          document.getElementById('call-modal').classList.add('show');
        }
      }
    })
    .subscribe();
  
  // Request notification permission
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

// ==== GLOBAL CHAT ====
function openGlobalChatModal() {
  if (!currentUser) {
    alert('Silakan login terlebih dahulu!');
    return;
  }
  
  // Implement global chat modal
  alert('Fitur global chat akan segera hadir!');
}

// ==== INITIALIZATION ====
document.addEventListener('DOMContentLoaded', function() {
  // Initialize music
  initMusic();
  
  // Check for saved user session
  const savedUser = localStorage.getItem('klikUser');
  if (savedUser) {
    currentUser = savedUser;
    // Load user data
    (async () => {
      try {
        const { data } = await sb
          .from(TABLE_USERS)
          .select('jumlah_klik')
          .eq('username', savedUser)
          .single();
        
        if (data) {
          currentClick = data.jumlah_klik || 0;
          document.getElementById('count').textContent = currentClick;
          afterLogin();
        } else {
          localStorage.removeItem('klikUser');
        }
      } catch (error) {
        localStorage.removeItem('klikUser');
      }
    })();
  }
  
  // Initialize click effect
  const clickCircle = document.getElementById('click-circle');
  clickCircle.addEventListener('click', createClickEffect);
});

// ==== QUERY UNTUK SUPABASE ====
/*
-- Buat tabel users
CREATE TABLE IF NOT EXISTS KLIKUSER_bahlil (
  id SERIAL PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  password VARCHAR(100) NOT NULL,
  jumlah_klik INTEGER DEFAULT 0,
  avatar_url TEXT DEFAULT 'logo.jpg',
  background_data TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Buat tabel chats pribadi
CREATE TABLE IF NOT EXISTS KLIKCHAT_bahlil (
  id SERIAL PRIMARY KEY,
  sender VARCHAR(50) NOT NULL,
  receiver VARCHAR(50) NOT NULL,
  message TEXT NOT NULL,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Buat tabel groups
CREATE TABLE IF NOT EXISTS KLIKGROUPS_bahlil (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  avatar_url TEXT DEFAULT 'logo.jpg',
  created_by VARCHAR(50) NOT NULL,
  member_count INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Buat tabel group members
CREATE TABLE IF NOT EXISTS KLIKGROUPMEMBERS_bahlil (
  id SERIAL PRIMARY KEY,
  group_id INTEGER REFERENCES KLIKGROUPS_bahlil(id) ON DELETE CASCADE,
  username VARCHAR(50) NOT NULL,
  role VARCHAR(20) DEFAULT 'member',
  joined_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(group_id, username)
);

-- Buat tabel group messages
CREATE TABLE IF NOT EXISTS KLIKGROUPMESSAGES_bahlil (
  id SERIAL PRIMARY KEY,
  group_id INTEGER REFERENCES KLIKGROUPS_bahlil(id) ON DELETE CASCADE,
  sender VARCHAR(50) NOT NULL,
  message TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Buat tabel calls
CREATE TABLE IF NOT EXISTS KLIKCALLS_bahlil (
  id SERIAL PRIMARY KEY,
  caller VARCHAR(50) NOT NULL,
  receiver VARCHAR(50) NOT NULL,
  call_type VARCHAR(10) NOT NULL, -- 'audio' or 'video'
  status VARCHAR(20) DEFAULT 'calling', -- 'calling', 'active', 'ended', 'missed'
  created_at TIMESTAMP DEFAULT NOW(),
  ended_at TIMESTAMP,
  duration INTEGER -- in seconds
);

-- Buat index untuk performa
CREATE INDEX IF NOT EXISTS idx_klikuser_username ON KLIKUSER_bahlil(username);
CREATE INDEX IF NOT EXISTS idx_klikchat_users ON KLIKCHAT_bahlil(sender, receiver);
CREATE INDEX IF NOT EXISTS idx_klikchat_created ON KLIKCHAT_bahlil(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_klikgroupmembers_user ON KLIKGROUPMEMBERS_bahlil(username);
CREATE INDEX IF NOT EXISTS idx_klikcalls_receiver ON KLIKCALLS_bahlil(receiver, status);
*/
</script>

</body>
</html>
