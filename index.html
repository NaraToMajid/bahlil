<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Klik Game</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #0a0a0a;
  color: #ffffff;
  font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  font-weight: 300;
}

/* ===== TYPOGRAPHY ===== */
h1, h2, h3, h4 {
  font-weight: 400;
  letter-spacing: 0.5px;
}

/* ===== APP LAYOUT ===== */
#app {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 25px;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
  position: relative;
  padding: 20px;
}

#count {
  font-size: 42px;
  font-weight: 300;
  letter-spacing: 2px;
  color: #ffffff;
  text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
  position: relative;
}

#count::after {
  content: 'KLIK';
  position: absolute;
  bottom: -15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  letter-spacing: 3px;
  opacity: 0.7;
}

/* ===== CIRCLE CLICK AREA ===== */
.circle-container {
  position: relative;
  width: min(280px, 70vw);
  height: min(280px, 70vw);
  display: flex;
  align-items: center;
  justify-content: center;
}

#photo {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid #333;
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  z-index: 2;
}

#photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: grayscale(20%) contrast(110%);
  transition: filter 0.3s;
}

#photo:hover img {
  filter: grayscale(0%) contrast(120%);
}

#photo:active {
  transform: scale(0.97);
  border-color: #666;
}

/* PULSE EFFECT */
.pulse-effect {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: rgba(100, 149, 237, 0.4);
  opacity: 0;
  pointer-events: none;
  z-index: 1;
}

.pulse-effect.active {
  animation: pulseClick 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes pulseClick {
  0% {
    transform: scale(0.8);
    opacity: 0.8;
  }
  50% {
    opacity: 0.4;
  }
  100% {
    transform: scale(1.5);
    opacity: 0;
  }
}

/* RING EFFECT */
.ring-container {
  position: absolute;
  width: calc(min(280px, 70vw) + 40px);
  height: calc(min(280px, 70vw) + 40px);
  pointer-events: none;
}

.ring {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 1px solid rgba(255, 255, 255, 0.1);
  animation: rotate 20s linear infinite;
}

.ring:nth-child(2) {
  width: 90%;
  height: 90%;
  top: 5%;
  left: 5%;
  animation-duration: 25s;
  animation-direction: reverse;
}

.ring:nth-child(3) {
  width: 80%;
  height: 80%;
  top: 10%;
  left: 10%;
  animation-duration: 30s;
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* ===== CONTROL BUTTONS ===== */
.control-buttons {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 100;
}

.control-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(30, 30, 30, 0.9);
  border: 1px solid #333;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
  backdrop-filter: blur(10px);
}

.control-btn:hover {
  background: rgba(40, 40, 40, 0.95);
  border-color: #555;
  transform: translateY(-2px);
}

.control-btn:active {
  transform: translateY(0);
}

.control-btn.active {
  background: rgba(255, 255, 255, 0.1);
  border-color: #fff;
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  min-width: 18px;
  height: 18px;
  background: #ffffff;
  color: #000;
  border-radius: 9px;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
  font-weight: 600;
  border: 1px solid #000;
}

/* ===== SIDEBAR PANEL ===== */
#panel {
  position: fixed;
  top: 0;
  right: 0;
  width: 100%;
  max-width: 400px;
  height: 100%;
  background: rgba(20, 20, 20, 0.98);
  transform: translateX(100%);
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  padding: 0;
  overflow-y: auto;
  z-index: 99;
  border-left: 1px solid #333;
  backdrop-filter: blur(20px);
}

#panel.show {
  transform: translateX(0);
}

.panel-header {
  padding: 25px 20px 15px;
  border-bottom: 1px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(15, 15, 15, 0.9);
}

.panel-header h2 {
  font-size: 20px;
  font-weight: 300;
}

.close-panel {
  background: none;
  border: none;
  color: #aaa;
  font-size: 20px;
  cursor: pointer;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.close-panel:hover {
  background: rgba(255, 255, 255, 0.05);
  color: #fff;
}

.panel-content {
  padding: 20px;
}

/* ===== LEADERBOARD IMPROVED ===== */
.leaderboard-section {
  margin-top: 20px;
}

.leaderboard-section h3 {
  font-size: 16px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 15px;
  opacity: 0.8;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Desktop Leaderboard */
.leaderboard-desktop {
  display: none;
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 15px;
}

.leaderboard-desktop thead {
  background: rgba(255, 255, 255, 0.03);
}

.leaderboard-desktop th {
  padding: 15px 10px;
  text-align: left;
  font-weight: 400;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 1px;
  opacity: 0.7;
  border-bottom: 1px solid #333;
}

.leaderboard-desktop tbody tr {
  background: rgba(255, 255, 255, 0.02);
  transition: all 0.2s;
  position: relative;
}

.leaderboard-desktop tbody tr:nth-child(even) {
  background: rgba(255, 255, 255, 0.01);
}

.leaderboard-desktop tbody tr:hover {
  background: rgba(255, 255, 255, 0.05);
}

.leaderboard-desktop td {
  padding: 18px 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  font-size: 14px;
  position: relative;
}

.leaderboard-desktop .rank-cell {
  width: 60px;
  text-align: center;
  font-weight: 300;
  font-size: 16px;
  opacity: 0.8;
  position: relative;
}

.leaderboard-desktop .rank-medal {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 20px;
}

.leaderboard-desktop .rank-1 .rank-medal { color: #FFD700; }
.leaderboard-desktop .rank-2 .rank-medal { color: #C0C0C0; }
.leaderboard-desktop .rank-3 .rank-medal { color: #CD7F32; }

.leaderboard-desktop .user-cell {
  cursor: pointer;
  position: relative;
  padding-left: 60px !important;
  padding-right: 40px !important;
}

.leaderboard-desktop .user-avatar {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  overflow: hidden;
  border: 1px solid #333;
}

.leaderboard-desktop .user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.leaderboard-desktop .username {
  font-weight: 400;
  letter-spacing: 0.5px;
  margin-bottom: 3px;
}

.leaderboard-desktop .user-status {
  font-size: 11px;
  opacity: 0.6;
  display: flex;
  align-items: center;
  gap: 4px;
}

.leaderboard-desktop .status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #333;
}

.leaderboard-desktop .status-dot.online {
  background: #4CAF50;
}

.leaderboard-desktop .click-cell {
  text-align: right;
  font-weight: 300;
  font-size: 16px;
  letter-spacing: 1px;
  width: 100px;
}

.leaderboard-desktop .action-cell {
  width: 80px;
  text-align: center;
}

.leaderboard-desktop .highlight-row {
  background: rgba(255, 255, 255, 0.07) !important;
  border-left: 3px solid #fff;
}

.leaderboard-desktop .chat-indicator {
  position: absolute;
  top: 50%;
  right: 15px;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  background: #fff;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

/* Mobile Leaderboard */
.leaderboard-mobile {
  display: none;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}

.leaderboard-card {
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid #333;
  border-radius: 8px;
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.2s;
  position: relative;
}

.leaderboard-card:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: #555;
}

.leaderboard-card.highlight {
  background: rgba(255, 255, 255, 0.07);
  border-left: 3px solid #fff;
}

.rank-badge {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 300;
  opacity: 0.8;
  flex-shrink: 0;
}

.rank-badge.rank-1 { color: #FFD700; }
.rank-badge.rank-2 { color: #C0C0C0; }
.rank-badge.rank-3 { color: #CD7F32; }

.user-avatar-mobile {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 1px solid #333;
}

.user-avatar-mobile img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.user-info-mobile {
  flex: 1;
  min-width: 0;
}

.username-mobile {
  font-weight: 400;
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-stats-mobile {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  opacity: 0.7;
}

.click-count-mobile {
  font-weight: 300;
  font-size: 14px;
}

.status-mobile {
  display: flex;
  align-items: center;
  gap: 4px;
}

.status-dot-mobile {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #333;
}

.status-dot-mobile.online {
  background: #4CAF50;
}

.chat-indicator-mobile {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 8px;
  height: 8px;
  background: #fff;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.3; }
  100% { opacity: 1; }
}

/* Responsive Leaderboard */
@media (min-width: 768px) {
  .leaderboard-desktop {
    display: table;
  }
  .leaderboard-mobile {
    display: none;
  }
}

@media (max-width: 767px) {
  .leaderboard-desktop {
    display: none;
  }
  .leaderboard-mobile {
    display: flex;
  }
  #panel {
    width: 100%;
    max-width: 100%;
  }
}

/* ===== FORM ELEMENTS ===== */
.form-section {
  margin-bottom: 25px;
  padding-bottom: 25px;
  border-bottom: 1px solid #333;
}

.form-section h3 {
  font-size: 16px;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 15px;
  opacity: 0.8;
}

.input-group {
  margin-bottom: 12px;
}

.input-group label {
  display: block;
  font-size: 13px;
  margin-bottom: 5px;
  opacity: 0.7;
  letter-spacing: 0.5px;
}

.input-group input {
  width: 100%;
  padding: 12px 15px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  font-size: 15px;
  transition: all 0.2s;
}

.input-group input:focus {
  outline: none;
  border-color: #555;
  background: rgba(255, 255, 255, 0.08);
}

.btn {
  width: 100%;
  padding: 12px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 400;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: #555;
}

.btn-primary {
  background: #fff;
  color: #000;
  border: 1px solid #fff;
}

.btn-primary:hover {
  background: rgba(255, 255, 255, 0.9);
}

.btn-danger {
  background: rgba(255, 255, 255, 0.05);
  border-color: #444;
}

.btn-danger:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: #555;
}

/* ===== VERIFICATION CODE ===== */
.verification-box {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 15px;
  margin: 15px 0;
  text-align: center;
}

.verification-code {
  font-family: 'Courier New', monospace;
  font-size: 24px;
  letter-spacing: 4px;
  padding: 12px;
  margin: 10px 0;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  user-select: all;
}

.verification-code:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: #555;
}

.copy-hint {
  font-size: 12px;
  opacity: 0.6;
  margin-top: 8px;
}

/* ===== USER INFO ===== */
.user-info-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid #333;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  text-align: center;
}

.user-info-card h3 {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 15px;
  opacity: 0.7;
}

.user-info-card .username {
  font-size: 22px;
  font-weight: 300;
  margin: 10px 0;
  letter-spacing: 1px;
}

.user-info-card .click-count {
  font-size: 28px;
  font-weight: 200;
  opacity: 0.9;
}

/* ===== MODAL STYLES ===== */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.modal.show {
  display: flex;
}

.modal-content {
  background: rgba(20, 20, 20, 0.95);
  width: 95%;
  max-width: 500px;
  max-height: 85vh;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  border: 1px solid #333;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(15, 15, 15, 0.9);
}

.modal-header h3 {
  font-weight: 300;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  background: none;
  border: none;
  color: #aaa;
  font-size: 20px;
  cursor: pointer;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.05);
  color: #fff;
}

.modal-body {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
}

.modal-footer {
  padding: 20px;
  border-top: 1px solid #333;
  background: rgba(15, 15, 15, 0.9);
}

/* ===== CHAT STYLES ===== */
.chat-container {
  display: flex;
  flex-direction: column;
  height: 60vh;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  background: rgba(255, 255, 255, 0.01);
  border-radius: 6px;
  margin-bottom: 15px;
}

.message {
  margin-bottom: 15px;
  padding: 12px 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.05);
  max-width: 85%;
  word-wrap: break-word;
  position: relative;
}

.message.sent {
  margin-left: auto;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.message-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 12px;
}

.sender-name {
  font-weight: 500;
  opacity: 0.9;
}

.message-time {
  opacity: 0.5;
  font-size: 11px;
}

.message-content {
  font-size: 14px;
  line-height: 1.5;
}

.message-content img {
  max-width: 100%;
  border-radius: 4px;
  margin-top: 8px;
}

.chat-input-area {
  display: flex;
  gap: 10px;
}

.chat-input-area input {
  flex: 1;
  padding: 12px 15px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  font-size: 15px;
}

.chat-input-area input:focus {
  outline: none;
  border-color: #555;
}

.chat-actions {
  display: flex;
  gap: 8px;
}

.chat-action-btn {
  width: 44px;
  height: 44px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.chat-action-btn:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: #555;
}

.call-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  justify-content: center;
}

.call-btn {
  flex: 1;
  padding: 12px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.call-btn:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: #555;
}

.call-btn.video {
  background: rgba(76, 175, 80, 0.1);
  border-color: rgba(76, 175, 80, 0.3);
}

.call-btn.audio {
  background: rgba(33, 150, 243, 0.1);
  border-color: rgba(33, 150, 243, 0.3);
}

/* ===== CALL MODAL ===== */
.call-modal .modal-content {
  max-width: 400px;
}

.call-info {
  text-align: center;
  padding: 30px 20px;
}

.call-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  margin: 0 auto 20px;
  overflow: hidden;
  border: 2px solid #333;
}

.call-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.call-status {
  font-size: 14px;
  opacity: 0.7;
  margin: 10px 0;
}

.call-timer {
  font-size: 32px;
  font-weight: 300;
  letter-spacing: 2px;
  margin: 20px 0;
}

.call-controls {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
}

.call-control-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s;
}

.call-control-btn:hover {
  background: rgba(255, 255, 255, 0.08);
}

.call-control-btn.end-call {
  background: rgba(244, 67, 54, 0.2);
  border-color: rgba(244, 67, 54, 0.4);
}

.call-control-btn.end-call:hover {
  background: rgba(244, 67, 54, 0.3);
}

.call-control-btn.active {
  background: rgba(255, 255, 255, 0.12);
  border-color: #fff;
}

#video-container {
  width: 100%;
  height: 300px;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  margin: 15px 0;
  position: relative;
}

#local-video, #remote-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#remote-video {
  background: #111;
}

.video-controls {
  position: absolute;
  bottom: 10px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
  z-index: 10;
}

.video-control-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid #333;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.video-control-btn:hover {
  background: rgba(0, 0, 0, 0.9);
}

.video-control-btn.active {
  background: rgba(255, 255, 255, 0.2);
}

/* ===== GROUP CHAT ===== */
.group-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 20px;
}

.group-item {
  padding: 15px;
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid #333;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 12px;
}

.group-item:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: #555;
}

.group-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
}

.group-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.group-info {
  flex: 1;
}

.group-name {
  font-weight: 400;
  margin-bottom: 3px;
}

.group-meta {
  font-size: 12px;
  opacity: 0.6;
}

.group-badge {
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
}

.create-group-btn {
  width: 100%;
  margin-top: 10px;
}

/* ===== BACKGROUND EDITOR ===== */
.editor-tools {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
  align-items: center;
}

.editor-tool {
  width: 44px;
  height: 44px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  color: #fff;
}

.editor-tool:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: #555;
}

.editor-tool.active {
  background: rgba(255, 255, 255, 0.12);
  border-color: #fff;
}

.canvas-container {
  display: flex;
  justify-content: center;
  margin: 20px 0;
}

#bg-canvas {
  border: 1px solid #333;
  background: #000;
  cursor: crosshair;
  border-radius: 4px;
}

.tool-options {
  display: flex;
  align-items: center;
  gap: 15px;
  margin: 15px 0;
}

.tool-options label {
  font-size: 13px;
  opacity: 0.7;
}

.tool-options input[type="range"] {
  flex: 1;
}

.tool-options input[type="color"] {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: transparent;
}

.preview-area {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #333;
}

.preview-item {
  display: inline-block;
  padding: 10px 20px;
  margin: 5px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #333;
  border-radius: 4px;
  font-size: 14px;
}

/* ===== AUDIO CONTROLS ===== */
.audio-controls {
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 100;
}

.audio-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(30, 30, 30, 0.9);
  border: 1px solid #333;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
  backdrop-filter: blur(10px);
}

.audio-btn:hover {
  background: rgba(40, 40, 40, 0.95);
  border-color: #555;
  transform: translateY(-2px);
}

.audio-btn.playing {
  background: rgba(255, 255, 255, 0.1);
  border-color: #fff;
}

/* ===== LOADING & ERROR STATES ===== */
.loading {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255, 255, 255, 0.5);
  font-size: 14px;
}

.loading::after {
  content: '';
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-left: 10px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-message {
  background: rgba(244, 67, 54, 0.1);
  border: 1px solid rgba(244, 67, 54, 0.3);
  border-radius: 6px;
  padding: 15px;
  margin: 10px 0;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.9);
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.02);
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* ===== MEDIA QUERIES ===== */
@media (max-width: 768px) {
  .circle-container {
    width: 240px;
    height: 240px;
  }
  
  .ring-container {
    width: 280px;
    height: 280px;
  }
  
  #count {
    font-size: 36px;
  }
  
  .control-buttons {
    top: 15px;
    right: 15px;
  }
  
  .control-btn {
    width: 44px;
    height: 44px;
    font-size: 16px;
  }
  
  .call-controls {
    gap: 15px;
  }
  
  .call-control-btn {
    width: 50px;
    height: 50px;
  }
  
  #video-container {
    height: 250px;
  }
}

@media (orientation: portrait) and (max-width: 767px) {
  .leaderboard-card {
    padding: 12px;
  }
  
  .rank-badge {
    width: 36px;
    height: 36px;
    font-size: 14px;
  }
  
  .user-avatar-mobile {
    width: 36px;
    height: 36px;
  }
  
  .user-stats-mobile {
    font-size: 11px;
  }
  
  .click-count-mobile {
    font-size: 13px;
  }
}

@media (orientation: landscape) and (max-height: 600px) {
  #app {
    padding: 10px;
  }
  
  .circle-container {
    width: 180px;
    height: 180px;
  }
  
  .ring-container {
    width: 220px;
    height: 220px;
  }
  
  #count {
    font-size: 30px;
  }
}
</style>
</head>

<body>

<!-- Audio Background -->
<audio id="bg-music" loop>
  <source src="lagu.mp3" type="audio/mpeg">
</audio>

<!-- Control Buttons -->
<div class="control-buttons">
  <button class="control-btn" id="panel-toggle" onclick="togglePanel()">
    <i class="fas fa-bars"></i>
  </button>
  <button class="control-btn" id="global-chat-toggle" onclick="openGlobalChat()">
    <i class="fas fa-globe"></i>
    <div class="notification-badge" id="global-notification" style="display:none"></div>
  </button>
  <button class="control-btn" id="group-chat-toggle" onclick="openGroupChat()">
    <i class="fas fa-users"></i>
  </button>
</div>

<!-- Audio Controls -->
<div class="audio-controls">
  <button class="audio-btn" id="music-toggle" onclick="toggleMusic()">
    <i class="fas fa-music"></i>
  </button>
</div>

<!-- Main App -->
<div id="app">
  <div class="ring-container">
    <div class="ring"></div>
    <div class="ring"></div>
    <div class="ring"></div>
  </div>
  
  <div class="circle-container">
    <div id="photo">
      <img src="foto.webp" alt="Klik saya!" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"240\" height=\"240\"><rect width=\"100%\" height=\"100%\" fill=\"%23111\"/><text x=\"50%\" y=\"50%\" font-family=\"Arial\" font-size=\"24\" fill=\"white\" text-anchor=\"middle\" dy=\".3em\">KLIK</text></svg>'">
    </div>
    <div class="pulse-effect" id="pulse-effect"></div>
  </div>
  
  <div id="count">0</div>
</div>

<!-- Side Panel -->
<div id="panel">
  <div class="panel-header">
    <h2>GAME PANEL</h2>
    <button class="close-panel" onclick="closePanel()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="panel-content" id="panel-content">
    <!-- Content akan diisi oleh JavaScript -->
  </div>
</div>

<!-- Chat Modal -->
<div id="chat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-comment"></i> <span id="chat-title">Chat</span></h3>
      <button class="modal-close" onclick="closeChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="call-buttons">
          <button class="call-btn audio" onclick="startAudioCall()">
            <i class="fas fa-phone"></i> Audio Call
          </button>
          <button class="call-btn video" onclick="startVideoCall()">
            <i class="fas fa-video"></i> Video Call
          </button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Ketik pesan..." onkeypress="handleChatKeyPress(event)">
        <div class="chat-actions">
          <button class="chat-action-btn" onclick="attachFile('chat')">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="chat-action-btn" onclick="sendChatMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Call Modal -->
<div id="call-modal" class="modal call-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-phone"></i> Panggilan</h3>
      <button class="modal-close" onclick="endCall()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="video-container" style="display:none;">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted style="position:absolute; top:10px; right:10px; width:120px; height:160px; border-radius:8px; border:1px solid #333;"></video>
        <div class="video-controls">
          <button class="video-control-btn" onclick="toggleVideo()" id="toggle-video-btn">
            <i class="fas fa-video"></i>
          </button>
          <button class="video-control-btn" onclick="toggleAudio()" id="toggle-audio-btn">
            <i class="fas fa-microphone"></i>
          </button>
          <button class="video-control-btn end-call" onclick="endCall()">
            <i class="fas fa-phone-slash"></i>
          </button>
        </div>
      </div>
      <div class="call-info" id="call-info">
        <div class="call-avatar" id="call-avatar"></div>
        <h3 id="call-name">...</h3>
        <div class="call-status" id="call-status">Menghubungkan...</div>
        <div class="call-timer" id="call-timer">00:00</div>
        <div class="call-controls">
          <button class="call-control-btn" onclick="toggleMute()" id="mute-btn">
            <i class="fas fa-microphone"></i>
          </button>
          <button class="call-control-btn" onclick="toggleSpeaker()" id="speaker-btn">
            <i class="fas fa-volume-up"></i>
          </button>
          <button class="call-control-btn end-call" onclick="endCall()">
            <i class="fas fa-phone-slash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Group Chat Modal -->
<div id="group-chat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-users"></i> Grup Chat</h3>
      <button class="modal-close" onclick="closeGroupChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="group-list" id="group-list">
        <!-- Group list akan diisi oleh JavaScript -->
      </div>
      <button class="btn create-group-btn" onclick="showCreateGroup()">
        <i class="fas fa-plus"></i> Buat Grup Baru
      </button>
    </div>
  </div>
</div>

<!-- Create Group Modal -->
<div id="create-group-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-plus-circle"></i> Buat Grup Baru</h3>
      <button class="modal-close" onclick="closeCreateGroup()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group">
        <label>Nama Grup</label>
        <input type="text" id="group-name" placeholder="Masukkan nama grup">
      </div>
      <div class="input-group">
        <label>Deskripsi</label>
        <input type="text" id="group-desc" placeholder="Deskripsi grup (opsional)">
      </div>
      <div class="input-group">
        <label>Foto Grup (Opsional)</label>
        <input type="file" id="group-photo" accept="image/*" onchange="previewGroupPhoto(event)">
        <div id="group-photo-preview" style="margin-top:10px; display:none;">
          <img id="group-photo-img" src="" style="width:100px; height:100px; object-fit:cover; border-radius:6px;">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="createGroup()">
        <i class="fas fa-check"></i> Buat Grup
      </button>
    </div>
  </div>
</div>

<!-- Background Editor Modal -->
<div id="bg-editor-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-palette"></i> Edit Latar Belakang</h3>
      <button class="modal-close" onclick="closeBgEditor()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="editor-tools">
        <button class="editor-tool active" onclick="setTool('pencil')" title="Pensil">
          <i class="fas fa-pencil-alt"></i>
        </button>
        <button class="editor-tool" onclick="setTool('eraser')" title="Penghapus">
          <i class="fas fa-eraser"></i>
        </button>
        <button class="editor-tool" onclick="setTool('bucket')" title="Ember">
          <i class="fas fa-fill-drip"></i>
        </button>
        <input type="color" id="color-picker" value="#ffffff" onchange="setColor(this.value)">
      </div>
      <div class="tool-options">
        <label>Ukuran:</label>
        <input type="range" id="brush-size" min="1" max="20" value="3" onchange="setBrushSize(this.value)">
        <span id="brush-size-label">3px</span>
      </div>
      <div class="canvas-container">
        <canvas id="bg-canvas" width="300" height="40"></canvas>
      </div>
      <div class="preview-area">
        <p>Preview:</p>
        <div class="preview-item" id="bg-preview">Username</div>
      </div>
    </div>
    <div class="modal-footer">
      <div style="display:flex; gap:10px;">
        <button class="btn" onclick="clearCanvas()">
          <i class="fas fa-trash"></i> Hapus
        </button>
        <button class="btn btn-primary" onclick="saveBackground()">
          <i class="fas fa-save"></i> Simpan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Global Chat Modal -->
<div id="global-chat-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-globe"></i> Chat Global</h3>
      <button class="modal-close" onclick="closeGlobalChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="chat-messages" id="global-chat-messages"></div>
    </div>
    <div class="modal-footer">
      <div class="chat-input-area">
        <input type="text" id="global-chat-input" placeholder="Ketik pesan global..." onkeypress="handleGlobalChatKeyPress(event)">
        <div class="chat-actions">
          <button class="chat-action-btn" onclick="attachFile('global')">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="chat-action-btn" onclick="sendGlobalMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- File Input (hidden) -->
<input type="file" id="file-input" style="display:none;" accept="image/*" onchange="handleFileUpload(event)">

<script>
// ===== SUPABASE INITIALIZATION =====
const sb = supabase.createClient(
  'https://bxhrnnwfqlsoviysqcdw.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4aHJubndmcWxzb3ZpeXNxY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODkzNDIsImV4cCI6MjA4MTM2NTM0Mn0.O7fpv0TrDd-8ZE3Z9B5zWyAuWROPis5GRnKMxmqncX8'
);

// ===== TABLE NAMES =====
const TABLE_KLIKUSER = 'KLIKUSER';
const TABLE_KLIKCHAT = 'KLIKCHAT';
const TABLE_GLOBALCHAT = 'GLOBALCHAT';
const TABLE_GROUPS = 'KLIKGROUP-bahlil';
const TABLE_GROUP_MEMBERS = 'GROUPMEMBER-bahlil';
const TABLE_GROUP_CHAT = 'GROUPCHAT-bahlil';
const TABLE_CALLS = 'CALLS-bahlil';

// ===== GLOBAL VARIABLES =====
let currentUser = null;
let currentClick = 0;
let verificationCode = '';
let chatTarget = null;
let currentGroup = null;
let activeCall = null;
let callTimer = null;
let callStartTime = null;
let callType = null; // 'audio' or 'video'
let unreadChats = new Set();
let unreadGlobal = 0;
let unreadGroups = new Set();
let musicPlaying = false;

// WebRTC variables
let peerConnection = null;
let localStream = null;
let remoteStream = null;
let isMuted = false;
let isVideoOff = false;
let isSpeakerOn = true;

// Canvas variables
let canvasTool = 'pencil';
let canvasColor = '#ffffff';
let brushSize = 3;
let isDrawing = false;
let lastX = 0;
let lastY = 0;

// STUN servers for WebRTC
const iceServers = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun2.l.google.com:19302' },
    { urls: 'stun:stun3.l.google.com:19302' },
    { urls: 'stun:stun4.l.google.com:19302' }
  ]
};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  initCanvas();
  generateVerificationCode();
  loadPanelContent('auth');
  
  // Check saved user
  const savedUser = localStorage.getItem('klikUser');
  if(savedUser) {
    restoreSession(savedUser);
  }
  
  // Initialize audio
  initAudio();
  
  // Check for incoming calls
  checkIncomingCalls();
});

// ===== AUDIO FUNCTIONS =====
function initAudio() {
  const bgMusic = document.getElementById('bg-music');
  bgMusic.volume = 0.3;
  
  // Check music preference
  if(localStorage.getItem('musicEnabled') === 'true') {
    toggleMusic();
  }
}

function toggleMusic() {
  const bgMusic = document.getElementById('bg-music');
  const toggleBtn = document.getElementById('music-toggle');
  
  if(musicPlaying) {
    bgMusic.pause();
    toggleBtn.classList.remove('playing');
    toggleBtn.innerHTML = '<i class="fas fa-music"></i>';
    musicPlaying = false;
    localStorage.setItem('musicEnabled', 'false');
  } else {
    bgMusic.play().catch(e => console.log('Auto-play prevented:', e));
    toggleBtn.classList.add('playing');
    toggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
    musicPlaying = true;
    localStorage.setItem('musicEnabled', 'true');
  }
}

// ===== CLICK EFFECT =====
function createClickEffect() {
  const pulse = document.getElementById('pulse-effect');
  pulse.classList.remove('active');
  void pulse.offsetWidth; // Trigger reflow
  pulse.classList.add('active');
}

// Update photo click event
document.getElementById('photo').onclick = async function() {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }

  // Create visual effect
  createClickEffect();
  
  // Play click sound
  try {
    const audio = new Audio('suara.mp3');
    audio.playbackRate = 2.0;
    audio.volume = 0.3;
    audio.play();
  } catch(e) {}

  // Update count
  currentClick++;
  document.getElementById('count').textContent = currentClick;

  // Update database
  try {
    await sb.from(TABLE_KLIKUSER)
      .update({ jumlah_klik: currentClick })
      .eq('username', currentUser);
  } catch (error) {
    console.error('Error updating click count:', error);
  }
};

// ===== PANEL MANAGEMENT =====
function togglePanel() {
  const panel = document.getElementById('panel');
  panel.classList.toggle('show');
  
  if(panel.classList.contains('show')) {
    generateVerificationCode();
    loadBoard();
  }
}

function closePanel() {
  document.getElementById('panel').classList.remove('show');
}

function loadPanelContent(section) {
  const panelContent = document.getElementById('panel-content');
  
  switch(section) {
    case 'auth':
      panelContent.innerHTML = `
        <div class="form-section">
          <h3>Daftar Akun Baru</h3>
          <div class="input-group">
            <label>Username</label>
            <input type="text" id="reg_user" placeholder="Minimal 3 karakter">
          </div>
          <div class="input-group">
            <label>Password</label>
            <input type="password" id="reg_pass" placeholder="Minimal 6 karakter">
          </div>
          <div class="verification-box">
            <div class="verification-code" id="verif-code">${verificationCode}</div>
            <div class="copy-hint">Klik untuk menyalin kode</div>
          </div>
          <div class="input-group">
            <label>Kode Verifikasi</label>
            <input type="text" id="reg_verif" placeholder="Tempel kode di sini">
          </div>
          <button class="btn btn-primary" onclick="register()">
            <i class="fas fa-user-plus"></i> Daftar
          </button>
        </div>

        <div class="form-section">
          <h3>Login</h3>
          <div class="input-group">
            <label>Username</label>
            <input type="text" id="log_user" placeholder="Masukkan username">
          </div>
          <div class="input-group">
            <label>Password</label>
            <input type="password" id="log_pass" placeholder="Masukkan password">
          </div>
          <button class="btn" onclick="login()">
            <i class="fas fa-sign-in-alt"></i> Login
          </button>
        </div>

        <div class="leaderboard-section">
          <h3><i class="fas fa-trophy"></i> Leaderboard</h3>
          <button class="btn" onclick="loadBoard()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <div id="board-container"></div>
        </div>
      `;
      
      // Add copy functionality
      document.getElementById('verif-code').onclick = function() {
        navigator.clipboard.writeText(verificationCode).then(() => {
          const hint = this.nextElementSibling;
          hint.textContent = 'âœ“ Kode disalin!';
          setTimeout(() => {
            hint.textContent = 'Klik untuk menyalin kode';
          }, 2000);
        });
      };
      break;
      
    case 'loggedIn':
      panelContent.innerHTML = `
        <div class="user-info-card">
          <h3>Logged in as</h3>
          <div class="username">${currentUser}</div>
          <div class="click-count">${currentClick} Klik</div>
        </div>

        <div class="form-section">
          <button class="btn" onclick="openGlobalChat()">
            <i class="fas fa-globe"></i> Chat Global
          </button>
          <button class="btn" onclick="openGroupChat()">
            <i class="fas fa-users"></i> Grup Chat
          </button>
          <button class="btn btn-danger" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>

        <div class="leaderboard-section">
          <h3><i class="fas fa-trophy"></i> Leaderboard</h3>
          <button class="btn" onclick="loadBoard()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <div id="board-container"></div>
        </div>
      `;
      break;
  }
}

// ===== AUTHENTICATION =====
function generateVerificationCode() {
  verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
}

async function register() {
  const username = document.getElementById('reg_user').value.trim();
  const password = document.getElementById('reg_pass').value.trim();
  const verifCode = document.getElementById('reg_verif').value.trim();
  
  // Validation
  if(!username || !password || !verifCode) {
    showNotification('Harap isi semua kolom', 'error');
    return;
  }
  
  if(verifCode !== verificationCode) {
    showNotification('Kode verifikasi salah', 'error');
    generateVerificationCode();
    document.getElementById('verif-code').textContent = verificationCode;
    return;
  }
  
  if(username.length < 3) {
    showNotification('Username minimal 3 karakter', 'error');
    return;
  }
  
  if(password.length < 6) {
    showNotification('Password minimal 6 karakter', 'error');
    return;
  }

  try {
    // Check if username exists
    const {data: existing} = await sb.from(TABLE_KLIKUSER)
      .select('username')
      .eq('username', username)
      .single();
    
    if(existing) {
      showNotification('Username sudah digunakan', 'error');
      return;
    }
    
    // Create user
    const {error} = await sb.from(TABLE_KLIKUSER)
      .insert({
        username: username,
        password: password,
        jumlah_klik: 0,
        background_data: null,
        profile_image: null,
        last_seen: new Date().toISOString()
      });

    if(error) throw error;

    showNotification('Akun berhasil dibuat', 'success');
    currentUser = username;
    currentClick = 0;
    afterLogin();
  } catch (error) {
    console.error('Registration error:', error);
    showNotification('Error: ' + error.message, 'error');
  }
}

async function login() {
  const username = document.getElementById('log_user').value.trim();
  const password = document.getElementById('log_pass').value.trim();

  try {
    const {data, error} = await sb.from(TABLE_KLIKUSER)
      .select('*')
      .eq('username', username)
      .eq('password', password)
      .single();

    if(error || !data) {
      showNotification('Login gagal. Cek username/password', 'error');
      return;
    }

    currentUser = username;
    currentClick = data.jumlah_klik || 0;
    afterLogin();
  } catch (error) {
    console.error('Login error:', error);
    showNotification('Error saat login', 'error');
  }
}

async function restoreSession(username) {
  try {
    const {data} = await sb.from(TABLE_KLIKUSER)
      .select('jumlah_klik')
      .eq('username', username)
      .single();
    
    if(data) {
      currentUser = username;
      currentClick = data.jumlah_klik || 0;
      afterLogin();
    }
  } catch (error) {
    localStorage.removeItem('klikUser');
  }
}

function afterLogin() {
  document.getElementById('count').textContent = currentClick;
  loadPanelContent('loggedIn');
  loadBoard();
  loadUserBackground();
  checkUnreadMessages();
  startRealtime();
  updateOnlineStatus();
  
  // Save to localStorage
  localStorage.setItem('klikUser', currentUser);
  
  showNotification(`Selamat datang, ${currentUser}!`, 'success');
}

function logout() {
  currentUser = null;
  currentClick = 0;
  document.getElementById('count').textContent = 0;
  localStorage.removeItem('klikUser');
  loadPanelContent('auth');
  showNotification('Anda telah logout', 'info');
}

// ===== IMPROVED LEADERBOARD =====
async function loadBoard() {
  const container = document.getElementById('board-container');
  if (!container) return;
  
  container.innerHTML = '<div class="loading">Memuat leaderboard...</div>';
  
  try {
    const {data, error} = await sb.from(TABLE_KLIKUSER)
      .select('*')
      .order('jumlah_klik', { ascending:false })
      .limit(20);

    if(error) throw error;

    if(!data || data.length === 0) {
      container.innerHTML = '<p style="text-align:center;padding:40px;opacity:0.5;">Belum ada data</p>';
      return;
    }
    
    // Desktop version
    let desktopHTML = `
      <table class="leaderboard-desktop">
        <thead>
          <tr>
            <th class="rank-cell">RANK</th>
            <th>USERNAME</th>
            <th class="click-cell">KLIK</th>
            <th class="action-cell">AKSI</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    // Mobile version
    let mobileHTML = '<div class="leaderboard-mobile">';
    
    data.forEach((user, index) => {
      const rank = index + 1;
      const isMe = user.username === currentUser;
      const hasUnread = unreadChats.has(user.username);
      const isOnline = user.last_seen && (Date.now() - new Date(user.last_seen).getTime()) < 30000;
      
      // Desktop row
      desktopHTML += `
        <tr class="${isMe ? 'highlight-row' : ''} ${rank <= 3 ? `rank-${rank}` : ''}">
          <td class="rank-cell">
            <div class="rank-medal">${rank <= 3 ? 'ðŸ†' : rank}</div>
          </td>
          <td class="user-cell" onclick="${user.username !== currentUser ? `openChat('${user.username.replace(/'/g, "\\'")}')` : ''}">
            <div class="user-avatar">
              <img src="${user.profile_image || 'foto.webp'}" alt="${user.username}" onerror="this.src='foto.webp'">
            </div>
            <div>
              <div class="username">${user.username} ${isMe ? '(Anda)' : ''}</div>
              <div class="user-status">
                <span class="status-dot ${isOnline ? 'online' : ''}"></span>
                <span>${isOnline ? 'Online' : 'Offline'}</span>
              </div>
            </div>
            ${hasUnread ? '<div class="chat-indicator"></div>' : ''}
          </td>
          <td class="click-cell">${user.jumlah_klik || 0}</td>
          <td class="action-cell">
            ${isMe ? `
              <button class="chat-action-btn" onclick="openBgEditor()" style="border:none;background:transparent;color:#666;">
                <i class="fas fa-palette"></i>
              </button>
            ` : `
              <button class="chat-action-btn" onclick="openChat('${user.username.replace(/'/g, "\\'")}')" style="border:none;background:transparent;color:#666;">
                <i class="fas fa-comment"></i>
              </button>
            `}
          </td>
        </tr>
      `;
      
      // Mobile card
      mobileHTML += `
        <div class="leaderboard-card ${isMe ? 'highlight' : ''}" onclick="${user.username !== currentUser ? `openChat('${user.username.replace(/'/g, "\\'")}')` : 'openBgEditor()'}">
          <div class="rank-badge ${rank <= 3 ? `rank-${rank}` : ''}">
            ${rank <= 3 ? 'ðŸ†' : rank}
          </div>
          <div class="user-avatar-mobile">
            <img src="${user.profile_image || 'foto.webp'}" alt="${user.username}" onerror="this.src='foto.webp'">
          </div>
          <div class="user-info-mobile">
            <div class="username-mobile">${user.username} ${isMe ? '(Anda)' : ''}</div>
            <div class="user-stats-mobile">
              <span class="click-count-mobile">${user.jumlah_klik || 0} klik</span>
              <span class="status-mobile">
                <span class="status-dot-mobile ${isOnline ? 'online' : ''}"></span>
                <span>${isOnline ? 'Online' : 'Offline'}</span>
              </span>
            </div>
          </div>
          ${hasUnread ? '<div class="chat-indicator-mobile"></div>' : ''}
        </div>
      `;
    });
    
    desktopHTML += '</tbody></table>';
    mobileHTML += '</div>';
    
    container.innerHTML = desktopHTML + mobileHTML;
    
  } catch (error) {
    console.error('Error loading leaderboard:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat leaderboard</div>';
  }
}

// ===== CHAT FUNCTIONS =====
async function openChat(username) {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }
  
  if(username === currentUser) {
    openBgEditor();
    return;
  }
  
  chatTarget = username;
  document.getElementById('chat-title').textContent = username;
  document.getElementById('chat-modal').classList.add('show');
  document.getElementById('chat-input').focus();
  
  // Remove unread notification
  unreadChats.delete(username);
  loadBoard();
  
  await loadChatMessages();
}

function closeChat() {
  document.getElementById('chat-modal').classList.remove('show');
  chatTarget = null;
  document.getElementById('chat-input').value = '';
}

async function loadChatMessages() {
  const container = document.getElementById('chat-messages');
  container.innerHTML = '<div class="loading">Memuat pesan...</div>';
  
  try {
    const {data, error} = await sb.from(TABLE_KLIKCHAT)
      .select('*')
      .or(`and(sender.eq.${currentUser},receiver.eq.${chatTarget}),and(sender.eq.${chatTarget},receiver.eq.${currentUser})`)
      .order('created_at', { ascending:true })
      .limit(50);

    if(error) throw error;

    container.innerHTML = '';
    
    if(data && data.length > 0) {
      data.forEach(msg => {
        const time = new Date(msg.created_at).toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const isSent = msg.sender === currentUser;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : ''}`;
        messageDiv.innerHTML = `
          <div class="message-header">
            <span class="sender-name">${msg.sender}</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-content">
            ${msg.message.startsWith('data:image') ? 
              `<img src="${msg.message}" alt="Gambar" style="max-width:200px;">` : 
              msg.message}
          </div>
        `;
        
        container.appendChild(messageDiv);
      });
      
      container.scrollTop = container.scrollHeight;
    } else {
      container.innerHTML = '<p style="text-align:center;opacity:0.5;padding:40px;">Belum ada pesan</p>';
    }
  } catch (error) {
    console.error('Error loading messages:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat pesan</div>';
  }
}

async function sendChatMessage() {
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  
  if(!message || !chatTarget || !currentUser) return;
  
  try {
    const {error} = await sb.from(TABLE_KLIKCHAT)
      .insert({
        sender: currentUser,
        receiver: chatTarget,
        message: message
      });

    if(error) throw error;

    input.value = '';
    await loadChatMessages();
  } catch (error) {
    console.error('Error sending message:', error);
    showNotification('Gagal mengirim pesan', 'error');
  }
}

function handleChatKeyPress(e) {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChatMessage();
  }
}

// ===== CALL/VOICE/VIDEO CALL FUNCTIONS =====
async function startAudioCall() {
  if(!chatTarget || !currentUser) {
    showNotification('Pilih kontak terlebih dahulu', 'error');
    return;
  }
  
  callType = 'audio';
  await initiateCall('audio');
}

async function startVideoCall() {
  if(!chatTarget || !currentUser) {
    showNotification('Pilih kontak terlebih dahulu', 'error');
    return;
  }
  
  callType = 'video';
  await initiateCall('video');
}

async function initiateCall(type) {
  try {
    // Create call record
    const {data: callData, error} = await sb.from(TABLE_CALLS)
      .insert({
        caller: currentUser,
        receiver: chatTarget,
        type: type,
        status: 'calling',
        started_at: new Date().toISOString()
      })
      .select()
      .single();

    if(error) throw error;

    activeCall = callData;
    showCallModal('outgoing');
    
    // Request media permissions
    const constraints = {
      audio: true,
      video: type === 'video'
    };
    
    try {
      localStream = await navigator.mediaDevices.getUserMedia(constraints);
      
      if(type === 'video') {
        const localVideo = document.getElementById('local-video');
        localVideo.srcObject = localStream;
        document.getElementById('video-container').style.display = 'block';
        document.getElementById('call-info').style.display = 'none';
      }
      
      // Setup WebRTC
      await setupPeerConnection();
      
      // Start call timer
      callStartTime = Date.now();
      updateCallTimer();
      callTimer = setInterval(updateCallTimer, 1000);
      
      // Wait for callee to answer
      checkCallStatus();
      
    } catch (mediaError) {
      console.error('Media error:', mediaError);
      showNotification('Akses kamera/mikrofon ditolak', 'error');
      endCall();
    }
    
  } catch (error) {
    console.error('Error starting call:', error);
    showNotification('Gagal memulai panggilan', 'error');
  }
}

async function checkCallStatus() {
  if(!activeCall) return;
  
  const checkInterval = setInterval(async () => {
    const {data} = await sb.from(TABLE_CALLS)
      .select('*')
      .eq('id', activeCall.id)
      .single();
    
    if(data && data.status === 'connected') {
      clearInterval(checkInterval);
      document.getElementById('call-status').textContent = 'Terhubung';
      
      // Send offer to receiver via WebRTC
      await createAndSendOffer();
      
    } else if(data && data.status === 'ended') {
      clearInterval(checkInterval);
      showNotification('Panggilan ditolak', 'info');
      endCall();
    }
  }, 1000);
  
  // Timeout after 30 seconds
  setTimeout(() => {
    clearInterval(checkInterval);
    if(document.getElementById('call-modal').classList.contains('show')) {
      showNotification('Panggilan tidak dijawab', 'info');
      endCall();
    }
  }, 30000);
}

async function checkIncomingCalls() {
  if(!currentUser) return;
  
  // Listen for incoming calls
  sb.channel('calls-channel')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: TABLE_CALLS,
      filter: `receiver=eq.${currentUser}`
    }, async (payload) => {
      if(payload.new.status === 'calling') {
        const acceptCall = confirm(`${payload.new.caller} sedang ${payload.new.type === 'video' ? 'video call' : 'audio call'}. Terima?`);
        
        if(acceptCall) {
          activeCall = payload.new;
          callType = payload.new.type;
          
          // Update call status to connected
          await sb.from(TABLE_CALLS)
            .update({ status: 'connected' })
            .eq('id', activeCall.id);
          
          // Setup call
          await answerCall();
        } else {
          // Reject call
          await sb.from(TABLE_CALLS)
            .update({ status: 'ended', ended_at: new Date().toISOString() })
            .eq('id', payload.new.id);
        }
      }
    })
    .subscribe();
}

async function answerCall() {
  showCallModal('incoming');
  
  // Request media permissions
  const constraints = {
    audio: true,
    video: callType === 'video'
  };
  
  try {
    localStream = await navigator.mediaDevices.getUserMedia(constraints);
    
    if(callType === 'video') {
      const localVideo = document.getElementById('local-video');
      localVideo.srcObject = localStream;
      document.getElementById('video-container').style.display = 'block';
      document.getElementById('call-info').style.display = 'none';
    }
    
    // Setup WebRTC
    await setupPeerConnection();
    
    // Start call timer
    callStartTime = Date.now();
    updateCallTimer();
    callTimer = setInterval(updateCallTimer, 1000);
    
    // Wait for offer from caller
    await waitForOffer();
    
  } catch (mediaError) {
    console.error('Media error:', mediaError);
    showNotification('Akses kamera/mikrofon ditolak', 'error');
    endCall();
  }
}

async function setupPeerConnection() {
  try {
    peerConnection = new RTCPeerConnection(iceServers);
    
    // Add local stream
    if(localStream) {
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });
    }
    
    // Get remote stream
    peerConnection.ontrack = (event) => {
      remoteStream = event.streams[0];
      const remoteVideo = document.getElementById('remote-video');
      remoteVideo.srcObject = remoteStream;
    };
    
    // ICE candidate handling
    peerConnection.onicecandidate = (event) => {
      if(event.candidate) {
        // Send ICE candidate to other peer (simplified)
        console.log('ICE candidate:', event.candidate);
      }
    };
    
    // Connection state changes
    peerConnection.onconnectionstatechange = () => {
      console.log('Connection state:', peerConnection.connectionState);
      if(peerConnection.connectionState === 'disconnected' ||
         peerConnection.connectionState === 'failed' ||
         peerConnection.connectionState === 'closed') {
        endCall();
      }
    };
    
  } catch (error) {
    console.error('Error setting up peer connection:', error);
  }
}

async function createAndSendOffer() {
  try {
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    
    // In a real app, send offer to signaling server
    // For simplicity, we'll just log it
    console.log('Offer created:', offer);
    
  } catch (error) {
    console.error('Error creating offer:', error);
  }
}

async function waitForOffer() {
  // In a real app, receive offer from signaling server
  // For demo, we'll create answer when called
  setTimeout(async () => {
    try {
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      console.log('Answer created:', answer);
    } catch (error) {
      console.error('Error creating answer:', error);
    }
  }, 1000);
}

function showCallModal(type) {
  const modal = document.getElementById('call-modal');
  const name = document.getElementById('call-name');
  const status = document.getElementById('call-status');
  const avatar = document.getElementById('call-avatar');
  
  if(type === 'outgoing') {
    name.textContent = chatTarget;
    status.textContent = 'Menghubungkan...';
  } else {
    name.textContent = activeCall.caller;
    status.textContent = 'Panggilan masuk...';
  }
  
  // Set avatar
  avatar.innerHTML = `<img src="foto.webp" alt="${type === 'outgoing' ? chatTarget : activeCall.caller}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"><rect width=\"100%\" height=\"100%\" fill=\"%23111\"/><text x=\"50%\" y=\"50%\" font-family=\"Arial\" font-size=\"20\" fill=\"white\" text-anchor=\"middle\" dy=\".3em\">${type === 'outgoing' ? chatTarget.charAt(0) : activeCall.caller.charAt(0)}</text></svg>'">`;
  
  modal.classList.add('show');
}

function updateCallTimer() {
  if(!callStartTime) return;
  
  const elapsed = Date.now() - callStartTime;
  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);
  
  document.getElementById('call-timer').textContent = 
    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function toggleMute() {
  if(!localStream) return;
  
  const audioTracks = localStream.getAudioTracks();
  if(audioTracks.length > 0) {
    isMuted = !isMuted;
    audioTracks[0].enabled = !isMuted;
    
    const muteBtn = document.getElementById('mute-btn');
    muteBtn.classList.toggle('active', isMuted);
    muteBtn.innerHTML = isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
    
    showNotification(isMuted ? 'Mikrofon dimatikan' : 'Mikrofon diaktifkan', 'info');
  }
}

function toggleVideo() {
  if(!localStream || callType !== 'video') return;
  
  const videoTracks = localStream.getVideoTracks();
  if(videoTracks.length > 0) {
    isVideoOff = !isVideoOff;
    videoTracks[0].enabled = !isVideoOff;
    
    const videoBtn = document.getElementById('toggle-video-btn');
    videoBtn.classList.toggle('active', isVideoOff);
    videoBtn.innerHTML = isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
    
    showNotification(isVideoOff ? 'Kamera dimatikan' : 'Kamera diaktifkan', 'info');
  }
}

function toggleAudio() {
  // This toggles local audio (different from toggleMute which toggles microphone)
  if(!remoteStream) return;
  
  const audioElements = document.getElementsByTagName('audio');
  for(let audio of audioElements) {
    audio.muted = !audio.muted;
  }
  
  const remoteVideo = document.getElementById('remote-video');
  remoteVideo.muted = !remoteVideo.muted;
  
  isSpeakerOn = !isSpeakerOn;
  const speakerBtn = document.getElementById('speaker-btn');
  speakerBtn.classList.toggle('active', !isSpeakerOn);
  speakerBtn.innerHTML = isSpeakerOn ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
  
  showNotification(isSpeakerOn ? 'Speaker diaktifkan' : 'Speaker dimatikan', 'info');
}

function toggleSpeaker() {
  // Alias for toggleAudio
  toggleAudio();
}

async function endCall() {
  if(activeCall) {
    try {
      const endedAt = new Date().toISOString();
      const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
      
      await sb.from(TABLE_CALLS)
        .update({ 
          status: 'ended', 
          ended_at: endedAt,
          duration: duration
        })
        .eq('id', activeCall.id);
      
      showNotification(`Panggilan berakhir (${Math.floor(duration/60)}:${(duration%60).toString().padStart(2, '0')})`, 'info');
      
    } catch (error) {
      console.error('Error updating call status:', error);
    }
  }
  
  // Close peer connection
  if(peerConnection) {
    peerConnection.close();
    peerConnection = null;
  }
  
  // Stop media streams
  if(localStream) {
    localStream.getTracks().forEach(track => track.stop());
    localStream = null;
  }
  
  if(remoteStream) {
    remoteStream.getTracks().forEach(track => track.stop());
    remoteStream = null;
  }
  
  // Clear timer
  clearInterval(callTimer);
  
  // Hide modal
  document.getElementById('call-modal').classList.remove('show');
  document.getElementById('video-container').style.display = 'none';
  document.getElementById('call-info').style.display = 'block';
  
  // Reset variables
  activeCall = null;
  callStartTime = null;
  callType = null;
  isMuted = false;
  isVideoOff = false;
  isSpeakerOn = true;
}

// ===== GROUP FUNCTIONS =====
function openGroupChat() {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }
  
  document.getElementById('group-chat-modal').classList.add('show');
  loadGroups();
}

function closeGroupChat() {
  document.getElementById('group-chat-modal').classList.remove('show');
}

async function loadGroups() {
  const container = document.getElementById('group-list');
  container.innerHTML = '<div class="loading">Memuat grup...</div>';
  
  try {
    // Get groups where user is a member
    const {data: memberships, error: memError} = await sb.from(TABLE_GROUP_MEMBERS)
      .select('group_id')
      .eq('user_id', currentUser);
    
    if(memError) throw memError;
    
    if(!memberships || memberships.length === 0) {
      container.innerHTML = '<p style="text-align:center;opacity:0.5;padding:20px;">Belum ada grup</p>';
      return;
    }
    
    const groupIds = memberships.map(m => m.group_id);
    
    const {data: groups, error: groupError} = await sb.from(TABLE_GROUPS)
      .select('*')
      .in('id', groupIds)
      .order('created_at', {ascending: false});
    
    if(groupError) throw groupError;
    
    container.innerHTML = '';
    
    if(groups && groups.length > 0) {
      groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'group-item';
        item.onclick = () => openGroup(group.id);
        
        item.innerHTML = `
          <div class="group-avatar">
            <img src="${group.photo_url || 'logo.jpg'}" alt="${group.name}" onerror="this.src='logo.jpg'">
          </div>
          <div class="group-info">
            <div class="group-name">${group.name}</div>
            <div class="group-meta">${group.member_count || 1} anggota</div>
          </div>
          ${unreadGroups.has(group.id) ? '<div class="group-badge">Baru</div>' : ''}
        `;
        
        container.appendChild(item);
      });
    }
  } catch (error) {
    console.error('Error loading groups:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat grup</div>';
  }
}

function showCreateGroup() {
  document.getElementById('create-group-modal').classList.add('show');
}

function closeCreateGroup() {
  document.getElementById('create-group-modal').classList.remove('show');
}

function previewGroupPhoto(event) {
  const file = event.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('group-photo-img').src = e.target.result;
    document.getElementById('group-photo-preview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

async function createGroup() {
  const name = document.getElementById('group-name').value.trim();
  const desc = document.getElementById('group-desc').value.trim();
  
  if(!name) {
    showNotification('Nama grup diperlukan', 'error');
    return;
  }
  
  try {
    // Upload photo if exists
    let photoUrl = null;
    const photoInput = document.getElementById('group-photo');
    if(photoInput.files[0]) {
      const file = photoInput.files[0];
      const fileName = `group_${Date.now()}_${file.name}`;
      
      const {data, error} = await sb.storage
        .from('group-photos')
        .upload(fileName, file);
      
      if(!error) {
        const {data: urlData} = sb.storage
          .from('group-photos')
          .getPublicUrl(fileName);
        photoUrl = urlData.publicUrl;
      }
    }
    
    // Create group
    const {data: group, error: groupError} = await sb.from(TABLE_GROUPS)
      .insert({
        name: name,
        description: desc,
        photo_url: photoUrl,
        created_by: currentUser,
        member_count: 1
      })
      .select()
      .single();
    
    if(groupError) throw groupError;
    
    // Add creator as admin member
    const {error: memberError} = await sb.from(TABLE_GROUP_MEMBERS)
      .insert({
        group_id: group.id,
        user_id: currentUser,
        role: 'admin',
        joined_at: new Date().toISOString()
      });
    
    if(memberError) throw memberError;
    
    showNotification('Grup berhasil dibuat', 'success');
    closeCreateGroup();
    loadGroups();
    
  } catch (error) {
    console.error('Error creating group:', error);
    showNotification('Gagal membuat grup', 'error');
  }
}

async function openGroup(groupId) {
  // Implement group chat opening
  showNotification('Fitur grup chat dalam pengembangan', 'info');
}

// ===== BACKGROUND EDITOR =====
function initCanvas() {
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');
  
  // Set initial background
  ctx.fillStyle = '#000000';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Add event listeners
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);
}

function openBgEditor() {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }
  document.getElementById('bg-editor-modal').classList.add('show');
}

function closeBgEditor() {
  document.getElementById('bg-editor-modal').classList.remove('show');
}

function setTool(tool) {
  canvasTool = tool;
  
  document.querySelectorAll('.editor-tool').forEach(btn => {
    btn.classList.remove('active');
  });
  
  event.target.classList.add('active');
}

function setColor(color) {
  canvasColor = color;
  document.getElementById('bg-preview').style.color = color;
}

function setBrushSize(size) {
  brushSize = parseInt(size);
  document.getElementById('brush-size-label').textContent = size + 'px';
}

function startDrawing(e) {
  isDrawing = true;
  const canvas = document.getElementById('bg-canvas');
  const rect = canvas.getBoundingClientRect();
  lastX = e.clientX - rect.left;
  lastY = e.clientY - rect.top;
}

function draw(e) {
  if(!isDrawing) return;
  
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  
  if(canvasTool === 'pencil') {
    ctx.strokeStyle = canvasColor;
    ctx.lineWidth = brushSize;
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
  } else if(canvasTool === 'eraser') {
    ctx.strokeStyle = '#000000';
    ctx.lineWidth = brushSize * 2;
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
  }
  
  lastX = x;
  lastY = y;
  
  // Update preview
  updatePreview();
}

function stopDrawing() {
  isDrawing = false;
}

// Bucket tool
document.querySelector('[onclick="setTool(\'bucket\')"]').addEventListener('click', function(e) {
  setTool('bucket');
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = canvasColor;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  updatePreview();
});

function clearCanvas() {
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#000000';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  updatePreview();
}

function updatePreview() {
  const canvas = document.getElementById('bg-canvas');
  const preview = document.getElementById('bg-preview');
  const dataUrl = canvas.toDataURL();
  preview.style.background = `url('${dataUrl}')`;
  preview.style.backgroundSize = 'cover';
}

async function saveBackground() {
  if(!currentUser) return;
  
  try {
    const canvas = document.getElementById('bg-canvas');
    const imageData = canvas.toDataURL('image/png');
    
    const {error} = await sb.from(TABLE_KLIKUSER)
      .update({ background_data: imageData })
      .eq('username', currentUser);
    
    if(error) throw error;
    
    showNotification('Background berhasil disimpan', 'success');
    closeBgEditor();
    loadBoard();
    
  } catch (error) {
    console.error('Error saving background:', error);
    showNotification('Gagal menyimpan background', 'error');
  }
}

async function loadUserBackground() {
  if(!currentUser) return;
  
  try {
    const {data, error} = await sb.from(TABLE_KLIKUSER)
      .select('background_data')
      .eq('username', currentUser)
      .single();
    
    if(error || !data || !data.background_data) return;
    
    const img = new Image();
    img.onload = function() {
      const canvas = document.getElementById('bg-canvas');
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      updatePreview();
    };
    img.src = data.background_data;
    
  } catch (error) {
    console.error('Error loading background:', error);
  }
}

// ===== GLOBAL CHAT =====
function openGlobalChat() {
  if(!currentUser) {
    showNotification('Login terlebih dahulu', 'error');
    return;
  }
  
  document.getElementById('global-chat-modal').classList.add('show');
  document.getElementById('global-chat-input').focus();
  
  // Reset notification
  unreadGlobal = 0;
  updateGlobalNotification();
  
  loadGlobalMessages();
}

function closeGlobalChat() {
  document.getElementById('global-chat-modal').classList.remove('show');
}

async function loadGlobalMessages() {
  const container = document.getElementById('global-chat-messages');
  container.innerHTML = '<div class="loading">Memuat chat global...</div>';
  
  try {
    const {data, error} = await sb.from(TABLE_GLOBALCHAT)
      .select('*')
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    container.innerHTML = '';
    
    if(data && data.length > 0) {
      data.reverse().forEach(msg => {
        const time = new Date(msg.created_at).toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const isSent = msg.sender === currentUser;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : ''}`;
        messageDiv.innerHTML = `
          <div class="message-header">
            <span class="sender-name">${msg.sender}</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-content">
            ${msg.message.startsWith('data:image') ? 
              `<img src="${msg.message}" alt="Gambar" style="max-width:200px;">` : 
              msg.message}
          </div>
        `;
        
        container.appendChild(messageDiv);
      });
      
      container.scrollTop = container.scrollHeight;
    } else {
      container.innerHTML = '<p style="text-align:center;opacity:0.5;padding:40px;">Belum ada pesan global</p>';
    }
  } catch (error) {
    console.error('Error loading global messages:', error);
    container.innerHTML = '<div class="error-message">Gagal memuat chat global</div>';
  }
}

async function sendGlobalMessage() {
  const input = document.getElementById('global-chat-input');
  const message = input.value.trim();
  
  if(!message || !currentUser) return;
  
  try {
    const {error} = await sb.from(TABLE_GLOBALCHAT)
      .insert({
        sender: currentUser,
        message: message
      });

    if(error) throw error;

    input.value = '';
    loadGlobalMessages();
  } catch (error) {
    console.error('Error sending global message:', error);
    showNotification('Gagal mengirim pesan', 'error');
  }
}

function handleGlobalChatKeyPress(e) {
  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendGlobalMessage();
  }
}

// ===== FILE UPLOAD =====
function attachFile(type) {
  const input = document.getElementById('file-input');
  input.setAttribute('data-type', type);
  input.click();
}

async function handleFileUpload(event) {
  const file = event.target.files[0];
  const type = event.target.getAttribute('data-type');
  
  if(!file || !file.type.startsWith('image/')) {
    showNotification('Hanya file gambar yang diizinkan', 'error');
    return;
  }
  
  if(file.size > 5 * 1024 * 1024) {
    showNotification('Ukuran file maksimal 5MB', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    const imageData = e.target.result;
    
    try {
      if(type === 'chat' && chatTarget) {
        await sb.from(TABLE_KLIKCHAT)
          .insert({
            sender: currentUser,
            receiver: chatTarget,
            message: imageData
          });
        loadChatMessages();
      } else if(type === 'global') {
        await sb.from(TABLE_GLOBALCHAT)
          .insert({
            sender: currentUser,
            message: imageData
          });
        loadGlobalMessages();
      }
    } catch (error) {
      console.error('Error sending image:', error);
      showNotification('Gagal mengirim gambar', 'error');
    }
  };
  
  reader.readAsDataURL(file);
  event.target.value = '';
}

// ===== NOTIFICATION SYSTEM =====
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div class="notification-content">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      <span>${message}</span>
    </div>
  `;
  
  // Add to body
  document.body.appendChild(notification);
  
  // Show with animation
  setTimeout(() => {
    notification.classList.add('show');
  }, 10);
  
  // Remove after delay
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if(notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Add notification styles
const notificationStyles = document.createElement('style');
notificationStyles.textContent = `
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(20, 20, 20, 0.95);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 15px 20px;
  color: #fff;
  font-size: 14px;
  z-index: 10000;
  transform: translateX(150%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
  min-width: 300px;
  max-width: 400px;
}

.notification.show {
  transform: translateX(0);
}

.notification-content {
  display: flex;
  align-items: center;
  gap: 12px;
}

.notification i {
  font-size: 18px;
}

.notification.success i {
  color: #4CAF50;
}

.notification.error i {
  color: #f44336;
}

.notification.info i {
  color: #2196F3;
}
`;
document.head.appendChild(notificationStyles);

// ===== REALTIME UPDATES =====
async function checkUnreadMessages() {
  if(!currentUser) return;
  
  try {
    // Check private chats
    const {data: chatData} = await sb.from(TABLE_KLIKCHAT)
      .select('sender')
      .eq('receiver', currentUser)
      .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());
    
    if(chatData) {
      chatData.forEach(msg => {
        if(msg.sender !== chatTarget) {
          unreadChats.add(msg.sender);
        }
      });
      loadBoard();
    }
    
    // Check global chat
    const {data: globalData} = await sb.from(TABLE_GLOBALCHAT)
      .select('id')
      .order('created_at', {ascending: false})
      .limit(1)
      .single();
    
    if(globalData) {
      const lastSeen = localStorage.getItem('lastSeenGlobal');
      if(!lastSeen || globalData.id > parseInt(lastSeen)) {
        unreadGlobal++;
        updateGlobalNotification();
      }
    }
    
  } catch (error) {
    console.error('Error checking unread messages:', error);
  }
}

function updateGlobalNotification() {
  const badge = document.getElementById('global-notification');
  if(unreadGlobal > 0) {
    badge.style.display = 'flex';
    badge.textContent = unreadGlobal > 9 ? '9+' : unreadGlobal;
  } else {
    badge.style.display = 'none';
  }
}

async function updateOnlineStatus() {
  if(!currentUser) return;
  
  try {
    await sb.from(TABLE_KLIKUSER)
      .update({ last_seen: new Date().toISOString() })
      .eq('username', currentUser);
  } catch (error) {
    console.error('Error updating online status:', error);
  }
}

function startRealtime() {
  if(!currentUser) return;
  
  // Update online status every 30 seconds
  setInterval(updateOnlineStatus, 30000);
  
  // Subscribe to private chats
  const chatChannel = sb.channel('private-chat')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: TABLE_KLIKCHAT,
        filter: `receiver=eq.${currentUser}`
      },
      (payload) => {
        const sender = payload.new.sender;
        if(chatTarget !== sender) {
          unreadChats.add(sender);
          loadBoard();
          
          // Show notification
          if(Notification.permission === 'granted') {
            new Notification(`Pesan baru dari ${sender}`, {
              body: payload.new.message.length > 100 ? 
                payload.new.message.substring(0, 100) + '...' : 
                payload.new.message,
              icon: 'logo.jpg'
            });
          }
        }
      }
    )
    .subscribe();
  
  // Subscribe to global chat
  const globalChannel = sb.channel('global-chat')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: TABLE_GLOBALCHAT
      },
      (payload) => {
        if(!document.getElementById('global-chat-modal').classList.contains('show')) {
          unreadGlobal++;
          updateGlobalNotification();
        } else {
          loadGlobalMessages();
        }
      }
    )
    .subscribe();
  
  // Request notification permission
  if('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

// ===== UTILITY FUNCTIONS =====
function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Initialize online status on page visibility change
document.addEventListener('visibilitychange', function() {
  if(!document.hidden && currentUser) {
    updateOnlineStatus();
  }
});

// Handle window resize for responsive leaderboard
window.addEventListener('resize', function() {
  // Leaderboard will auto-adjust with CSS media queries
});
</script>

</body>
</html>
