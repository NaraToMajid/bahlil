<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Klik Counter</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}body{background:#000;height:100vh;font-family:Arial,sans-serif}.counter{position:absolute;top:50%;left:50%;transform:translate(-50%,-250%);font-size:5rem;color:#fff;font-family:'Arial Black',sans-serif;z-index:2;text-shadow:0 0 15px #fff;font-weight:900}.circle{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:200px;height:200px;border-radius:50%;cursor:pointer;border:3px solid #fff;overflow:hidden;z-index:1;transition:transform .05s}.circle:active{transform:translate(-50%,-50%)scale(.95)}.btn{position:fixed;top:20px;right:20px;width:50px;height:50px;background:#000;color:#fff;border:2px solid #fff;border-radius:50%;cursor:pointer;z-index:100;display:flex;align-items:center;justify-content:center;font-size:1.2rem}.panel{position:fixed;top:0;right:-400px;width:380px;height:100vh;background:#000;border-left:2px solid #444;transition:.3s;z-index:99;display:flex;flex-direction:column}.panel.open{right:0}.header{padding:20px;border-bottom:2px solid #444;display:flex;justify-content:space-between;align-items:center}.header h2{color:#fff;font-size:1.4rem}.close{background:none;border:none;color:#fff;cursor:pointer;font-size:1.5rem}.auth{padding:20px;border-bottom:2px solid #444}.form{display:none;flex-direction:column;gap:15px}.form.active{display:flex}.btns{display:flex;gap:10px}.auth-btn{flex:1;padding:10px;background:#333;color:#fff;border:1px solid #666;cursor:pointer;border-radius:4px}.input{display:flex;flex-direction:column;gap:8px}.input label{color:#ccc;font-size:.9rem}.input input{padding:10px;background:#111;border:1px solid #444;color:#fff;border-radius:4px}.submit{padding:10px;background:#444;color:#fff;border:none;cursor:pointer;border-radius:4px}.content{flex:1;overflow-y:auto;padding:15px}.item{display:flex;align-items:center;padding:12px;background:#111;border:1px solid #333;margin-bottom:8px;border-radius:6px}.item.current{border-color:#fff;background:#222}.rank{width:40px;color:#fff;font-weight:bold;font-size:1.2rem}.info{flex:1;margin-left:15px}.name{color:#fff;font-size:1rem}.score{color:#fff;font-weight:bold;font-size:1.1rem}.error{color:#ff4444;font-size:.8rem;display:none}.error.show{display:block}
</style>
</head>
<body>
<div class="counter" id="counter">0</div>
<div class="circle" id="circle"></div>
<button class="btn" id="toggle"><i class="fas fa-trophy"></i></button>
<div class="panel" id="panel">
<div class="header"><h2><i class="fas fa-crown"></i> LEADERBOARD</h2><button class="close" id="close"><i class="fas fa-times"></i></button></div>
<div class="auth">
<div class="btns"><button class="auth-btn" id="showLogin"><i class="fas fa-sign-in-alt"></i> Login</button><button class="auth-btn" id="showRegister"><i class="fas fa-user-plus"></i> Register</button></div>
<div class="form" id="loginForm"><div class="input"><label><i class="fas fa-user"></i> Username</label><input type="text" id="user"></div><div class="input"><label><i class="fas fa-lock"></i> Password</label><input type="password" id="pass"></div><div class="error" id="loginErr"></div><button class="submit" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login</button></div>
<div class="form" id="registerForm"><div class="input"><label><i class="fas fa-user"></i> Username</label><input type="text" id="regUser"></div><div class="input"><label><i class="fas fa-lock"></i> Password</label><input type="password" id="regPass"></div><div class="error" id="regErr"></div><button class="submit" id="regBtn"><i class="fas fa-user-plus"></i> Register</button></div>
</div>
<div class="content" id="content"><div class="item"><div class="rank">1</div><div class="info"><div class="name">Loading...</div></div><div class="score">0</div></div></div>
</div>

<script>
// Variabel
let clicks = 0;
let currentUser = null;
let audio = new Audio('suara.mp3');
audio.volume = 0.5;

// Supabase config
const SUPABASE_URL = 'https://bxhrnnwfqlsoviysqcdw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4aHJubndmcWxzb3ZpeXNxY2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3ODkzNDIsImV4cCI6MjA4MTM2NTM0Mn0.O7fpv0TrDd-8ZE3Z9B5zWyAuWROPis5GRnKMxmqncX8';

// Load foto
const circle = document.getElementById('circle');
const img = new Image();
img.src = 'foto.webp';
img.onload = () => {
    circle.innerHTML = '';
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    circle.appendChild(img);
};
img.onerror = () => {
    circle.innerHTML = '<div style="width:100%;height:100%;background:#333;display:flex;align-items:center;justify-content:center;color:#fff;font-size:3rem;"><i class="fas fa-mouse-pointer"></i></div>';
};

// Fungsi fetch ke Supabase
async function supabaseFetch(table, method = 'GET', data = null) {
    const url = `${SUPABASE_URL}/rest/v1/${table}`;
    const headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
    };
    
    if (method === 'GET') {
        const res = await fetch(url + '?select=*', { headers });
        return await res.json();
    }
    
    if (method === 'POST') {
        const res = await fetch(url, {
            method: 'POST',
            headers,
            body: JSON.stringify(data)
        });
        return await res.json();
    }
    
    if (method === 'PATCH') {
        const res = await fetch(url + '?id=eq.' + data.id, {
            method: 'PATCH',
            headers,
            body: JSON.stringify(data.update)
        });
        return await res.json();
    }
}

// Handle klik
document.getElementById('circle').addEventListener('click', async () => {
    clicks++;
    document.getElementById('counter').textContent = clicks;
    
    // Suara cepat
    const sound = audio.cloneNode();
    sound.playbackRate = 2.0;
    sound.play();
    
    // Update database jika login
    if (currentUser) {
        try {
            await fetch(`${SUPABASE_URL}/rest/v1/user_klik?id=eq.${currentUser.id}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ click_count: clicks })
            });
            loadLeaderboard();
        } catch(e) {}
    }
});

// Load leaderboard
async function loadLeaderboard() {
    try {
        const data = await supabaseFetch('user_klik');
        const list = document.getElementById('content');
        list.innerHTML = '';
        
        data.sort((a,b) => b.click_count - a.click_count);
        
        data.forEach((user, i) => {
            const div = document.createElement('div');
            div.className = 'item' + (currentUser && user.username === currentUser.username ? ' current' : '');
            div.innerHTML = `
                <div class="rank">${i+1}</div>
                <div class="info"><div class="name">${user.username}</div></div>
                <div class="score">${user.click_count || 0}</div>
            `;
            list.appendChild(div);
        });
    } catch(e) {
        document.getElementById('content').innerHTML = '<div class="item"><div class="info"><div class="name">Error load data</div></div></div>';
    }
}

// Login
document.getElementById('loginBtn').addEventListener('click', async () => {
    const user = document.getElementById('user').value.trim();
    const pass = document.getElementById('pass').value.trim();
    
    if (!user || !pass) {
        document.getElementById('loginErr').textContent = 'Isi username dan password';
        document.getElementById('loginErr').classList.add('show');
        return;
    }
    
    try {
        const data = await supabaseFetch('user_klik');
        const found = data.find(u => u.username === user && u.password === pass);
        
        if (found) {
            currentUser = found;
            clicks = found.click_count || 0;
            document.getElementById('counter').textContent = clicks;
            document.getElementById('auth').innerHTML = `<div style="color:#fff;padding:15px;text-align:center">Login sebagai: <b>${user}</b><br>Klik: ${clicks}</div>`;
            loadLeaderboard();
        } else {
            document.getElementById('loginErr').textContent = 'Username/password salah';
            document.getElementById('loginErr').classList.add('show');
        }
    } catch(e) {
        document.getElementById('loginErr').textContent = 'Database error';
        document.getElementById('loginErr').classList.add('show');
    }
});

// Register
document.getElementById('regBtn').addEventListener('click', async () => {
    const user = document.getElementById('regUser').value.trim();
    const pass = document.getElementById('regPass').value.trim();
    
    if (!user || !pass) {
        document.getElementById('regErr').textContent = 'Isi username dan password';
        document.getElementById('regErr').classList.add('show');
        return;
    }
    
    if (pass.length < 4) {
        document.getElementById('regErr').textContent = 'Password minimal 4 karakter';
        document.getElementById('regErr').classList.add('show');
        return;
    }
    
    try {
        const data = await supabaseFetch('user_klik');
        const exists = data.find(u => u.username === user);
        
        if (exists) {
            document.getElementById('regErr').textContent = 'Username sudah ada';
            document.getElementById('regErr').classList.add('show');
            return;
        }
        
        const newUser = await supabaseFetch('user_klik', 'POST', {
            username: user,
            password: pass,
            click_count: 0
        });
        
        if (newUser && newUser[0]) {
            currentUser = newUser[0];
            clicks = 0;
            document.getElementById('counter').textContent = 0;
            document.getElementById('auth').innerHTML = `<div style="color:#fff;padding:15px;text-align:center">Register berhasil!<br>Login sebagai: <b>${user}</b></div>`;
            loadLeaderboard();
        }
    } catch(e) {
        document.getElementById('regErr').textContent = 'Gagal register';
        document.getElementById('regErr').classList.add('show');
    }
});

// Toggle panel
document.getElementById('toggle').addEventListener('click', () => {
    document.getElementById('panel').classList.toggle('open');
    loadLeaderboard();
});
document.getElementById('close').addEventListener('click', () => {
    document.getElementById('panel').classList.remove('open');
});

// Show login/register form
document.getElementById('showLogin').addEventListener('click', () => {
    document.getElementById('loginForm').classList.add('active');
    document.getElementById('registerForm').classList.remove('active');
    document.getElementById('showLogin').style.display = 'none';
    document.getElementById('showRegister').style.display = 'none';
});
document.getElementById('showRegister').addEventListener('click', () => {
    document.getElementById('registerForm').classList.add('active');
    document.getElementById('loginForm').classList.remove('active');
    document.getElementById('showLogin').style.display = 'none';
    document.getElementById('showRegister').style.display = 'none';
});

// Load awal
loadLeaderboard();
</script>
</body>
</html>
